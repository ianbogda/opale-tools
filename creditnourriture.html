<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SRH – Crédit nourriture (V2)</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --app-bg:#f7f8fb;
      --app-card:#ffffff;
    }
    body{ background:var(--app-bg); }
    .app-header{
      background: linear-gradient(180deg, #ffffff 0%, #f6f7fb 100%);
      border-bottom: 1px solid rgba(0,0,0,.08);
    }
    .card{
      background: var(--app-card);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 14px;
    }
    .card .card-header{
      background: rgba(0,0,0,.02);
      border-bottom: 1px solid rgba(0,0,0,.06);
      border-top-left-radius: 14px;
      border-top-right-radius: 14px;
      font-weight: 600;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .table thead th{
      background: rgba(0,0,0,.03);
      border-bottom: 1px solid rgba(0,0,0,.08);
      white-space: nowrap;
    }
    .badge-soft{
      background: rgba(13,110,253,.10);
      color: rgba(13,110,253,1);
      border: 1px solid rgba(13,110,253,.20);
    }
    .sticky-actions{
      position: sticky;
      bottom: 0;
      z-index: 10;
      background: rgba(247,248,251,.92);
      backdrop-filter: blur(6px);
      border-top: 1px solid rgba(0,0,0,.08);
    }
    .form-text{ color: rgba(0,0,0,.6); }
    .kpi{
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 12px;
      background: rgba(0,0,0,.02);
      padding: .75rem;
      height: 100%;
    }

    .table.table-sm tbody#breaksTableBody tr {
      vertical-align: middle;
    }

    /* Cellules: padding un peu plus généreux et homogène */
    .table.table-sm tbody#breaksTableBody td {
      padding: .45rem .5rem;
    }

    /* Inputs date: largeur stable, hauteur cohérente */
    .table.table-sm tbody#breaksTableBody input[type="date"] {
      width: 100%;
      min-width: 4.5rem;      /* évite l'effet "trop serré" */
      height: 2.35rem;         /* même hauteur que boutons */
      padding: .35rem .6rem;
      line-height: 1.2;
      border-radius: .6rem;
    }

    /* Colonne actions : largeur fixe + alignement vertical */
    .table.table-sm tbody#breaksTableBody td.text-end {
      width: 5.25rem;          /* ajuste selon ton UI */
      white-space: nowrap;
      padding-right: .35rem;   /* rapproche du bord */
    }

    /* Groupe d'actions : empilement vertical propre */
    .break-actions {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: .35rem;
    }

    /* Boutons actions : carrés, même taille, centrés */
    .table.table-sm tbody#breaksTableBody .break-actions .btn {
      width: 2.35rem;
      height: 2.35rem;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: .65rem;
    }

    /* Icônes un peu mieux centrées/visibles */
    .table.table-sm tbody#breaksTableBody .break-actions .btn i {
      font-size: 1.05rem;
      line-height: 1;
    }

    /* Un léger “respire” sur mobile */
    @media (max-width: 576px) {
      .table.table-sm tbody#breaksTableBody input[type="date"] {
        min-width: 10.5rem;
      }
      .table.table-sm tbody#breaksTableBody td.text-end {
        width: 4.75rem;
      }
    }
  </style>
</head>

<body>
  <div class="app-header">
    <div class="container py-4">
      <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-3">
        <div>
          <div class="d-flex align-items-center gap-2">
            <span class="badge badge-soft rounded-pill"><i class="bi bi-clipboard-data me-1"></i> SRH – Pilotage</span>
          </div>
          <h1 class="h3 mb-1 mt-2">Crédit nourriture – Réel vs Prévisionnel</h1>
          <div class="text-muted">
            Outil souple : import <span class="mono">CLCA</span> + restitution budgétaire SRH, règles de classement, tableau & graphique,
            alerte dynamique et recommandation TR.
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-outline-primary" id="btnExport">
            <i class="bi bi-download me-1"></i> Télécharger le suivi (JSON)
          </button>
          <label class="btn btn-outline-secondary mb-0">
            <i class="bi bi-upload me-1"></i> Charger un suivi
            <input type="file" id="fileImportState" accept=".json" hidden>
          </label>
          <button class="btn btn-primary" id="btnRecalc">
            <i class="bi bi-calculator me-1"></i> Recalculer
          </button>
        </div>
      </div>
    </div>
  </div>

  <main class="container my-4">

    <!-- Alerts -->
    <div id="alertBox"></div>

    <!-- KPI Row -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-lg-3">
        <div class="kpi">
          <div class="small text-muted">Recettes réalisées</div>
          <div class="h4 mb-0" id="kpiRecReal">—</div>
        </div>
      </div>
      <div class="col-12 col-lg-3">
        <div class="kpi">
          <div class="small text-muted">Dépenses réalisées</div>
          <div class="h4 mb-0" id="kpiDepReal">—</div>
        </div>
      </div>
      <div class="col-12 col-lg-3">
        <div class="kpi">
          <div class="small text-muted">Crédit nourriture à date</div>
          <div class="h4 mb-0" id="kpiCNReal">—</div>
        </div>
      </div>
      <div class="col-12 col-lg-3">
        <div class="kpi">
          <div class="small text-muted">Crédit nourriture fin de période</div>
          <div class="h4 mb-0" id="kpiCNPrev">—</div>
          <div class="form-text" id="kpiTRHint">—</div>
        </div>
      </div>
    </div>

    <!-- Top accordion (escamotable) -->
    <div class="accordion mb-3" id="accTop">
      <div class="accordion-item">
        <h2 class="accordion-header" id="hTop">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#cTop" aria-expanded="true">
            <i class="bi bi-sliders me-2"></i> Paramètres, périodes, imports OP@LE et règles (escamotable)
          </button>
        </h2>
        <div id="cTop" class="accordion-collapse collapse show" data-bs-parent="#accTop">
          <div class="accordion-body">
            <div class="row g-3">

              <!-- Période -->
              <div class="col-12 col-lg-4">
                <div class="card h-100">
                  <div class="card-header"><i class="bi bi-calendar3 me-2"></i>Période</div>
                  <div class="card-body">
                    <div class="mt-3">
                      <div class="d-flex align-items-center justify-content-between gap-2">
                        <div class="d-flex align-items-center justify-content-between gap-2">
                          <label class="form-label mb-0">Vacances / interruptions</label>
                        </div>
                        <div class="btn-group btn-group-sm" role="group" aria-label="Vacances">
                          <button type="button" class="btn btn-outline-primary" id="btnAddBreak">
                            <i class="bi bi-plus-circle me-1"></i>Ajouter
                          </button>
                          <button type="button" class="btn btn-outline-secondary" id="btnImportBreaks">
                            <i class="bi bi-cloud-download me-1"></i>Importer
                          </button>
                        </div>
                      </div>
                      <div class="table-responsive mt-2">
                        <table class="table table-sm align-middle mb-1">
                          <thead>
                            <tr>
                              <th style="width:20%">Début</th>
                              <th style="width:20%">Fin</th>
                              <th style="width:12%"></th>
                            </tr>
                          </thead>
                          <tbody id="breaksTableBody"></tbody>
                        </table>
                      </div>
                      <div class="form-text">Les jours en vacances sont exclus des courbes et filtres période.</div>
                      <!-- (optionnel) si tu veux encore importer/exporter en texte : garde un champ caché -->
                      <textarea class="form-control d-none" id="periodBreaks"></textarea>

                      <!-- Options import API (affiché au clic) -->
                      <div class="border rounded-3 p-2 mt-2 d-none" id="breakImportBox">
                        <div class="row g-2 align-items-end">
                          <div class="col-12 col-lg-4">
                            <label class="form-label small text-muted mb-1">Zone</label>
                            <select class="form-select form-select-sm" id="breakZone">
                              <option value="A">Zone A</option>
                              <option value="B">Zone B</option>
                              <option value="C">Zone C</option>
                            </select>
                          </div>
                          <div class="col-12 col-lg-5">
                            <label class="form-label small text-muted mb-1">Année scolaire</label>
                            <select class="form-select form-select-sm" id="breakSchoolYear"></select>
                          </div>
                          <div class="col-12 col-lg-3 d-grid">
                            <button type="button" class="btn btn-sm btn-primary" id="btnDoImportBreaks">
                              <i class="bi bi-magic me-1"></i>Pré-remplir
                            </button>
                          </div>
                        </div>

                        <hr class="my-2">
                        <div class="row g-2 align-items-end">
                          <div class="col-12 col-lg-6 d-grid">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnDownloadIcs">
                              <i class="bi bi-download me-1"></i>Télécharger .ics (Zone sélectionnée)
                            </button>
                          </div>
                          <div class="col-12 col-lg-6">
                            <label class="form-label small text-muted mb-1">Importer un fichier .ics téléchargé</label>
                            <input type="file" class="form-control form-control-sm" id="icsFile" accept=".ics,text/calendar">
                          </div>
                        </div>

                        <div class="form-text mt-2">
                          Si l’import API est bloqué (CORS / file://), télécharge le .ics puis importe-le ici.
                        </div>
                      </div>
                    </div>

                    <!-- Modal: ajout manuel d'une période -->
                    <div class="modal fade" id="breakModal" tabindex="-1" aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i>Ajouter une interruption</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                          </div>
                          <div class="modal-body">
                            <div class="mb-2">
                              <label class="form-label">Libellé</label>
                              <input type="text" class="form-control" id="breakLabel" placeholder="Ex. Toussaint / Noël / Fermeture exceptionnelle">
                            </div>
                            <div class="row g-2">
                              <div class="col-6">
                                <label class="form-label">Début</label>
                                <input type="date" class="form-control" id="breakStart">
                              </div>
                              <div class="col-6">
                                <label class="form-label">Fin</label>
                                <input type="date" class="form-control" id="breakEnd">
                              </div>
                            </div>
                            <div class="form-text mt-2">
                              Une ligne sera ajoutée au format : <span class="mono">Libellé : YYYY-MM-DD → YYYY-MM-DD</span>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                            <button type="button" class="btn btn-primary" id="btnSaveBreak">
                              <i class="bi bi-check2 me-1"></i>Ajouter
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <hr class="my-3">
                    <label class="form-label">Sensibilité alerte</label>
                    <div class="row g-2">
                      <div class="col-6">
                        <label class="form-label small text-muted mb-1">Seuil base (% dépenses prév.)</label>
                        <input type="number" class="form-control" id="baseThresholdPct" step="0.1" value="5.0">
                      </div>
                      <div class="col-6">
                        <label class="form-label small text-muted mb-1">Facteur Sep–Déc</label>
                        <input type="number" class="form-control" id="sepDecFactor" step="0.1" value="1.5">
                      </div>
                    </div>
                    <div class="form-text">
                      Alerte = mix valeur (X% des dépenses prévisionnelles) + sensibilité renforcée Sep–Déc.
                    </div>
                  </div>
                </div>
              </div>

              <!-- Imports -->
              <div class="col-12 col-lg-8">
                <div class="card h-100">
                  <div class="card-header"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Imports OP@LE (CLCA + Budget SRH)</div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-12 col-lg-6">
                        <label class="form-label">Import CLCA (XLSX)</label>
                        <input type="file" class="form-control" id="clcaFile" accept=".xlsx,.xls,.csv">
                        <div class="form-text">Utilisé surtout pour les dépenses (engagé / consommé) + libellés/fournisseurs.</div>
                      </div>

                      <!-- SRH via collage + preview -->
                      <div class="col-12">
                        <div class="border rounded-3 p-3 bg-light">
                          <div class="fw-semibold mb-2"><i class="bi bi-clipboard-plus me-2"></i>SRH (coller un tableau)</div>
                          <textarea class="form-control mono" id="srhPaste" rows="8"
                            placeholder="Copiez/collez ici la restitution SRH depuis Op@le (lignes SRH + comptes 6/7)."></textarea>
                          <div class="d-flex flex-wrap gap-2 mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnPreviewSrhPaste">
                              <i class="bi bi-eye me-1"></i>Prévisualiser
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="btnImportSrhPaste">
                              <i class="bi bi-cloud-arrow-down me-1"></i>Importer
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnClearSrhPaste">
                              <i class="bi bi-eraser me-1"></i>Vider
                            </button>
                          </div>
                          <div class="form-text mt-2">
                            Flux recommandé : <b>Prévisualiser</b> → vérifier → <b>Importer</b>.
                          </div>
                        </div>
                      </div>

                      <!-- Modal: SRH Preview -->
                      <div class="modal fade" id="srhPreviewModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-xl modal-dialog-scrollable">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title"><i class="bi bi-table me-2"></i>Prévisualisation SRH</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                            </div>
                            <div class="modal-body">
                              <div class="row g-2 mb-2">
                                <div class="col-12 col-lg-4">
                                  <div class="small text-muted">Lignes détectées</div>
                                  <div class="h5 mb-0" id="srhPrevCount">—</div>
                                </div>
                                <div class="col-12 col-lg-4">
                                  <div class="small text-muted">Total réalisé</div>
                                  <div class="h5 mb-0" id="srhPrevTotReal">—</div>
                                </div>
                                <div class="col-12 col-lg-4">
                                  <div class="small text-muted">Total prévision</div>
                                  <div class="h5 mb-0" id="srhPrevTotPrev">—</div>
                                </div>
                              </div>

                              <div class="table-responsive">
                                <table class="table table-sm table-bordered align-middle mb-0">
                                  <thead>
                                    <tr>
                                      <th>#</th>
                                      <th>Compte</th>
                                      <th>Type</th>
                                      <th>Libellé</th>
                                      <th class="text-end">Réalisé</th>
                                      <th class="text-end">Prévision</th>
                                    </tr>
                                  </thead>
                                  <tbody id="srhPreviewBody">
                                    <tr><td colspan="6" class="text-muted">Aucune donnée.</td></tr>
                                  </tbody>
                                </table>
                              </div>
                              <div class="form-text mt-2" id="srhPrevHint">
                                Aperçu limité aux 200 premières lignes (si plus).
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                              <button type="button" class="btn btn-primary" id="btnConfirmImportSrh">
                                <i class="bi bi-check2-circle me-1"></i>Importer ces lignes
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-12">
                        <div class="alert alert-light border mb-0">
                          <div class="fw-semibold mb-1"><i class="bi bi-wrench-adjustable me-1"></i>Mapping des colonnes)</div>
                          <div class="small text-muted">
                            Après import, choisissez les colonnes utiles. L’outil retient vos choix dans le fichier de suivi.
                          </div>
                        </div>
                      </div>

                      <div class="col-12 col-lg-6">
                        <div class="border rounded-3 p-3 bg-light">
                          <div class="fw-semibold mb-2">Mapping CLCA</div>
                          <div class="row g-2">
                            <div class="col-6">
                              <label class="form-label">Date</label>
                              <select class="form-select" id="mapClcaDate"></select>
                            </div>
                            <div class="col-6">
                              <label class="form-label">Montant</label>
                              <select class="form-select" id="mapClcaAmount"></select>
                            </div>
                            <div class="col-6">
                              <label class="form-label">Libellé / Objet</label>
                              <select class="form-select" id="mapClcaLabel"></select>
                            </div>
                            <div class="col-6">
                              <label class="form-label">Statut (engagé/payé)</label>
                              <select class="form-select" id="mapClcaStatus"></select>
                            </div>
                            <div class="col-12">
                              <label class="form-label">Fournisseur/Tiers (option)</label>
                              <select class="form-select" id="mapClcaVendor"></select>
                            </div>
                          </div>
                          <div class="form-text mt-2">
                            Si “statut” est vide : l’outil classe en “réalisé” par défaut.
                          </div>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
              </div>

              <!-- Règles -->
              <div class="col-12">
                <div class="card">
                  <div class="card-header"><i class="bi bi-funnel me-2"></i>Règles de classement (plastiques)</div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-12 col-lg-6">
                        <label class="form-label">Règles RECETTES (mots-clés)</label>
                        <textarea class="form-control" id="rulesRevenue" rows="3"
                          placeholder="tickets, interne, commensaux, extérieur, location, hébergement, réception, annexe"></textarea>
                        <div class="form-text">Séparez par virgule / point-virgule / retour ligne.</div>
                      </div>
                      <div class="col-12 col-lg-6">
                        <label class="form-label">Règles DÉPENSES obligatoires & VIAB (mots-clés)</label>
                        <textarea class="form-control" id="rulesSpend" rows="3"
                          placeholder="eau, gaz, électricité, chauffage urbain, contrôle sanitaire, maintenance, révision, vérification, sécurité"></textarea>
                        <div class="form-text">L’outil tentera VIAB via mots-clés eau/gaz/électricité/chauffage urbain.</div>
                      </div>
                      <div class="col-12">
                        <div class="d-flex flex-wrap gap-2">
                          <button class="btn btn-outline-secondary" id="btnClearImports">
                            <i class="bi bi-eraser me-1"></i> Effacer imports
                          </button>
                          <button class="btn btn-outline-primary" id="btnSaveLocal">
                            <i class="bi bi-floppy me-1"></i> Enregistrer en local (navigateur)
                          </button>
                          <button class="btn btn-outline-secondary" id="btnLoadLocal">
                            <i class="bi bi-arrow-clockwise me-1"></i> Recharger depuis local
                          </button>
                        </div>
                        <div class="form-text mt-2">
                          “Local” = stockage navigateur (pratique au quotidien). “Télécharger le suivi” = fichier portable (JSON).
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div><!-- row -->
          </div>
        </div>
      </div>
    </div>

    <!-- Tables: Rubriques -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-header"><i class="bi bi-cash-coin me-2"></i>Recettes (réalisé / prévision)</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm table-bordered align-middle mb-0" id="tblRecettes">
                <thead>
                  <tr>
                    <th>Rubrique</th>
                    <th class="text-end">Réalisé</th>
                    <th class="text-end">Prévision</th>
                    <th>Note</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr class="table-light fw-semibold">
                    <td>Total recettes</td>
                    <td class="text-end" id="totRecReal">—</td>
                    <td class="text-end" id="totRecPrev">—</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <div class="form-text mt-2">Vous pouvez saisir manuellement une ligne : double-cliquez une cellule Réalisé/Prévision.</div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-header"><i class="bi bi-receipt-cutoff me-2"></i>Dépenses (VIAB + obligatoires + option denrées)</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm table-bordered align-middle mb-0" id="tblDepenses">
                <thead>
                  <tr>
                    <th>Rubrique</th>
                    <th class="text-end">Réalisé</th>
                    <th class="text-end">Prévision</th>
                    <th>Note</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr class="table-light fw-semibold">
                    <td>Total dépenses</td>
                    <td class="text-end" id="totDepReal">—</td>
                    <td class="text-end" id="totDepPrev">—</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <div class="form-text mt-2">
              VIAB détaillée : eau, gaz, électricité, chauffage urbain (auto via mots-clés, ajustable).
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- NEW: Constantes B4.1.1 (vote budget) -->
    <div class="card mb-3">
      <div class="card-header"><i class="bi bi-journal-text me-2"></i>Constantes B4.1.1 (préparation vote budget)</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12 col-lg-3">
            <label class="form-label">Nb jours</label>
            <input type="number" class="form-control" id="b411NbJours" min="0" step="1">
            <div class="form-text">Utilisé pour les calculs unitaires (si activés ensuite).</div>
          </div>
          <div class="col-12 col-lg-3">
            <label class="form-label">% Fonctionnement</label>
            <input type="number" class="form-control" id="b411PctFonct" min="0" max="100" step="0.1">
            <div class="form-text">Ex: 25 = 25% des recettes affectées.</div>
          </div>
          <div class="col-12 col-lg-3">
            <label class="form-label">% Reversement CT</label>
            <input type="number" class="form-control" id="b411PctRevers" min="0" max="100" step="0.1">
            <div class="form-text">Ex: 25 = 25% des recettes affectées.</div>
          </div>
          <div class="col-12 col-lg-3 d-grid">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-outline-primary" id="btnB411Recalc">
              <i class="bi bi-calculator me-1"></i>Recalculer B4.1.1
            </button>
          </div>

          <div class="col-12">
            <div class="alert alert-light border mb-0">
              <div class="fw-semibold mb-1"><i class="bi bi-info-circle me-1"></i>Principe</div>
              <div class="small text-muted">
                L’import SRH (collage) alimente automatiquement :
                <span class="mono">1) vos tableaux simplifiés</span> (pilotage) et <span class="mono">2) une structure B4.1.1</span> (vote).
              </div>
            </div>
          </div>

          <!-- mini synthèse B4.1.1 -->
          <div class="col-12 col-lg-4">
            <div class="kpi">
              <div class="small text-muted">B4.1.1 – Total recettes (prévision)</div>
              <div class="h4 mb-0" id="b411KpiRecPrev">—</div>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="kpi">
              <div class="small text-muted">B4.1.1 – Reversement CT (prévision)</div>
              <div class="h4 mb-0" id="b411KpiReversPrev">—</div>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="kpi">
              <div class="small text-muted">B4.1.1 – Fonctionnement (prévision)</div>
              <div class="h4 mb-0" id="b411KpiFonctPrev">—</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- NEW: B4.1.1 - lignes générées (validation avant export) -->
    <div class="card mb-3">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div><i class="bi bi-table me-2"></i>B4.1.1 – lignes générées</div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-secondary" id="btnB411Refresh">
            <i class="bi bi-arrow-clockwise me-1"></i>Rafraîchir
          </button>
          <button class="btn btn-sm btn-outline-secondary" id="btnB411ExportJson">
            <i class="bi bi-braces me-1"></i>Exporter JSON
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-lg-3">
            <label class="form-label">Domaine</label>
            <select class="form-select" id="b411FilterDomain">
              <option value="">Tous</option>
            </select>
          </div>
          <div class="col-12 col-lg-3">
            <label class="form-label">Activité</label>
            <select class="form-select" id="b411FilterActivity">
              <option value="">Toutes</option>
            </select>
          </div>
          <div class="col-12 col-lg-4">
            <label class="form-label">Recherche</label>
            <input class="form-control" id="b411Search" placeholder="Compte, libellé…">
          </div>
          <div class="col-12 col-lg-2 d-grid">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-outline-primary" id="btnB411ClearFilters">
              <i class="bi bi-x-circle me-1"></i>Réinitialiser
            </button>
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-12 col-lg-4">
            <div class="small text-muted">Lignes affichées</div>
            <div class="h5 mb-0" id="b411LinesCount">—</div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="small text-muted">Total Réalisé (filtre)</div>
            <div class="h5 mb-0" id="b411LinesTotReal">—</div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="small text-muted">Total Prévision (filtre)</div>
            <div class="h5 mb-0" id="b411LinesTotPrev">—</div>
          </div>
        </div>

        <div class="table-responsive mt-3">
          <table class="table table-sm table-bordered align-middle mb-0">
            <thead>
              <tr>
                <th style="width: 90px;">Domaine</th>
                <th style="width: 110px;">Activité</th>
                <th style="width: 110px;">Type</th>
                <th style="width: 90px;">Compte</th>
                <th>Libellé</th>
                <th class="text-end" style="width: 140px;">Réalisé</th>
                <th class="text-end" style="width: 140px;">Prévision</th>
              </tr>
            </thead>
            <tbody id="b411LinesBody">
              <tr><td colspan="6" class="text-muted">Aucune donnée B4.1.1. Importez un collage SRH.</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Contrôle sous-totaux "." / "-" -->
        <div class="mt-3">
          <div class="d-flex align-items-center justify-content-between">
            <div class="fw-semibold"><i class="bi bi-shield-check me-2"></i>Contrôle : Somme des comptes vs sous-totaux ( . / - )</div>
            <button class="btn btn-sm btn-outline-secondary" id="btnB411Check">
              <i class="bi bi-search me-1"></i>Lancer contrôle
            </button>
          </div>
          <div class="form-text">
            Compare, par Domaine/Activité, la somme des lignes comptes (6/7) avec les lignes sous-totales importées (compte = <span class="mono">.</span> ou <span class="mono">-</span>).
          </div>
          <div class="table-responsive mt-2">
            <table class="table table-sm table-bordered align-middle mb-0">
              <thead>
                <tr>
                  <th style="width: 90px;">Domaine</th>
                  <th style="width: 110px;">Activité</th>
                  <th style="width: 110px;">Type</th>
                  <th class="text-end" style="width: 140px;">Somme comptes</th>
                  <th class="text-end" style="width: 140px;">Sous-total (./-)</th>
                  <th class="text-end" style="width: 140px;">Écart</th>
                  <th>Note</th>
                </tr>
              </thead>
              <tbody id="b411CheckBody">
                <tr><td colspan="7" class="text-muted">Aucun contrôle effectué.</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="form-text mt-2">
          Cette liste correspond à <span class="mono">state.b411.lines</span> (agrégée par Domaine / Activité / Compte).
        </div>
      </div>
    </div>

    <!-- Graph -->
    <div class="card mb-3">
      <div class="card-header"><i class="bi bi-graph-up me-2"></i>Graphique – Réel vs Prévisionnel</div>
      <div class="card-body">
        <canvas id="chartCN" height="90"></canvas>
        <div class="form-text mt-2">
          Courbe = crédit nourriture cumulé sur la période (jours hors vacances). Barres = projection fin de période.
        </div>
      </div>
    </div>

    <!-- Transactions -->
    <div class="card mb-4">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div><i class="bi bi-list-check me-2"></i>Lignes importées (CLCA + Budget) – aperçu & correction</div>
        <span class="badge text-bg-light border" id="txCount">0 ligne</span>
      </div>
      <div class="card-body">
        <div class="row g-2 mb-2">
          <div class="col-12 col-lg-4">
            <input class="form-control" id="txSearch" placeholder="Filtrer (libellé / fournisseur / rubrique)…">
          </div>
          <div class="col-12 col-lg-3">
            <select class="form-select" id="txFilterType">
              <option value="">Tous types</option>
              <option value="RECETTE">Recettes</option>
              <option value="DEPENSE">Dépenses</option>
            </select>
          </div>
          <div class="col-12 col-lg-3">
            <select class="form-select" id="txFilterScope">
              <option value="PERIOD" selected>Dans la période</option>
              <option value="ALL">Tout (sans filtre dates)</option>
            </select>
          </div>
          <div class="col-12 col-lg-2 d-grid">
            <button class="btn btn-outline-secondary" id="btnReclass">
              <i class="bi bi-magic me-1"></i> Reclasser
            </button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>#</th>
                <th>Date</th>
                <th>Type</th>
                <th>Rubrique</th>
                <th>Libellé</th>
                <th>Fournisseur</th>
                <th class="text-end">Montant</th>
                <th>Statut</th>
                <th>Source</th>
              </tr>
            </thead>
            <tbody id="txBody">
              <tr><td colspan="9" class="text-muted">Aucune donnée importée.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="form-text mt-2">
          Correction rapide : cliquez sur “Rubrique” d’une ligne pour la modifier.
        </div>
      </div>
    </div>

    <div class="sticky-actions py-3">
      <div class="container d-flex flex-wrap gap-2 justify-content-end">
        <button class="btn btn-outline-secondary" id="btnReset">
          <i class="bi bi-trash3 me-1"></i> Réinitialiser
        </button>
        <button class="btn btn-outline-primary" id="btnExportCsv">
          <i class="bi bi-filetype-csv me-1"></i> Export CSV (lignes)
        </button>
        <button class="btn btn-primary" id="btnRecalc2">
          <i class="bi bi-check2-circle me-1"></i> Calculer
        </button>
      </div>
    </div>

    <footer class="py-4">
      <div class="text-center small text-muted">
        <small id="app-version"></small>
      </div>
    </footer>
  </main>
<script>
/**
 * SRH Op@le - Crédit nourriture
 * Basé sur exports Op@le : CLCA, resitution
 *
 * @version 0.0.2
 * @author Yann Bogdanovic
 * @description
 *  - Outil OP@LE pour calcul et suivi du crédit nourriture
 * @changelog
 * v0.0.2
 *   - mécanisme d'import et d'ajour des dates d'interruptions (vacances, jours fériés…)
 */
const APP_VERSION = "SRH OP@LE - 0.0.2";
window.addEventListener("DOMContentLoaded", () => {
    const el = document.getElementById("app-version");
    if (el) el.textContent = APP_VERSION;
});
const FR = {
  parseMoney(v){
    if (v == null) return 0;
    if (typeof v === "number") return isFinite(v) ? v : 0;
    let s = String(v).trim();
    if (!s) return 0;
    s = s.replace(/\u00A0|\u202F/g, " ").replace(/[€]/g, "").trim();
    const sign = s.startsWith("-") ? -1 : 1;
    s = s.replace(/^[-+]/, "").trim().replace(/ /g, "").replace(",", ".");
    const n = Number(s);
    return isFinite(n) ? sign * n : 0;
  },
  fmtMoney(n){
    const v = Number(n);
    if (!isFinite(v)) return "—";
    return v.toLocaleString("fr-FR", { style:"currency", currency:"EUR" });
  },
  fmtDate(d){
    if (!d) return "";
    try { return d.toLocaleDateString("fr-FR"); } catch { return ""; }
  }
};

function $(id){ return document.getElementById(id); }

function todayISO(){
  const d = new Date();
  const pad = (x)=>String(x).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

function parseISODate(v){
  if (!v) return null;
  if (v instanceof Date && !isNaN(v)) return v;
  if (typeof v === "number"){
    // Excel serial (fallback)
    const epoch = new Date(Date.UTC(1899, 11, 30));
    const d = new Date(epoch.getTime() + v*86400000);
    return isNaN(d) ? null : d;
  }
  const s = String(v).trim();
  if (!s) return null;
  // try native
  const d1 = new Date(s);
  if (!isNaN(d1)) return d1;
  // dd/mm/yyyy
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (m){
    const d2 = new Date(Number(m[3]), Number(m[2])-1, Number(m[1]));
    return isNaN(d2) ? null : d2;
  }
  return null;
}

function parseBreaks(text){
  const out = [];
  if (!text) return out;
  const lines = String(text).split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  for (const line of lines){
    const m = line.match(/(\d{4}-\d{2}-\d{2}).*(→|->|—|–|-).*(\d{4}-\d{2}-\d{2})/);
    if (m){
      const a = parseISODate(m[1]);
      const b = parseISODate(m[3]);
      if (a && b){
        out.push({ start: a < b ? a : b, end: a < b ? b : a, label: line });
      }
    }
  }
  return out;
}

/* ==============================
  Vacances / interruptions - UI helpers
  - Ajout manuel via modale
  - Import via API calendrier scolaire
============================== */
function appendBreakRow(label, startISO, endISO){
  const body = $("breaksTableBody");
  if (!body) return;
  body.appendChild(newBreakRow({ label, start: startISO, end: endISO }));
  syncBreaksLegacyText();
  refreshBreakTooltips();
}

function isoFromDateInput(id){
  const v = $(id)?.value;
  if (!v) return null;
  // input[type=date] est déjà YYYY-MM-DD
  return v;
}

function schoolYearOptionsAround(year){
  // Génère 5 années scolaires autour de "year" : (year-2)-(year-1) ... (year+2)-(year+3)
  const out = [];
  const y = Number(year);
  if (!isFinite(y)) return out;
  for (let k=-2; k<=2; k++){
    const a = y + k;
    out.push(`${a}-${a+1}`);
  }
  return out;
}

function inferSchoolYear(){
  // Basé sur periodStart si possible, sinon année courante
  const ps = $("periodStart")?.value;
  const y = ps ? Number(String(ps).slice(0,4)) : (new Date()).getFullYear();
  // Année scolaire: si mois >= 9 => y-(y+1), sinon (y-1)-y
  const m = ps ? Number(String(ps).slice(5,7)) : (new Date()).getMonth()+1;
  const a = (m >= 9) ? y : (y-1);
  return `${a}-${a+1}`;
}

async function fetchSchoolHolidays({ zone, schoolYear }){
  // 1) Tentative JSON (API Opendatasoft) : pratique mais peut échouer en CORS (notamment depuis file://)
  // 2) Fallback iCal (.ics) par zone : très robuste côté navigateur

  // --- helper: dedup + sort
  const normalize = (arr)=>{
    const seen = new Set();
    const dedup = [];
    for (const x of (arr||[])){
      if (!x?.start || !x?.end) continue;
      const label = String(x.label || "Vacances").trim();
      const start = String(x.start).slice(0,10);
      const end = String(x.end).slice(0,10);
      const key = `${label}|${start}|${end}`;
      if (seen.has(key)) continue;
      seen.add(key);
      dedup.push({ label, start, end });
    }
    dedup.sort((a,b)=> (a.start < b.start ? -1 : a.start > b.start ? 1 : 0));
    return dedup;
  };

  // --- JSON try
  try{
    const base = "https://data.education.gouv.fr/api/explore/v2.1/catalog/datasets/fr-en-calendrier-scolaire/records";
    // Opendatasoft v2.1 : préférer quotes simples + starts_with
    const where = [
      `annee_scolaire='${schoolYear}'`,
      `zone='${zone}'`,
      `starts_with(description, 'Vacances')`
    ].join(" and ");
    const url = `${base}?where=${encodeURIComponent(where)}&limit=100&order_by=start_date`;
    const res = await fetch(url, { headers: { "accept":"application/json" } });
    if (!res.ok) {
      const t = await res.text().catch(()=> "");
      throw new Error(`JSON HTTP ${res.status} ${t.slice(0,200)}`);
    }
    const data = await res.json();
    const results = Array.isArray(data?.results) ? data.results : [];
    const mapped = results.map(r=>({
      label: r.description,
      start: String(r.start_date||"").slice(0,10),
      end: String(r.end_date||"").slice(0,10)
    }));
    const out = normalize(mapped);
    if (out.length) return out;
  }catch(_e){
    // ignore et fallback iCal
  }

  // --- iCal fallback (par zone)
  // Sources listent les flux: Zone-A.ics, Zone-B.ics, Zone-C.ics, etc.
  const icsUrl = ({
    "A": "https://fr.ftp.opendatasoft.com/openscol/fr-en-calendrier-scolaire/Zone-A.ics",
    "B": "https://fr.ftp.opendatasoft.com/openscol/fr-en-calendrier-scolaire/Zone-B.ics",
    "C": "https://fr.ftp.opendatasoft.com/openscol/fr-en-calendrier-scolaire/Zone-C.ics",
  })[String(zone||"A").toUpperCase()] || "https://fr.ftp.opendatasoft.com/openscol/fr-en-calendrier-scolaire/Zone-A.ics";

  const res2 = await fetch(icsUrl, { headers: { "accept":"text/calendar,text/plain,*/*" } });
  if (!res2.ok) throw new Error(`iCal HTTP ${res2.status}`);
  const icsText = await res2.text();
  const parsed = parseIcsHolidays(icsText);

  // Filtrer par année scolaire demandée : "YYYY-YYYY"
  const [sy0, sy1] = String(schoolYear).split("-").map(Number);
  const startSY = `${sy0}-09-01`;
  const endSY = `${sy1}-09-01`; // borne haute exclue
  const filtered = parsed.filter(p => (p.start >= startSY && p.start < endSY) || (p.end > startSY && p.end <= endSY));
  const out2 = normalize(filtered.filter(p => String(p.label||"").startsWith("Vacances")));
  if (!out2.length) throw new Error("Aucune vacance trouvée (iCal).");
  return out2;
}

function parseIcsHolidays(icsText){
  // Parser iCal minimal (VEVENT / SUMMARY / DTSTART / DTEND)
  // Note: en iCal, DTEND est souvent exclusif (lendemain). Ici on garde tel quel, car ton parseBreaks
  // exclut sur [start, end] au sens "dateTime", et on travaille au jour (YYYY-MM-DD).
  const lines = String(icsText||"")
    .replace(/\r\n/g,"\n")
    .replace(/\n[ \t]/g,"") // unfold (RFC5545)
    .split("\n");

  const out = [];
  let cur = null;
  for (const raw of lines){
    const line = raw.trim();
    if (line === "BEGIN:VEVENT"){ cur = {}; continue; }
    if (line === "END:VEVENT"){
      if (cur?.label && cur?.start && cur?.end) out.push(cur);
      cur = null;
      continue;
    }
    if (!cur) continue;

    // SUMMARY:Vacances de Noël
    if (line.startsWith("SUMMARY:")){
      cur.label = line.slice("SUMMARY:".length).trim();
      continue;
    }
    // DTSTART;VALUE=DATE:20251220  ou DTSTART:20251220T000000Z
    if (line.startsWith("DTSTART")){
      const v = line.split(":").slice(1).join(":").trim();
      cur.start = icsDateToISO(v);
      continue;
    }
    // DTEND;VALUE=DATE:20260105 (souvent exclusif)
    if (line.startsWith("DTEND")){
      const v = line.split(":").slice(1).join(":").trim();
      cur.end = icsDateToISO(v);
      continue;
    }
  }
  return out;
}

function icsDateToISO(v){
  // v: YYYYMMDD ou YYYYMMDDTHHMMSSZ -> YYYY-MM-DD
  const m = String(v||"").match(/^(\d{4})(\d{2})(\d{2})/);
  if (!m) return "";
  return `${m[1]}-${m[2]}-${m[3]}`;
}

function getIcsDownloadUrlForZone(zone){
  // URL publique (souvent téléchargeable même si CORS bloque fetch). On l’ouvre en navigation.
  // NB: on ne fait PAS fetch ici, on ouvre le lien.
  const z = String(zone||"A").toUpperCase();
  const map = {
    "A": "https://fr.ftp.opendatasoft.com/openscol/fr-en-calendrier-scolaire/Zone-A.ics",
    "B": "https://fr.ftp.opendatasoft.com/openscol/fr-en-calendrier-scolaire/Zone-B.ics",
    "C": "https://fr.ftp.opendatasoft.com/openscol/fr-en-calendrier-scolaire/Zone-C.ics",
  };
  return map[z] || map["A"];
}

function filterVacancesAndSchoolYear(periods, schoolYear){
  // schoolYear: "YYYY-YYYY"
  const [sy0, sy1] = String(schoolYear||"").split("-").map(Number);
  if (!isFinite(sy0) || !isFinite(sy1)) return periods || [];
  const startSY = `${sy0}-09-01`;
  const endSY = `${sy1}-09-01`; // borne haute (exclue)
  return (periods||[])
    .filter(p => String(p.label||"").startsWith("Vacances"))
    .filter(p => (p.start >= startSY && p.start < endSY) || (p.end > startSY && p.end <= endSY));
}

async function importIcsFile(file, { zone, schoolYear }){
  const text = await new Promise((resolve, reject)=>{
    const fr = new FileReader();
    fr.onerror = reject;
    fr.onload = ()=> resolve(String(fr.result || ""));
    fr.readAsText(file, "utf-8");
  });
  const periods = filterVacancesAndSchoolYear(parseIcsHolidays(text), schoolYear);
  if (!periods.length) throw new Error("Aucune période 'Vacances' trouvée dans ce .ics pour l’année scolaire.");
  for (const p of periods){
    appendBreakRow(p.label, p.start, p.end);
  }
  recalcAll(); saveLocalMaybe();
}

/* ==============================
  Vacances / interruptions (table 3 colonnes)
============================== */

function breaksToText(breaks){
  // optionnel: garder une représentation texte (compat legacy / debug)
  return (breaks||[])
    .map(b => `${b.label || "Interruption"} : ${b.start} → ${b.end}`)
    .join("\n");
}

function breaksFromText(text){
  // réutilise ton parseBreaks actuel si tu veux migrer un ancien contenu textarea
  const arr = parseBreaks(text);
  return arr.map(x => ({
    label: String(x.label || "Vacances").replace(/\s+/g," ").trim(),
    start: x.start ? x.start.toISOString().slice(0,10) : "",
    end: x.end ? x.end.toISOString().slice(0,10) : ""
  }));
}

function enableBsTooltip(el){
  // Active tooltip Bootstrap si dispo, sinon le title natif suffit.
  if (!el) return;
  if (window.bootstrap?.Tooltip){
    bootstrap.Tooltip.getOrCreateInstance(el);
  }
}

function refreshBreakTooltips(){
  const body = $("breaksTableBody");
  if (!body) return;
  for (const tr of Array.from(body.children)){
    enableBsTooltip(tr);
  }
}

function newBreakRow({ label="", start="", end="" } = {}){
  const tr = document.createElement("tr");

  // Libellé → tooltip
  const inpLabel = document.createElement("input");
  inpLabel.type = "text";
  inpLabel.className = "d-none";
  inpLabel.value = label;

  function setRowTooltip(){
    const lbl = inpLabel.value?.trim() || "Interruption";
    tr.title = lbl;
    tr.setAttribute("data-bs-toggle", "tooltip");
    tr.setAttribute("data-bs-placement", "top");
    tr.setAttribute("data-bs-title", lbl);

    if (window.bootstrap?.Tooltip){
      const inst = bootstrap.Tooltip.getInstance(tr);
      if (inst) inst.dispose();
      bootstrap.Tooltip.getOrCreateInstance(tr);
    }
  }

  const tdStart = document.createElement("td");
  const inpStart = document.createElement("input");
  inpStart.type = "date";
  inpStart.className = "form-control form-control-sm";
  inpStart.value = start;
  tdStart.appendChild(inpStart);

  const tdEnd = document.createElement("td");
  const inpEnd = document.createElement("input");
  inpEnd.type = "date";
  inpEnd.className = "form-control form-control-sm";
  inpEnd.value = end;
  tdEnd.appendChild(inpEnd);

  const tdActions = document.createElement("td");
  tdActions.className = "text-end";

  const btnEdit = document.createElement("button");
  btnEdit.className = "btn btn-sm btn-outline-primary me-1";
  btnEdit.innerHTML = `<i class="bi bi-pencil"></i>`;
  btnEdit.onclick = ()=>{
    const v = prompt("Libellé :", inpLabel.value || "");
    if (v !== null){
      inpLabel.value = v.trim() || "Interruption";
      setRowTooltip();
      syncBreaksLegacyText();
      recalcAll(); saveLocalMaybe();
    }
  };

  const btnDel = document.createElement("button");
  btnDel.className = "btn btn-sm btn-outline-secondary";
  btnDel.innerHTML = `<i class="bi bi-x-lg"></i>`;
  btnDel.onclick = ()=>{
    if (window.bootstrap?.Tooltip){
      const inst = bootstrap.Tooltip.getInstance(tr);
      if (inst) inst.dispose();
    }
    tr.remove();
    syncBreaksLegacyText();
    recalcAll(); saveLocalMaybe();
  };

  tdActions.append(btnEdit, btnDel);

  tr.appendChild(inpLabel);
  tr.appendChild(tdStart);
  tr.appendChild(tdEnd);
  tr.appendChild(tdActions);

  setRowTooltip();
  return tr;
}

function getBreaksFromTable(){
  const body = $("breaksTableBody");
  if (!body) return [];
  const out = [];
  for (const tr of Array.from(body.children)){
    const inputs = tr.querySelectorAll("input");
    if (!inputs || inputs.length < 3) continue;
    const label = String(inputs[0].value || "").trim() || "Interruption";
    const start = String(inputs[1].value || "").trim();
    const end = String(inputs[2].value || "").trim();
    if (!start || !end) continue;
    // normalise start/end si inversés
    const a = start <= end ? start : end;
    const b = start <= end ? end : start;
    out.push({ label, start: a, end: b });
  }
  // tri chronologique
  out.sort((x,y)=> x.start < y.start ? -1 : x.start > y.start ? 1 : 0);
  return out;
}

function renderBreaksTable(breaks){
  const body = $("breaksTableBody");
  if (!body) return;
  body.innerHTML = "";
  (breaks||[]).forEach(b=>{
    body.appendChild(newBreakRow(b));
  });
  syncBreaksLegacyText();
  refreshBreakTooltips();
}

function syncBreaksLegacyText(){
  // si tu gardes le textarea caché, on le synchronise pour compat
  const ta = $("periodBreaks");
  if (!ta) return;
  ta.value = breaksToText(getBreaksFromTable());
}

function isInBreaks(date, breaks){
  if (!date) return false;
  const t = date.getTime();
  for (const br of breaks){
    if (t >= br.start.getTime() && t <= br.end.getTime()) return true;
  }
  return false;
}

function inRange(d, start, end){
  if (!d || !start || !end) return true;
  const t = d.getTime();
  return t >= start.getTime() && t <= end.getTime();
}

function splitKeywords(text){
  return (text || "")
    .split(/[,;\n\r]+/g)
    .map(s=>s.trim())
    .filter(Boolean);
}

function regexesFrom(text){
  return splitKeywords(text).map(k=>{
    const esc = k.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    return new RegExp(esc, "i");
  });
}

function matchesAny(hay, regs){
  if (!regs || !regs.length) return false;
  const s = String(hay || "");
  return regs.some(r=>r.test(s));
}

function guessStatusKind(statusText){
  const s = String(statusText || "").toLowerCase();
  if (!s) return "unknown";
  if (/(mandat|pay|pai|liquid|consomm|régl|regl|factur|service fait|sf)/i.test(s)) return "consumed";
  if (/(engag|commande|bc|reservation|réserv|reserv)/i.test(s)) return "engaged";
  return "unknown";
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ==============================
  2) Classement auto SRH -> catégories crédit nourriture
  - utilise en priorité cgrMajor/cgrDetail
  - fallback sur mots-clés existants via classifyTransaction()
============================== */
function srhSuggestCategoryId(row, type){
  const major = String(row?.cgrMajor || "").toUpperCase();
  const detail = String(row?.cgrDetail || "").toUpperCase();
  const acc = String(row?.account || "");

  if (type === "DEPENSE"){
    // VIAB
    if (major === "VIAB"){
      if (detail.includes("EAU")) return "DEP_VIAB_EAU";
      if (detail.includes("GAZ")) return "DEP_VIAB_GAZ";
      if (detail.includes("ELEC")) return "DEP_VIAB_ELEC";
      if (detail.includes("URB") || detail.includes("CHAUD")) return "DEP_VIAB_CHAUD";
      return "DEP_OBLIG";
    }
    // Denrées
    if (major === "DENREE") return "DEP_DENREES";
    // Entretien / MCO / Divers -> charges obligatoires (pilotage)
    if (["ENTRET","MCO","DIVERS"].includes(major)) return "DEP_OBLIG";
    // fallback: 601xxx souvent denrées
    if (acc.startsWith("601")) return "DEP_DENREES";
    return null;
  }

  // RECETTE
  // Quelques conventions SRH fréquentes dans ton extrait
  if (detail.includes("0INT")) return "REC_INTERNES";
  if (detail.includes("0COMM")) return "REC_COMMENSAUX";
  if (detail.includes("0HEBERGE") || detail.includes("0NUIT")) return "REC_LOCATION";
  if (detail.includes("0SNACK") || detail.includes("0PRODANX")) return "REC_ANNEXES";
  if (detail.includes("0REPASCFA")) return "REC_EXTERIEURS";
  if (detail.includes("0ELEVES")) return "REC_TICKETS"; // approximation raisonnable (à affiner si tu veux)

  // fallback: 70623x autres tiers => extérieurs
  if (acc.startsWith("70623")) return "REC_EXTERIEURS";
  // 744xxx subventions => annexe (ou location selon ton pilotage)
  if (acc.startsWith("744")) return "REC_ANNEXES";
  return null;
}

/* ==============================
  3) Alertes de cohérence (CGR vs n° de compte)
  - Exemple: compte 7xxx (recette) rangé sous DENREE/VIAB => warning
============================== */
function buildSrhWarnings(rows){
  const warns = [];
  for (const r of (rows||[])){
    const acc = String(r.account||"");
    const major = String(r.cgrMajor||"").toUpperCase();
    const isRec = acc.startsWith("7");
    const isDep = acc.startsWith("6");
    const majorDep = ["DENREE","VIAB","ENTRET","MCO","DIVERS"].includes(major);
    const majorRec = ["REVERS","EGALIM"].includes(major); // à ajuster si tu as d'autres CGR recettes

    if (isRec && majorDep){
      warns.push(`Compte ${acc} (recette) sous CGR ${major} → vérifier le collage / la restitution.`);
    }
    if (isDep && majorRec){
      warns.push(`Compte ${acc} (dépense) sous CGR ${major} → vérifier le collage / la restitution.`);
    }
  }
  // dédoublonnage simple
  return Array.from(new Set(warns)).slice(0, 8);
}

/* ==============================
  SRH Preview helpers
============================== */
function computeSrhPreviewTotals(rows){
  let totReal = 0, totPrev = 0;
  for (const r of (rows||[])){
    totReal += Number(r.real||0);
    totPrev += Number(r.prev||0);
  }
  return { totReal, totPrev };
}

function renderSrhPreview(rows){
  const body = $("srhPreviewBody");
  if (!body) return;
  body.innerHTML = "";

  const limited = (rows||[]).slice(0, 200);
  if (!limited.length){
    body.innerHTML = `<tr><td colspan="6" class="text-muted">Aucune ligne compte 6/7 détectée.</td></tr>`;
    return;
  }

  // 4) Regroupement visuel: on insère une ligne "header" à chaque changement de CGR
  let lastGroup = "";
  for (let i=0; i<limited.length; i++){
    const r = limited[i];
    const group = String(r.cgrPath || "SRH");
    if (group !== lastGroup){
      lastGroup = group;
      const trH = document.createElement("tr");
      trH.className = "table-light";
      trH.innerHTML = `
        <td colspan="6" class="fw-semibold">
          <i class="bi bi-folder2-open me-1"></i>${escapeHtml(group)}
        </td>`;
      body.appendChild(trH);
    }

    const type = String(r.account||"").startsWith("7") ? "RECETTE" : "DEPENSE";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${i+1}</td>
      <td class="mono">${escapeHtml(r.account||"")}</td>
      <td>${type === "RECETTE"
        ? `<span class="badge text-bg-success">Recette</span>`
        : `<span class="badge text-bg-secondary">Dépense</span>`}
      </td>
      <td>
        <div class="small text-muted">${escapeHtml(r.cgrPath||"SRH")}</div>
        <div>${escapeHtml(r.label||"")}</div>
      </td>
      <td class="text-end">${FR.fmtMoney(r.real||0)}</td>
      <td class="text-end">${FR.fmtMoney(r.prev||0)}</td>
    `;
    body.appendChild(tr);
  }

  if ((rows||[]).length > limited.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="6" class="text-muted">Aperçu limité à ${limited.length} lignes (sur ${(rows||[]).length}).</td>`;
    body.appendChild(tr);
  }
}

/* ==============================
  SRH paste import (tableau collé) + CGR SRH
  - Capture le contexte des lignes "SRH ..." (CGR) et l'applique aux comptes.
  - Heuristique colonnes (Op@le restitution):
      * récupère tous les montants sur la ligne
      * prend les 5 derniers si possible : [0]=Prévision (Budget/PR), [1]=Réalisé, [2]=Engagé...
      * real = [1] sinon [2], prev = [0]
============================== */
function parseSrhPasteToRows(text){
  const out = [];
  const lines = String(text || "").split(/\r?\n/);
  let currentMajor = "";   // ex: DENREE, VIAB, DIVERS...
  let currentDetail = "";  // ex: 0DENR, 0EAU, 0COMM...
  let currentRaw = "";     // ex: ligne SRH brute

  for (const raw of lines){
    const line = raw.trim();
    if (!line) continue;

    // -------------------------------------------------
    // 1) Lignes de regroupement SRH (contexte)
    // -------------------------------------------------
    if (line.startsWith("SRH")){
      currentRaw = line;
      const clean = line.replace(/\s+/g, " ").trim();
      // Retire "SRH" puis coupe avant " - "
      const left = clean.replace(/^SRH\s+/i, "").split(" - ")[0].trim();
      const parts = left.split(" ").filter(Boolean);
      currentMajor  = parts[0] || "";
      currentDetail = parts[1] || "";
  
      // --- NOUVEAU: intégrer les lignes "dot" (compte = ".") si elles portent des montants
      // Ex: "SRH . 0COMM - _   6 276,00 653,70 ..."
      const moneyMatches = clean.match(/-?\d[\d\s\u00A0\u202F]*,\d{2}/g) || [];
      const nums = moneyMatches.map(v => FR.parseMoney(v)).filter(n => Number.isFinite(n));
      if (nums.length){
        // Détection d'un "compte" point (.)
        // On accepte: "SRH ." ou "SRH .... . ...."
        const hasDotAccount = /\b\.\b/.test(clean) || clean.includes(" . ");
        if (hasDotAccount){
          // bloc montants à droite
          const block = (nums.length >= 5) ? nums.slice(-5) : nums.slice(-2);
          let prev = 0, real = 0;
          if (block.length >= 5){
            prev = block[0] || 0;
            real = (Math.abs(block[1]) > 0) ? block[1] : (block[2] || 0);
          } else {
            prev = block[0] || 0;
            real = block[1] || 0;
          }

          // Libellé = partie texte SRH avant le 1er montant
          // On prend ce qui suit "SRH" et on coupe avant le premier montant
          let labelPart = clean.replace(/^SRH\s+/i, "");
          labelPart = labelPart.split(/-?\d[\d\s\u00A0\u202F]*,\d{2}/)[0];
          labelPart = labelPart.replace(/\s+/g," ").trim();

          // Contexte CGR (lisible)
          let cgrPath = "SRH";
          if (currentMajor) cgrPath += ` > ${currentMajor}`;
          if (currentDetail) cgrPath += ` > ${currentDetail}`;

          out.push({
            account: ".",
            label: labelPart,      // libellé "pur" (sans montants)
            cgrMajor: currentMajor,
            cgrDetail: currentDetail,
            cgrPath,
            cgrRaw: currentRaw,
            real,
            prev,
            isDot: true
          });
        }
      }
      continue;
    }

    // -------------------------------------------------
    // NOUVEAU: lignes de sous-total "-” (sans n° de compte)
    // Ex:
    //    " -"
    // ou " -  92 254,47  0,00  0,00  0,00  92 254,47"
    // -------------------------------------------------
    if (/^-\s*$/.test(line) || /^-\s+/.test(line)){
      // On extrait les montants s'il y en a (sinon on ignore la ligne, car rien à importer)
      const moneyMatches = line.match(/-?\d[\d\s\u00A0\u202F]*,\d{2}/g) || [];
      const nums = moneyMatches.map(v => FR.parseMoney(v)).filter(n => Number.isFinite(n));
      if (nums.length){
        const block = (nums.length >= 5) ? nums.slice(-5) : nums.slice(-2);
        let prev = 0, real = 0;
        if (block.length >= 5){
          prev = block[0] || 0;
          real = (Math.abs(block[1]) > 0) ? block[1] : (block[2] || 0);
        } else {
          prev = block[0] || 0;
          real = block[1] || 0;
        }

        let cgrPath = "SRH";
        if (currentMajor) cgrPath += ` > ${currentMajor}`;
        if (currentDetail) cgrPath += ` > ${currentDetail}`;

        // libellé lisible
        const label = "Sous-total";

        out.push({
          account: "-",
          label,
          cgrMajor: currentMajor,
          cgrDetail: currentDetail,
          cgrPath,
          cgrRaw: currentRaw,
          real,
          prev,
          isDash: true
        });
      }
      continue;
    }

    // On ne garde que les lignes contenant un compte 6 chiffres (souvent précédé d'une tabulation)
    const mAcc = line.match(/(?:^|\s)(\d{6})\s*-\s*(.+)$/);
    if (!mAcc) continue;

    const account = mAcc[1];
    // libellé brut (avant nettoyage des montants)
    const labelRaw = mAcc[2];

    // Extraction "souple" de tous les montants au format fr (inclut espaces fines)
    const moneyMatches = line.match(/-?\d[\d\s\u00A0\u202F]*,\d{2}/g) || [];
    const nums = moneyMatches.map(v => FR.parseMoney(v)).filter(n => Number.isFinite(n));
    if (!nums.length) continue;

    // bloc cible = 5 derniers (le plus à droite)
    const block = (nums.length >= 5) ? nums.slice(-5) : nums.slice(-2);

    let prev = 0;
    let real = 0;
    if (block.length >= 5){
      prev = block[0] || 0;                 // Budget/PR
      real = (Math.abs(block[1]) > 0) ? block[1] : (block[2] || 0); // Réalisé sinon Engagé
    } else {
      // fallback minimal : [prev, real] sur les 2 derniers
      prev = block[0] || 0;
      real = block[1] || 0;
    }

    // -------------------------------------------------
    // Nettoyage strict du libellé :
    // on conserve UNIQUEMENT la partie texte avant le 1er montant
    // Ex: "REST.AUTRES TIERS  0,00  6 276,00" -> "REST.AUTRES TIERS"
    // -------------------------------------------------
    let label = String(labelRaw || "");

    // coupe dès qu'un montant FR apparaît
    label = label.split(/-?\d[\d\s\u00A0\u202F]*,\d{2}/)[0];

    // nettoyage final
    label = label.replace(/\s+/g, " ").trim();

    // -------------------------------------------------
    // 3) Enrichissement du libellé avec le contexte SRH
    // -------------------------------------------------
    // Contexte CGR (lisible)
    let cgrPath = "SRH";
    if (currentMajor) cgrPath += ` > ${currentMajor}`;
    if (currentDetail) cgrPath += ` > ${currentDetail}`;

    out.push({
      account,
      label,               // libellé comptable "pur"
      cgrMajor: currentMajor,
      cgrDetail: currentDetail,
      cgrPath,
      cgrRaw: currentRaw,
      real,
      prev
    });
  }
  return out;
}

/* ==============================
  Apply SRH paste rows -> transactions
  - label enrichi avec CGR
  - categoryId proposé via srhSuggestCategoryId()
============================== */
function applySrhPasteRows(rows){
  for (const r of rows){
    const acc = String(r.account || "");
    const major = String(r.cgrMajor || "").toUpperCase();
    const type =
      acc === "-"
        ? (["DENREE","VIAB","ENTRET","MCO","DIVERS"].includes(major) ? "DEPENSE" : "RECETTE")
        : (acc.startsWith("7") ? "RECETTE" : "DEPENSE");
    const cgrPrefix = String(r.cgrPath || "SRH");
    const baseLabel = `[${cgrPrefix}] ${acc} - ${r.label || ""}`.trim();
    const proposedCat = srhSuggestCategoryId(r, type);

    if (r.real){
      upsertTransaction(classifyTransaction({
        id: `SRH_REAL_${state.transactions.length+1}`,
        date: null,
        type,
        categoryId: proposedCat || null,
        label: `[SRH] ${baseLabel}`,
        vendor: "",
        amount: Math.abs(Number(r.real || 0)),
        statusKind: "consumed",
        statusRaw: "srh_real",
        source: "SRH_PASTE"
      }));
    }
    if (r.prev){
      upsertTransaction(classifyTransaction({
        id: `SRH_PREV_${state.transactions.length+1}`,
        date: null,
        type,
        categoryId: proposedCat || null,
        label: `[SRH prévision] ${baseLabel}`,
        vendor: "",
        amount: Math.abs(Number(r.prev || 0)),
        statusKind: "engaged",
        statusRaw: "srh_prev",
        source: "SRH_PASTE"
      }));
    }
  }
}

/* ==============================
  STATE (exportable)
============================== */
const state = {
  meta: { orgName:"", schoolYear:"" },
  period: { start:null, end:null, breaksText:"" },
  alerting: { baseThresholdPct: 5.0, sepDecFactor: 1.5 },
  rules: {
    // Ces règles sont volontairement simples. Vous pouvez les enrichir.
    revenue: "tickets, interne, commensaux, extérieur, exterieur, location, hébergement, hebergement, réception, reception, annexe, produit annexe, vente",
    spend: "eau, gaz, électricité, electricite, chauffage urbain, contrôle sanitaire, controle sanitaire, maintenance, révision, revision, vérification, verification, sécurité, securite"
  },
  mappings: {
    clca: { date:"", amount:"", label:"", status:"", vendor:"" },
    budget: { key:"", label:"", real:"", prev:"", type:"" }
  },
  categories: {
    recettes: [
      { id:"REC_TICKETS",   name:"Tickets", note:"" },
      { id:"REC_INTERNES",  name:"Internes", note:"" },
      { id:"REC_COMMENSAUX",name:"Commensaux", note:"" },
      { id:"REC_EXTERIEURS",name:"Extérieurs", note:"" },
      { id:"REC_LOCATION",  name:"Location restauration/hébergement", note:"" },
      { id:"REC_RECEPTIONS",name:"Réceptions", note:"" },
      { id:"REC_ANNEXES",   name:"Produits annexes", note:"" }
    ],
    depenses: [
      { id:"DEP_VIAB_EAU",  name:"VIAB – Eau", note:"" },
      { id:"DEP_VIAB_GAZ",  name:"VIAB – Gaz", note:"" },
      { id:"DEP_VIAB_ELEC", name:"VIAB – Électricité", note:"" },
      { id:"DEP_VIAB_CHAUD",name:"VIAB – Chauffage urbain", note:"" },
      { id:"DEP_OBLIG",     name:"Charges obligatoires", note:"(contrôles, maintenance, révisions…)" },
      { id:"DEP_DENREES",   name:"Denrées (option)", note:"À activer / ajuster selon votre pilotage" }
    ]
  },
  transactions: [
    // {id, date, type:"RECETTE|DEPENSE", categoryId, label, vendor, amount, statusKind, statusRaw, source}
  ],
  manual: {
    // categoryId: { real: number, prev: number }
  },
  // NEW: B4.1.1 (vote budget) - structure normalisée
  b411: {
    constants: {
      nbJours: 180,
      pctFonctionnement: 25.0,
      pctReversement: 25.0
    },
    // lines: clé = `${domaine}|${activite}|${compte}`
    // valeur = { domaine, activite, compte, label, totalPrev, totalReal }
    lines: {},
    computed: {
      totalRecPrev: 0,
      totalRecReal: 0,
      reversPrev: 0,
      reversReal: 0,
      fonctPrev: 0,
      fonctReal: 0
    }
  }
};

/* ==============================
  UI init
  (Nécessite des éléments présents dans votre HTML V2)
  - Inputs: periodStart, periodEnd, periodBreaks, baseThresholdPct, sepDecFactor
  - Textareas: rulesRevenue, rulesSpend
  - Tables: tblRecettes, tblDepenses, tblTx
  - Mapping selects: mapClcaDate/mapClcaAmount/mapClcaLabel/mapClcaStatus/mapClcaVendor
                   mapBudKey/mapBudLabel/mapBudReal/mapBudPrev/mapBudType
  - KPI placeholders: kpiSpendActual,kpiRevActual,kpiSpendForecast,kpiRevForecast,kpiCreditFood,creditFoodBox
  - Alert placeholder: alertBox
  - Chart canvas: cnChart
============================== */
function initDefaults(){
  if (!state.period.start) state.period.start = todayISO();
  if (!state.period.end) state.period.end = todayISO();

  if ($("periodStart")) $("periodStart").value = state.period.start;
  if ($("periodEnd")) $("periodEnd").value = state.period.end;
  if ($("periodBreaks")) $("periodBreaks").value = state.period.breaksText || "";

  if ($("baseThresholdPct")) $("baseThresholdPct").value = state.alerting.baseThresholdPct;
  if ($("sepDecFactor")) $("sepDecFactor").value = state.alerting.sepDecFactor;

  if ($("rulesRevenue")) $("rulesRevenue").value = state.rules.revenue;
  if ($("rulesSpend")) $("rulesSpend").value = state.rules.spend;

  // B4.1.1 UI defaults
  ensureB411Defaults();
  if ($("b411NbJours")) $("b411NbJours").value = state.b411.constants.nbJours;
  if ($("b411PctFonct")) $("b411PctFonct").value = state.b411.constants.pctFonctionnement;
  if ($("b411PctRevers")) $("b411PctRevers").value = state.b411.constants.pctReversement;
  computeB411();
}

/* ==============================
  Build tables with editable cells
============================== */
function ensureManual(catId){
  if (!state.manual[catId]) state.manual[catId] = { real: 0, prev: 0 };
  return state.manual[catId];
}

function buildCategoryTables(){
  const recT = $("tblRecettes");
  const depT = $("tblDepenses");
  if (!recT || !depT) return;

  const recBody = recT.querySelector("tbody");
  const depBody = depT.querySelector("tbody");
  recBody.innerHTML = "";
  depBody.innerHTML = "";

  function addRow(tbody, cat, type){
    const tr = document.createElement("tr");
    tr.dataset.catId = cat.id;
    tr.dataset.type = type;
    const man = ensureManual(cat.id);

    tr.innerHTML = `
      <td>${escapeHtml(cat.name)}</td>
      <td class="text-end editable" data-field="real" title="Double-clic pour modifier">${FR.fmtMoney(man.real)}</td>
      <td class="text-end editable" data-field="prev" title="Double-clic pour modifier">${FR.fmtMoney(man.prev)}</td>
      <td><input class="form-control form-control-sm" value="${escapeHtml(cat.note||"")}" data-field="note"></td>
    `;
    tbody.appendChild(tr);
  }

  state.categories.recettes.forEach(cat=>addRow(recBody, cat, "RECETTE"));
  state.categories.depenses.forEach(cat=>addRow(depBody, cat, "DEPENSE"));

  // editable money cells
  document.querySelectorAll("td.editable").forEach(td=>{
    td.addEventListener("dblclick", ()=>{
      const tr = td.closest("tr");
      const catId = tr.dataset.catId;
      const field = td.dataset.field;
      const current = ensureManual(catId)[field] || 0;

      const input = document.createElement("input");
      input.className = "form-control form-control-sm text-end";
      input.value = String(current).replace(".", ",");
      td.innerHTML = "";
      td.appendChild(input);
      input.focus();
      input.select();

      const commit = ()=>{
        const v = FR.parseMoney(input.value);
        ensureManual(catId)[field] = v;
        td.innerHTML = FR.fmtMoney(v);
        recalcAll();
        saveLocalMaybe();
      };

      input.addEventListener("blur", commit);
      input.addEventListener("keydown", (e)=>{
        if (e.key === "Enter") commit();
        if (e.key === "Escape"){
          td.innerHTML = FR.fmtMoney(current);
        }
      });
    });
  });

  // note inputs
  document.querySelectorAll("input[data-field='note']").forEach(inp=>{
    inp.addEventListener("change", ()=>{
      const tr = inp.closest("tr");
      const catId = tr.dataset.catId;
      const type = tr.dataset.type;
      const list = type === "RECETTE" ? state.categories.recettes : state.categories.depenses;
      const cat = list.find(x=>x.id===catId);
      if (cat) cat.note = inp.value;
      saveLocalMaybe();
    });
  });
}

/* ==============================
  B4.1.1 helpers
============================== */
function ensureB411Defaults(){
  if (!state.b411) {
    state.b411 = { constants:{ nbJours:180, pctFonctionnement:25.0, pctReversement:25.0 }, lines:{}, computed:{} };
  }
  if (!state.b411.constants) state.b411.constants = { nbJours:180, pctFonctionnement:25.0, pctReversement:25.0 };
  if (!state.b411.lines) state.b411.lines = {};
  if (!state.b411.computed) state.b411.computed = {};
}

function b411DomainFromRow(r){
  // Domaine "vote" : SRH / VIAB / REVERS (ajustable)
  const major = String(r?.cgrMajor || "").toUpperCase();
  if (major === "VIAB") return "VIAB";
  if (major === "REVERS") return "REVERS";
  return "SRH";
}

function b411ActivityFromRow(r){
  // Activité: 0ELEVES, 0COMM, 0DENR, etc.
  const a = String(r?.cgrDetail || "").trim();
  return a || "0GEN";
}

function b411LabelFromRow(r){
  // libellé propre (déjà nettoyé des montants)
  const lbl = String(r?.label || "").trim();
  // Si tu as enrichi le label plus haut, ça reste OK.
  return lbl || "";
}

function rowTypeFromRow(r){
  // Détermine Recette/Dépense même pour "." et "-"
  const acc = String(r?.account || "");
  if (/^\d{6}$/.test(acc)) return acc.startsWith("7") || acc.startsWith("744") ? "RECETTE" : "DEPENSE";
  const major = String(r?.cgrMajor || "").toUpperCase();
  // Heuristique : ces majeures sont des dépenses
  if (["DENREE","VIAB","ENTRET","MCO","DIVERS","REVERS"].includes(major)) return "DEPENSE";
  return "RECETTE";
}

function typeBadgeHtml(type){
  if (type === "RECETTE") return `<span class="badge text-bg-success">Recette</span>`;
  return `<span class="badge text-bg-secondary">Dépense</span>`;
}

function addB411Line({ domaine, activite, compte, label, prev, real }){
  const key = `${domaine}|${activite}|${compte}`;
  if (!state.b411.lines[key]){
    state.b411.lines[key] = {
      domaine, activite, compte,
      label,
      totalPrev: 0,
      totalReal: 0
    };
  }
  state.b411.lines[key].totalPrev += Number(prev||0);
  state.b411.lines[key].totalReal += Number(real||0);
}

function computeB411(){
  ensureB411Defaults();
  let recPrev = 0, recReal = 0;
  // total recettes = comptes 7xxx dans SRH (et éventuellement subventions 744 si tu veux les compter comme recettes SRH)
  for (const line of Object.values(state.b411.lines)){
    const c = String(line.compte||"");
    const isRec = c.startsWith("7") || c.startsWith("744"); // 744xxx = subventions, souvent côté recettes
    if (isRec){
      recPrev += Number(line.totalPrev||0);
      recReal += Number(line.totalReal||0);
    }
  }
  const pctF = Number(state.b411.constants.pctFonctionnement||0)/100.0;
  const pctR = Number(state.b411.constants.pctReversement||0)/100.0;

  state.b411.computed.totalRecPrev = recPrev;
  state.b411.computed.totalRecReal = recReal;
  state.b411.computed.fonctPrev = recPrev * pctF;
  state.b411.computed.fonctReal = recReal * pctF;
  state.b411.computed.reversPrev = recPrev * pctR;
  state.b411.computed.reversReal = recReal * pctR;

  // KPI UI
  if ($("b411KpiRecPrev")) $("b411KpiRecPrev").textContent = FR.fmtMoney(state.b411.computed.totalRecPrev);
  if ($("b411KpiReversPrev")) $("b411KpiReversPrev").textContent = FR.fmtMoney(state.b411.computed.reversPrev);
  if ($("b411KpiFonctPrev")) $("b411KpiFonctPrev").textContent = FR.fmtMoney(state.b411.computed.fonctPrev);
}

/* ==============================
  UI: B4.1.1 lignes générées
============================== */
function getB411LinesArray(){
  ensureB411Defaults();
  return Object.values(state.b411.lines || {});
}

function uniqSorted(arr){
  return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b)));
}

function fillSelectOptions(selectEl, values, placeholder){
  if (!selectEl) return;
  const current = selectEl.value;
  selectEl.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = placeholder || "Tous";
  selectEl.appendChild(opt0);
  for (const v of values){
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    selectEl.appendChild(opt);
  }
  // restaure si possible
  if ([...selectEl.options].some(o=>o.value===current)) selectEl.value = current;
}

function refreshB411Filters(){
  const lines = getB411LinesArray();
  const domains = uniqSorted(lines.map(x=>x.domaine));
  const acts = uniqSorted(lines.map(x=>x.activite));
  fillSelectOptions($("b411FilterDomain"), domains, "Tous");
  fillSelectOptions($("b411FilterActivity"), acts, "Toutes");
}

function renderB411LinesTable(){
  const body = $("b411LinesBody");
  if (!body) return;
  const domain = $("b411FilterDomain")?.value || "";
  const activity = $("b411FilterActivity")?.value || "";
  const q = String($("b411Search")?.value || "").trim().toLowerCase();

  let rows = getB411LinesArray();
  if (domain) rows = rows.filter(r => String(r.domaine||"") === domain);
  if (activity) rows = rows.filter(r => String(r.activite||"") === activity);
  if (q){
    rows = rows.filter(r=>{
      const s = `${r.domaine||""} ${r.activite||""} ${r.compte||""} ${r.label||""}`.toLowerCase();
      return s.includes(q);
    });
  }

  // Totaux filtrés
  let totReal = 0, totPrev = 0;
  for (const r of rows){
    totReal += Number(r.totalReal||0);
    totPrev += Number(r.totalPrev||0);
  }
  if ($("b411LinesCount")) $("b411LinesCount").textContent = String(rows.length);
  if ($("b411LinesTotReal")) $("b411LinesTotReal").textContent = FR.fmtMoney(totReal);
  if ($("b411LinesTotPrev")) $("b411LinesTotPrev").textContent = FR.fmtMoney(totPrev);

  // Rendu
  body.innerHTML = "";
  if (!rows.length){
    body.innerHTML = `<tr><td colspan="7" class="text-muted">Aucune ligne ne correspond aux filtres.</td></tr>`;
    return;
  }

  // tri stable (domaine, activité, compte)
  rows.sort((a,b)=>{
    const da = String(a.domaine||"").localeCompare(String(b.domaine||""));
    if (da) return da;
    const aa = String(a.activite||"").localeCompare(String(b.activite||""));
    if (aa) return aa;
    return String(a.compte||"").localeCompare(String(b.compte||""));
  });

  for (const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${escapeHtml(r.domaine||"")}</td>
      <td class="mono">${escapeHtml(r.activite||"")}</td>
      <td>${typeBadgeHtml(type)} ${isOrphan ? `<span class="badge text-bg-warning ms-1" title="Activité non déterminée">Orpheline</span>` : ""}</td>
      <td class="mono">${escapeHtml(r.compte||"")}</td>
      <td>${escapeHtml(r.label||"")}</td>
      <td class="text-end">${FR.fmtMoney(r.totalReal||0)}</td>
      <td class="text-end">${FR.fmtMoney(r.totalPrev||0)}</td>
    `;
    body.appendChild(tr);
  }
}

function refreshB411LinesUI(){
  refreshB411Filters();
  renderB411LinesTable();
}

function downloadJson(filename, obj){
  const data = JSON.stringify(obj, null, 2);
  const blob = new Blob([data], {type:"application/json;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
}

/* ==============================
  Contrôle: Somme comptes vs sous-totaux "." / "-"
  - nécessite de conserver les "raw rows" du dernier import SRH
============================== */
function buildB411CheckTable(){
  const body = $("b411CheckBody");
  if (!body) return;
  const raw = state.b411?.lastImportRows || [];
  if (!raw.length){
    body.innerHTML = `<tr><td colspan="7" class="text-muted">Aucun import SRH en mémoire pour contrôle.</td></tr>`;
    return;
  }

  // Agrégation par Domaine|Activité|Type
  const map = new Map();
  const keyOf = (d,a,t)=>`${d}|${a}|${t}`;
  const ensure = (d,a,t)=>{
    const k = keyOf(d,a,t);
    if (!map.has(k)){
      map.set(k, { domaine:d, activite:a, type:t, sumAccPrev:0, sumAccReal:0, subPrev:0, subReal:0 });
    }
    return map.get(k);
  };

  for (const r of raw){
    const domaine = b411DomainFromRow(r);
    const activite = b411ActivityFromRow(r);
    const type = rowTypeFromRow(r); // robust pour . / -
    const acc = String(r.account||"");
    const e = ensure(domaine, activite, type);

    if (/^\d{6}$/.test(acc)){
      e.sumAccPrev += Number(r.prev||0);
      e.sumAccReal += Number(r.real||0);
    } else if (acc === "." || acc === "-"){
      e.subPrev += Number(r.prev||0);
      e.subReal += Number(r.real||0);
    }
  }

  const rows = Array.from(map.values())
    .filter(x => (Math.abs(x.subPrev) > 0 || Math.abs(x.subReal) > 0 || Math.abs(x.sumAccPrev) > 0 || Math.abs(x.sumAccReal) > 0))
    .sort((a,b)=>{
      const d = String(a.domaine).localeCompare(String(b.domaine)); if (d) return d;
      const aa = String(a.activite).localeCompare(String(b.activite)); if (aa) return aa;
      return String(a.type).localeCompare(String(b.type));
    });

  if (!rows.length){
    body.innerHTML = `<tr><td colspan="7" class="text-muted">Rien à contrôler (pas de sous-totaux ./- ou pas de lignes comptes).</td></tr>`;
    return;
  }

  body.innerHTML = "";
  for (const r of rows){
    // contrôle sur prévision (le plus important pour vote) + note
    const deltaPrev = (r.sumAccPrev - r.subPrev);
    const deltaReal = (r.sumAccReal - r.subReal);
    const hasSub = Math.abs(r.subPrev) > 0 || Math.abs(r.subReal) > 0;
    const note = hasSub
      ? (Math.abs(deltaPrev) < 0.01 ? "OK (prévision)" : "Écart (prévision) – vérifier le collage ou les sous-totaux")
      : "Pas de sous-total";
    const deltaShown = FR.fmtMoney(deltaPrev);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${escapeHtml(r.domaine)}</td>
      <td class="mono">${escapeHtml(r.activite)}</td>
      <td>${typeBadgeHtml(r.type)}</td>
      <td class="text-end">${FR.fmtMoney(r.sumAccPrev)}</td>
      <td class="text-end">${FR.fmtMoney(r.subPrev)}</td>
      <td class="text-end">${escapeHtml(deltaShown)}</td>
      <td>${escapeHtml(note)}${Math.abs(deltaReal) > 0.01 ? ` (réalisé écart ${FR.fmtMoney(deltaReal)})` : ""}</td>
    `;
    body.appendChild(tr);
  }
}

/* ==============================
  SRH -> Pilotage simplifié (tableaux) + B4.1.1
  - On n'utilise PAS "." et "-" pour les totaux (évite double-comptage)
============================== */
function mapSrhToSimpleCategory(row){
  // Version “pilotage” : catégories existantes
  const major = String(row?.cgrMajor||"").toUpperCase();
  const detail = String(row?.cgrDetail||"").toUpperCase();
  const acc = String(row?.account||"");
  const lbl = String(row?.label||"").toLowerCase();

  // Dépenses
  if (acc.startsWith("6")){
    if (major === "VIAB"){
      if (detail.includes("EAU")) return "DEP_VIAB_EAU";
      if (detail.includes("GAZ")) return "DEP_VIAB_GAZ";
      if (detail.includes("ELEC")) return "DEP_VIAB_ELEC";
      if (detail.includes("URB") || detail.includes("CHAU")) return "DEP_VIAB_CHAUD";
      return "DEP_OBLIG";
    }
    if (major === "DENREE" || acc.startsWith("601")) return "DEP_DENREES";
    if (["ENTRET","MCO","DIVERS","REVERS","EGALIM"].includes(major)) return "DEP_OBLIG";
    if (/eau/.test(lbl)) return "DEP_VIAB_EAU";
    if (/gaz/.test(lbl)) return "DEP_VIAB_GAZ";
    if (/(électric|electric|edf|kwh)/.test(lbl)) return "DEP_VIAB_ELEC";
    if (/(chauffage urbain|réseau de chaleur|reseau de chaleur)/.test(lbl)) return "DEP_VIAB_CHAUD";
    return "DEP_OBLIG";
  }

  // Recettes
  if (acc.startsWith("7") || acc.startsWith("744")){
    if (detail.includes("0INT")) return "REC_INTERNES";
    if (detail.includes("0COMM")) return "REC_COMMENSAUX";
    if (detail.includes("0ELEVES")) return "REC_TICKETS";
    if (detail.includes("0HEBERGE") || detail.includes("0NUIT")) return "REC_LOCATION";
    if (detail.includes("0SNACK") || detail.includes("0PRODANX")) return "REC_ANNEXES";
    if (detail.includes("0REPASCFA") || acc.startsWith("70623")) return "REC_EXTERIEURS";
    if (/recept/i.test(lbl)) return "REC_RECEPTIONS";
    // fallback
    return "REC_TICKETS";
  }
  return null;
}

function applySrhToManualTables(rows, { overwrite=true, useDashWhenNoDetails=false } = {}){
  const sums = {}; // catId -> {real, prev}
  const byActDetail = {}; // `${domain}|${act}|${type}` -> {hasDetails:boolean, sumPrev,sumReal, dashPrev,dashReal}
  const add = (cat, real, prev)=>{
    if (!cat) return;
    if (!sums[cat]) sums[cat] = { real:0, prev:0 };
    sums[cat].real += Number(real||0);
    sums[cat].prev += Number(prev||0);
  };
  for (const r of (rows||[])){

  const bucketKey = (r)=>{
    const d = b411DomainFromRow(r);
    const a = b411ActivityFromRow(r);
    const t = rowTypeFromRow(r);
    return `${d}|${a}|${t}`;
  };

  // 1er passage: détails comptes 6/7 + collecte dash
    const acc = String(r.account||"");
    const k = bucketKey(r);
    if (!byActDetail[k]) byActDetail[k] = { hasDetails:false, sumPrev:0, sumReal:0, dashPrev:0, dashReal:0 };

    if (/^\d{6}$/.test(acc)){
      byActDetail[k].hasDetails = true;
      byActDetail[k].sumPrev += Number(r.prev||0);
      byActDetail[k].sumReal += Number(r.real||0);
      const cat = mapSrhToSimpleCategory(r);
      add(cat, r.real, r.prev);
      continue;
    }

    if (acc === "-" ){
      byActDetail[k].dashPrev += Number(r.prev||0);
      byActDetail[k].dashReal += Number(r.real||0);
      continue;
    }
  }

  // 2e passage: utilisation conditionnelle des "-" quand pas de détail
  if (useDashWhenNoDetails){
    for (const [k, v] of Object.entries(byActDetail)){
      if (!v.hasDetails && (Math.abs(v.dashPrev)>0 || Math.abs(v.dashReal)>0)){
        // reconstitue un row minimal depuis la clé
        const [dom, act, type] = k.split("|");
        const fake = { account:"-", cgrMajor: dom==="VIAB" ? "VIAB" : (dom==="REVERS"?"REVERS":"SRH"), cgrDetail: act, label:"Sous-total", prev:v.dashPrev, real:v.dashReal };
        const cat = mapSrhToSimpleCategory(fake);
        add(cat, v.dashReal, v.dashPrev);
      }
    }
  }
  for (const [catId, v] of Object.entries(sums)){
    if (!state.manual[catId]) state.manual[catId] = { real:0, prev:0 };
    if (overwrite){
      state.manual[catId].real = v.real;
      state.manual[catId].prev = v.prev;
    } else {
      state.manual[catId].real += v.real;
      state.manual[catId].prev += v.prev;
    }
  }
  buildCategoryTables();
}

function buildB411FromSRHPaste(rows, { overwrite=true } = {}){
  ensureB411Defaults();
  if (overwrite) state.b411.lines = {};
  // conserve toutes les rows du dernier import (y compris "-") pour contrôle
  state.b411.lastImportRows = Array.isArray(rows) ? rows.slice() : [];

  // 1) Pilotage simplifié (tes tableaux)
  //    Inclut les lignes "-" UNIQUEMENT si aucun détail (comptes 6/7) pour la même activité,
  //    ce qui répond au besoin "montant dépenses quand seules lignes = -".
  applySrhToManualTables(rows, { overwrite, useDashWhenNoDetails:true });

  // 2) B4.1.1 normalisé (clé: domaine|activité|compte)
  for (const r of (rows||[])){
    const acc = String(r.account||"");
    if (!/^\d{6}$/.test(acc)) continue; // on ne prend pas "-" / autres
    const domaine = b411DomainFromRow(r);
    const activite = b411ActivityFromRow(r);
    const label = b411LabelFromRow(r);
    addB411Line({
      domaine,
      activite,
      compte: acc,
      label,
      prev: r.prev,
      real: r.real
    });
  }

  computeB411();
  recalcAll();
  saveLocalMaybe();
}

/* ==============================
  Import utilities (XLSX/CSV)
============================== */
function readWorkbookFromFile(file){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onerror = reject;
    reader.onload = (e)=>{
      try{
        const dataArr = e.target.result;
        const wb = XLSX.read(dataArr, { type:"array" });
        resolve(wb);
      }catch(err){ reject(err); }
    };
    reader.readAsArrayBuffer(file);
  });
}

function sheetToRows(wb, sheetName){
  const name = sheetName || wb.SheetNames[0];
  const ws = wb.Sheets[name];
  const rows = XLSX.utils.sheet_to_json(ws, { defval:"" });
  return { rows, sheetName:name };
}

function fillMappingSelect(selectId, headers, preferred){
  const sel = $(selectId);
  if (!sel) return;
  sel.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "—";
  sel.appendChild(opt0);
  for (const h of headers){
    const opt = document.createElement("option");
    opt.value = h;
    opt.textContent = h;
    sel.appendChild(opt);
  }
  if (preferred && headers.includes(preferred)) sel.value = preferred;
}

function detectPreferred(headers, patterns){
  const lower = headers.map(h=>String(h).toLowerCase());
  for (let i=0;i<lower.length;i++){
    for (const re of patterns){
      if (re.test(lower[i])) return headers[i];
    }
  }
  return "";
}

function setupClcaMapping(headers){
  const prefDate = state.mappings.clca.date || detectPreferred(headers,[/date/]);
  const prefAmount = state.mappings.clca.amount || detectPreferred(headers,[/montant/,/ttc/,/ht/,/total/,/net/]);
  const prefLabel = state.mappings.clca.label || detectPreferred(headers,[/objet/,/libell/,/désignation|designation/,/intitul/]);
  const prefStatus = state.mappings.clca.status || detectPreferred(headers,[/statut/,/etat/,/phase/,/engag/,/mandat/,/pai/]);
  const prefVendor = state.mappings.clca.vendor || detectPreferred(headers,[/tiers/,/fournisseur/,/créancier|creancier/,/beneficiaire/,/raison/]);

  fillMappingSelect("mapClcaDate", headers, prefDate);
  fillMappingSelect("mapClcaAmount", headers, prefAmount);
  fillMappingSelect("mapClcaLabel", headers, prefLabel);
  fillMappingSelect("mapClcaStatus", headers, prefStatus);
  fillMappingSelect("mapClcaVendor", headers, prefVendor);
}

/* ==============================
  Classification (plastique)
============================== */
function classifyTransaction(tx){
  const revRegs = regexesFrom(state.rules.revenue);
  const spRegs  = regexesFrom(state.rules.spend);

  const hay = `${tx.label||""} ${tx.vendor||""} ${tx.statusRaw||""}`.trim();

  // Type
  let type = tx.type;
  if (!type){
    if (matchesAny(hay, revRegs)) type = "RECETTE";
    else type = "DEPENSE";
  }

  // Category
  let categoryId = tx.categoryId;

  if (type === "DEPENSE"){
    const h = hay.toLowerCase();
    if (!categoryId){
      if (/eau/.test(h)) categoryId = "DEP_VIAB_EAU";
      else if (/gaz/.test(h)) categoryId = "DEP_VIAB_GAZ";
      else if (/(électric|electric|edf|kwh)/.test(h)) categoryId = "DEP_VIAB_ELEC";
      else if (/(chauffage urbain|réseau de chaleur|reseau de chaleur)/.test(h)) categoryId = "DEP_VIAB_CHAUD";
      else if (matchesAny(hay, spRegs)) categoryId = "DEP_OBLIG";
      else categoryId = "DEP_DENREES"; // fallback
    }
  } else {
    if (!categoryId){
      const h = hay.toLowerCase();
      if (/interne/.test(h)) categoryId = "REC_INTERNES";
      else if (/commens/.test(h)) categoryId = "REC_COMMENSAUX";
      else if (/(extérieur|exterieur)/.test(h)) categoryId = "REC_EXTERIEURS";
      else if (/(location|héberg|heberg)/.test(h)) categoryId = "REC_LOCATION";
      else if (/(réception|reception)/.test(h)) categoryId = "REC_RECEPTIONS";
      else if (/(annexe|divers|vente)/.test(h)) categoryId = "REC_ANNEXES";
      else categoryId = "REC_TICKETS";
    }
  }

  return { ...tx, type, categoryId };
}

function reclassAll(){
  // refresh rules from UI
  if ($("rulesRevenue")) state.rules.revenue = $("rulesRevenue").value || state.rules.revenue;
  if ($("rulesSpend")) state.rules.spend = $("rulesSpend").value || state.rules.spend;

  state.transactions = state.transactions.map(tx=>classifyTransaction(tx));
  renderTransactions();
  recalcAll();
  saveLocalMaybe();
}

/* ==============================
  Apply imports -> transactions
============================== */
function upsertTransaction(tx){
  state.transactions.push(tx);
}

function applyClcaRows(rows){
  state.mappings.clca = {
    date: $("mapClcaDate")?.value || "",
    amount: $("mapClcaAmount")?.value || "",
    label: $("mapClcaLabel")?.value || "",
    status: $("mapClcaStatus")?.value || "",
    vendor: $("mapClcaVendor")?.value || ""
  };
  const md = state.mappings.clca;

  for (const r of rows){
    const date = md.date ? parseISODate(r[md.date]) : null;
    const amount = md.amount ? FR.parseMoney(r[md.amount]) : 0;
    const label = md.label ? String(r[md.label]||"") : "";
    const vendor = md.vendor ? String(r[md.vendor]||"") : "";
    const statusRaw = md.status ? String(r[md.status]||"") : "";
    const statusKind = md.status ? guessStatusKind(statusRaw) : "unknown";

    if (!amount && !label && !vendor) continue;

    const tx = classifyTransaction({
      id: `CLCA_${state.transactions.length+1}`,
      date,
      type: null,          // let classifier decide
      categoryId: null,
      label,
      vendor,
      amount: Math.abs(Number(amount||0)),
      statusKind,
      statusRaw,
      source: "CLCA"
    });

    upsertTransaction(tx);
  }
}

/* ==============================
  Transactions table (preview + correction)
============================== */
function renderTransactions(){
  const tbl = $("tblTx");
  if (!tbl) return;
  const body = tbl.querySelector("tbody");
  body.innerHTML = "";

  const start = parseISODate($("periodStart")?.value);
  const end   = parseISODate($("periodEnd")?.value);
  const breaks = getBreaksFromTable().map(b => ({
    label: b.label,
    start: parseISODate(b.start),
    end: parseISODate(b.end)
  }));

  const recCats = state.categories.recettes;
  const depCats = state.categories.depenses;

  const catOptions = (type) => {
    const list = type === "RECETTE" ? recCats : depCats;
    return list.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("");
  };

  const visible = state.transactions
    .filter(tx=>{
      // filter by period when date exists
      if (!tx.date) return true;
      if (!inRange(tx.date, start, end)) return false;
      if (isInBreaks(tx.date, breaks)) return false;
      return true;
    })
    .slice(0, 200); // preview limit

  if (!visible.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="8" class="text-muted">Aucune transaction affichée.</td>`;
    body.appendChild(tr);
    return;
  }

  for (const tx of visible){
    const tr = document.createElement("tr");
    tr.dataset.txId = tx.id;

    const typeBadge = tx.type === "RECETTE"
      ? `<span class="badge text-bg-success">Recette</span>`
      : `<span class="badge text-bg-secondary">Dépense</span>`;

    const stBadge = tx.statusKind === "consumed"
      ? `<span class="badge text-bg-primary">Consommé</span>`
      : tx.statusKind === "engaged"
        ? `<span class="badge text-bg-warning">Engagé</span>`
        : `<span class="badge text-bg-light text-dark border">—</span>`;

    tr.innerHTML = `
      <td class="mono">${escapeHtml(tx.source||"")}</td>
      <td>${FR.fmtDate(tx.date)}</td>
      <td>${typeBadge}</td>
      <td>${escapeHtml(tx.vendor||"")}</td>
      <td>${escapeHtml(tx.label||"")}</td>
      <td class="text-end">${FR.fmtMoney(tx.amount||0)}</td>
      <td>${stBadge}</td>
      <td>
        <select class="form-select form-select-sm" data-field="category">
          ${catOptions(tx.type)}
        </select>
      </td>
    `;

    body.appendChild(tr);

    const sel = tr.querySelector("select[data-field='category']");
    sel.value = tx.categoryId || (tx.type==="RECETTE" ? "REC_TICKETS" : "DEP_DENREES");
    sel.addEventListener("change", ()=>{
      const cur = state.transactions.find(t=>t.id===tx.id);
      if (cur){
        cur.categoryId = sel.value;
        // when user overrides category, keep it
        recalcAll();
        saveLocalMaybe();
      }
    });
  }

  if (state.transactions.length > visible.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="8" class="text-muted">Aperçu limité à ${visible.length} lignes (sur ${state.transactions.length}).</td>`;
    body.appendChild(tr);
  }
}

/* ==============================
  Aggregation (real vs prev)
  - Réalisé : statusKind == consumed (et budget_real)
  - Prévision : réalisé + engagé (ou budget_prev)
  - On additionne aussi les "manual" par catégorie (real & prev)
============================== */
function sumsByCategory(){
  const sums = {}; // catId -> { real, prev }
  const ensure = (catId)=>{
    if (!sums[catId]) sums[catId] = { real: 0, prev: 0 };
    return sums[catId];
  };

  // period filters
  const start = parseISODate($("periodStart")?.value);
  const end   = parseISODate($("periodEnd")?.value);
  const breaks = parseBreaks($("periodBreaks")?.value || "");

  const inPeriod = (tx)=>{
    if (!tx.date) return true;
    if (!inRange(tx.date, start, end)) return false;
    if (isInBreaks(tx.date, breaks)) return false;
    return true;
  };

  // transactions
  for (const tx of state.transactions){
    if (!inPeriod(tx)) continue;
    const cat = tx.categoryId;
    if (!cat) continue;
    const bucket = ensure(cat);
    const amt = Number(tx.amount||0);

    // realized
    if (tx.statusKind === "consumed" || tx.statusRaw === "budget_real"){
      bucket.real += amt;
      bucket.prev += amt; // realized is part of forecast
    } else {
      // engaged/unknown counts for forecast only
      bucket.prev += amt;
    }
  }

  // manual adjustments
  for (const [catId, m] of Object.entries(state.manual)){
    const bucket = ensure(catId);
    bucket.real += Number(m.real||0);
    bucket.prev += Number(m.prev||0);
  }

  return sums;
}

function totalsFromSums(sums){
  const isRec = (catId)=> state.categories.recettes.some(c=>c.id===catId);
  const isDep = (catId)=> state.categories.depenses.some(c=>c.id===catId);

  let recReal=0, recPrev=0, depReal=0, depPrev=0;
  for (const [catId, v] of Object.entries(sums)){
    if (isRec(catId)){ recReal += v.real; recPrev += v.prev; }
    if (isDep(catId)){ depReal += v.real; depPrev += v.prev; }
  }
  return { recReal, recPrev, depReal, depPrev };
}

/* ==============================
  Alerting (5% + sensibilité Sep–Déc)
============================== */
function computeThreshold(depPrev){
  const pct = Number($("baseThresholdPct")?.value || state.alerting.baseThresholdPct);
  const factor = Number($("sepDecFactor")?.value || state.alerting.sepDecFactor);

  const start = parseISODate($("periodStart")?.value);
  const m = start ? (start.getMonth()+1) : null;
  const seasonal = (m && m>=9 && m<=12) ? factor : 1.0;

  return (depPrev * (pct/100)) * seasonal;
}

function renderAlert(cnPrev, depPrev){
  const box = $("alertBox");
  if (!box) return;

  const threshold = computeThreshold(depPrev);

  box.innerHTML = "";
  if (cnPrev <= 0){
    box.innerHTML = `
      <div class="alert alert-danger border">
        <div class="fw-semibold"><i class="bi bi-exclamation-triangle-fill me-2"></i>ALERTE – Crédit nourriture ≤ 0</div>
        <div class="mt-1">Campagne de recettes à déclencher immédiatement.</div>
        <div class="mt-2"><span class="badge text-bg-light border">Montant TR indicatif</span>
          <span class="fw-semibold">${FR.fmtMoney(Math.abs(cnPrev) + threshold)}</span>
        </div>
      </div>`;
    return;
  }

  if (cnPrev <= threshold){
    box.innerHTML = `
      <div class="alert alert-warning border">
        <div class="fw-semibold"><i class="bi bi-exclamation-circle-fill me-2"></i>Attention – Crédit nourriture fragile</div>
        <div class="mt-1">Seuil dynamique : ${FR.fmtMoney(threshold)} (base 5% × facteur saison).</div>
        <div class="mt-2"><span class="badge text-bg-light border">TR recommandé (indicatif)</span>
          <span class="fw-semibold">${FR.fmtMoney(threshold - cnPrev)}</span>
        </div>
      </div>`;
  }
}

/* ==============================
  Chart (réel vs prévisionnel)
============================== */
let cnChart = null;

function renderChart(recReal, recPrev, depReal, depPrev){
  const canvas = $("cnChart");
  if (!canvas || typeof Chart === "undefined") return;

  const cnReal = recReal - depReal;
  const cnPrev = recPrev - depPrev;

  if (cnChart) cnChart.destroy();

  cnChart = new Chart(canvas, {
    type: "bar",
    data: {
      labels: ["Recettes", "Dépenses", "Crédit nourriture"],
      datasets: [
        {
          label: "Réalisé",
          data: [recReal, depReal, cnReal]
        },
        {
          label: "Prévisionnel",
          data: [recPrev, depPrev, cnPrev]
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" },
        tooltip: {
          callbacks: {
            label: (ctx)=> `${ctx.dataset.label}: ${FR.fmtMoney(ctx.raw)}`
          }
        }
      },
      scales: {
        y: {
          ticks: {
            callback: (v)=> FR.fmtMoney(v)
          }
        }
      }
    }
  });
}

/* ==============================
  KPI rendering
============================== */
function setText(id, txt){
  const el = $(id);
  if (el) el.textContent = txt;
}

function recalcAll(){
  // sync period/rules
  if ($("periodStart")) state.period.start = $("periodStart").value;
  if ($("periodEnd")) state.period.end = $("periodEnd").value;
  if ($("periodBreaks")) state.period.breaksText = $("periodBreaks").value || "";

  if ($("baseThresholdPct")) state.alerting.baseThresholdPct = Number($("baseThresholdPct").value || 5.0);
  if ($("sepDecFactor")) state.alerting.sepDecFactor = Number($("sepDecFactor").value || 1.5);

  // build sums
  const sums = sumsByCategory();
  const totals = totalsFromSums(sums);

  // KPIs
  setText("kpiRevActual", FR.fmtMoney(totals.recReal));
  setText("kpiRevForecast", FR.fmtMoney(totals.recPrev));
  setText("kpiSpendActual", FR.fmtMoney(totals.depReal));
  setText("kpiSpendForecast", FR.fmtMoney(totals.depPrev));

  const cnReal = totals.recReal - totals.depReal;
  const cnPrev = totals.recPrev - totals.depPrev;

  setText("kpiCreditFood", FR.fmtMoney(cnPrev));
  setText("creditFoodBox", FR.fmtMoney(cnPrev));

  renderAlert(cnPrev, totals.depPrev);
  renderChart(totals.recReal, totals.recPrev, totals.depReal, totals.depPrev);
}

/* ==============================
  Local persistence (optionnel)
============================== */
const LOCAL_KEY = "SRH_CREDIT_NOURRITURE_V2";

function saveLocalMaybe(){
  try { localStorage.setItem(LOCAL_KEY, JSON.stringify(state)); } catch {}
}

function loadLocalMaybe(){
  try{
    const s = localStorage.getItem(LOCAL_KEY);
    if (!s) return false;
    const obj = JSON.parse(s);
    if (obj && obj.categories && obj.transactions){
      Object.assign(state, obj);
      return true;
    }
  }catch{}
  return false;
}

/* ==============================
  Export / Import JSON (fichier de suivi)
============================== */
function exportJSON(){
  const blob = new Blob([JSON.stringify(state, null, 2)], { type:"application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "suivi_credit_nourriture_v2.json";
  a.click();
}

function importJSON(input){
  const file = input.files && input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const obj = JSON.parse(e.target.result);
      Object.assign(state, obj);
      initDefaults();
      buildCategoryTables();
      renderTransactions();
      recalcAll();
      saveLocalMaybe();
    }catch(err){
      alert("Fichier JSON invalide.");
    }
  };
  reader.readAsText(file, "utf-8");
}

/* ==============================
  Bindings (imports + mapping + actions)
============================== */
async function handleCLCAImport(file){
  const wb = await readWorkbookFromFile(file);
  const { rows } = sheetToRows(wb);
  const headers = rows.length ? Object.keys(rows[0]) : [];
  setupClcaMapping(headers);
  // store rows temporarily for “appliquer mapping”
  window.__clcaRows = rows;
  // show modal/section mapping if you have it
  if ($("lastImport")) $("lastImport").value = `CLCA: ${file.name} (${headers.length} colonnes)`;
}

function applyPendingImports(){
  if (window.__clcaRows && window.__clcaRows.length){
    applyClcaRows(window.__clcaRows);
    window.__clcaRows = null;
  }
  reclassAll();
  saveLocalMaybe();
}

function bindUI(){
  // re-calc on parameter changes
  ["periodStart","periodEnd","baseThresholdPct","sepDecFactor","rulesRevenue","rulesSpend"]
    .forEach(id=>{
      const el = $(id);
      if (!el) return;
      el.addEventListener("change", ()=>{ recalcAll(); saveLocalMaybe(); });
      el.addEventListener("input", ()=>{ recalcAll(); });
    });

  // Vacances: boutons + modale + import API
  const btnAddBreak = $("btnAddBreak");
  if (btnAddBreak){
    btnAddBreak.addEventListener("click", ()=>{
      // presets: label vide, dates = période
      if ($("breakLabel")) $("breakLabel").value = "";
      if ($("breakStart")) $("breakStart").value = $("periodStart")?.value || "";
      if ($("breakEnd")) $("breakEnd").value = $("periodEnd")?.value || "";
      if (window.bootstrap?.Modal){
        const m = bootstrap.Modal.getOrCreateInstance($("breakModal"));
        m.show();
      }else{
        alert("Bootstrap JS manquant (modal).");
      }
    });
  }

  const btnSaveBreak = $("btnSaveBreak");
  if (btnSaveBreak){
    btnSaveBreak.addEventListener("click", ()=>{
      const label = $("breakLabel")?.value || "Interruption";
      const start = isoFromDateInput("breakStart");
      const end = isoFromDateInput("breakEnd");
      if (!start || !end){
        alert("Veuillez renseigner début et fin.");
        return;
      }
      appendBreakRow(label, start, end);
      recalcAll(); saveLocalMaybe();
      if (window.bootstrap?.Modal){
        const m = bootstrap.Modal.getOrCreateInstance($("breakModal"));
        m.hide();
      }
    });
  }

  const btnImportBreaks = $("btnImportBreaks");
  if (btnImportBreaks){
    btnImportBreaks.addEventListener("click", ()=>{
      const box = $("breakImportBox");
      if (box) box.classList.toggle("d-none");
    });
  }

  // Populate school years select
  const sySel = $("breakSchoolYear");
  if (sySel){
    const inferred = inferSchoolYear();
    const baseYear = Number(inferred.slice(0,4));
    const opts = schoolYearOptionsAround(baseYear);
    sySel.innerHTML = opts.map(v=>`<option value="${v}">${v}</option>`).join("");
    sySel.value = inferred;
  }

  const btnDoImportBreaks = $("btnDoImportBreaks");
  if (btnDoImportBreaks){
    btnDoImportBreaks.addEventListener("click", async ()=>{
      try{
        btnDoImportBreaks.disabled = true;
        const zone = $("breakZone")?.value || "A";
        const schoolYear = $("breakSchoolYear")?.value || inferSchoolYear();
        const periods = await fetchSchoolHolidays({ zone, schoolYear });
        if (!periods.length){
          alert("Aucune vacance trouvée pour ces critères.");
          return;
        }
        for (const p of periods){
          appendBreakRow(p.label, p.start, p.end);
        }
        recalcAll(); saveLocalMaybe();
      }catch(err){
        alert(`Import vacances impossible : ${err?.message || "erreur inconnue"}`);
      }finally{
        btnDoImportBreaks.disabled = false;
      }
    });
  }

  // Téléchargement .ics (fallback manuel)
  const btnDownloadIcs = $("btnDownloadIcs");
  if (btnDownloadIcs){
    btnDownloadIcs.addEventListener("click", ()=>{
      const zone = $("breakZone")?.value || "A";
      const url = getIcsDownloadUrlForZone(zone);
      // Ouvre un nouvel onglet : le navigateur gère le download/affichage.
      window.open(url, "_blank", "noopener,noreferrer");
    });
  }

  // Import d'un .ics local (fallback “sans CORS”)
  const icsFile = $("icsFile");
  if (icsFile){
    icsFile.addEventListener("change", async ()=>{
      const file = icsFile.files && icsFile.files[0];
      if (!file) return;
      try{
        const zone = $("breakZone")?.value || "A";
        const schoolYear = $("breakSchoolYear")?.value || inferSchoolYear();
        await importIcsFile(file, { zone, schoolYear });
        // reset input pour permettre re-import du même fichier si besoin
        icsFile.value = "";
      }catch(err){
        alert(`Import .ics impossible : ${err?.message || "erreur inconnue"}`);
      }
    });
  }

  // file inputs
  const clcaFile = $("clcaFile");
  if (clcaFile){
    clcaFile.addEventListener("change", async (e)=>{
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      try{ await handleCLCAImport(file); }
      catch(err){ alert("Import CLCA impossible (format)."); }
    });
  }

  // SRH paste: preview + import confirmé
  const btnPreview = $("btnPreviewSrhPaste");
  if (btnPreview){
    btnPreview.addEventListener("click", ()=>{
      const text = $("srhPaste")?.value || "";
      if (!String(text).trim()){
        alert("Aucune donnée collée.");
        return;
      }
      const rows = parseSrhPasteToRows(text);
      window.__srhPasteRows = rows;

      const { totReal, totPrev } = computeSrhPreviewTotals(rows);
      if ($("srhPrevCount")) $("srhPrevCount").textContent = `${rows.length}`;
      if ($("srhPrevTotReal")) $("srhPrevTotReal").textContent = FR.fmtMoney(totReal);
      if ($("srhPrevTotPrev")) $("srhPrevTotPrev").textContent = FR.fmtMoney(totPrev);
      renderSrhPreview(rows);

      // Alertes cohérence
      const warns = buildSrhWarnings(rows);
      const hint = $("srhPrevHint");
      if (hint){
        if (warns.length){
          hint.innerHTML = `
            <div class="alert alert-warning py-2 mb-0">
              <div class="fw-semibold mb-1"><i class="bi bi-exclamation-triangle me-1"></i>Points à vérifier</div>
              <ul class="mb-0 ps-3">
                ${warns.map(w=>`<li>${escapeHtml(w)}</li>`).join("")}
              </ul>
            </div>`;
        } else {
          hint.textContent = "Alerte cohérence : aucune anomalie évidente détectée.";
        }
      }

      if (window.bootstrap?.Modal){
        const m = bootstrap.Modal.getOrCreateInstance($("srhPreviewModal"));
        m.show();
      } else {
        alert("Bootstrap JS manquant (modal).");
      }
    });
  }

  // B4.1.1 constants UI
  const syncB411 = ()=>{
    ensureB411Defaults();
    if ($("b411NbJours")) state.b411.constants.nbJours = Number($("b411NbJours").value||0);
    if ($("b411PctFonct")) state.b411.constants.pctFonctionnement = Number($("b411PctFonct").value||0);
    if ($("b411PctRevers")) state.b411.constants.pctReversement = Number($("b411PctRevers").value||0);
    computeB411();
    saveLocalMaybe();
  };
  ["b411NbJours","b411PctFonct","b411PctRevers"].forEach(id=>{
    const el = $(id);
    if (el) el.addEventListener("change", syncB411);
  });
  const btnB411Recalc = $("btnB411Recalc");
  if (btnB411Recalc) btnB411Recalc.addEventListener("click", syncB411);

  // B4.1.1 lines UI bindings
  const b411Domain = $("b411FilterDomain");
  const b411Act = $("b411FilterActivity");
  const b411Search = $("b411Search");
  if (b411Domain) b411Domain.addEventListener("change", renderB411LinesTable);
  if (b411Act) b411Act.addEventListener("change", renderB411LinesTable);
  if (b411Search) b411Search.addEventListener("input", renderB411LinesTable);

  const btnB411Clear = $("btnB411ClearFilters");
  if (btnB411Clear){
    btnB411Clear.addEventListener("click", ()=>{
      if ($("b411FilterDomain")) $("b411FilterDomain").value = "";
      if ($("b411FilterActivity")) $("b411FilterActivity").value = "";
      if ($("b411Search")) $("b411Search").value = "";
      renderB411LinesTable();
    });
  }

  const btnB411Refresh = $("btnB411Refresh");
  if (btnB411Refresh) btnB411Refresh.addEventListener("click", refreshB411LinesUI);

  const btnB411ExportJson = $("btnB411ExportJson");
  if (btnB411ExportJson){
    btnB411ExportJson.addEventListener("click", ()=>{
      ensureB411Defaults();
      downloadJson("B4.1.1_lignes_generees.json", {
        constants: state.b411.constants,
        computed: state.b411.computed,
        lines: state.b411.lines
      });
    });
  }

  const btnB411Check = $("btnB411Check");
  if (btnB411Check){
    btnB411Check.addEventListener("click", ()=>{
      buildB411CheckTable();
    });
  }

  const btnConfirm = $("btnConfirmImportSrh");
  if (btnConfirm){
    btnConfirm.addEventListener("click", ()=>{
      const rows = window.__srhPasteRows || [];
      if (!rows.length){
        alert("Aucune ligne à importer (prévisualisez d’abord).");
        return;
      }
      // NEW: alimente tableaux simplifiés + structure B4.1.1
      buildB411FromSRHPaste(rows, { overwrite:true });
      refreshB411LinesUI();
      buildB411CheckTable();

      // Optionnel : conserver les transactions pour audit (si tu veux)
      // applySrhPasteRows(rows);

      window.__srhPasteRows = null;
       if (window.bootstrap?.Modal){
         const m = bootstrap.Modal.getInstance($("srhPreviewModal"));
         if (m) m.hide();
       }
       alert(`Import SRH effectué : ${rows.length} lignes.`);
     });
  }

  // Import direct (sans preview) : on force la preview si pas déjà faite
  const btnImport = $("btnImportSrhPaste");
  if (btnImport){
    btnImport.addEventListener("click", ()=>{
      const text = $("srhPaste")?.value || "";
      if (!String(text).trim()){
        alert("Aucune donnée collée.");
        return;
      }
      // si pas de preview, on ouvre la preview (UX: import = preview + confirmation)
      if (!window.__srhPasteRows){
        $("btnPreviewSrhPaste")?.click();
        return;
      }
      // si preview déjà faite, on propose d'importer via la modale (cohérent)
      if (window.bootstrap?.Modal){
        const m = bootstrap.Modal.getOrCreateInstance($("srhPreviewModal"));
        m.show();
      }
    });
  }

  const btnClearSrhPaste = $("btnClearSrhPaste");
  if (btnClearSrhPaste){
    btnClearSrhPaste.addEventListener("click", ()=>{
      if ($("srhPaste")) $("srhPaste").value = "";
      window.__srhPasteRows = null;
    });
  }

  // mapping select changes persist
  ["mapClcaDate","mapClcaAmount","mapClcaLabel","mapClcaStatus","mapClcaVendor"]
    .forEach(id=>{
      const el = $(id);
      if (!el) return;
      el.addEventListener("change", ()=> saveLocalMaybe());
    });

  // Buttons if present
  const btnApply = $("btnApplyImports");
  if (btnApply) btnApply.addEventListener("click", applyPendingImports);

  const btnReclass = $("btnReclass");
  if (btnReclass) btnReclass.addEventListener("click", reclassAll);

  const btnExport = $("btnExportJSON");
  if (btnExport) btnExport.addEventListener("click", exportJSON);

  const btnClear = $("btnClearAll");
  if (btnClear){
    btnClear.addEventListener("click", ()=>{
      if (!confirm("Effacer transactions et ajustements ?")) return;
      if (window.bootstrap?.Tooltip){
        for (const tr of Array.from(body.children)){
          const inst = bootstrap.Tooltip.getInstance(tr);
          if (inst) inst.dispose();
        }
      }
      state.transactions = [];
      state.manual = {};
      buildCategoryTables();
      renderTransactions();
      recalcAll();
      saveLocalMaybe();
    });
  }
}

/* ==============================
  BOOT
============================== */
document.addEventListener("DOMContentLoaded", ()=>{
  loadLocalMaybe();
  initDefaults();
  buildCategoryTables();
  renderTransactions();
  bindUI();
  // Migration: si un ancien texte existe (textarea caché), on le convertit en table une fois
  const legacy = $("periodBreaks")?.value || "";
  if (legacy.trim()){
    renderBreaksTable(breaksFromText(legacy));
  }else{
    renderBreaksTable([]); // initialise table vide
  }
  recalcAll();
});

/* Expose export/import for inline handlers if needed */
window.exportJSON = exportJSON;
window.importJSON = importJSON;
window.reclassAll = reclassAll;
window.applyPendingImports = applyPendingImports;

</script>
<!-- Bootstrap JS (bundle) requis pour collapse/modals -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
