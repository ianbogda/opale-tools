<!doctype html>
<html lang="fr">
    <meta charset="utf-8" /><meta content="width=device-width,initial-scale=1" name="viewport" />
	<title>TDB Op@le</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
	<style>
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.35); /* voile sombre */
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-box {
            background: #ffffff;
            border-radius: 12px;
            padding: 18px 22px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.35);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .loading-text {
            font-size: 14px;
            color: #374151;
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            margin: 15px;
            font-family:
                system-ui,
                -apple-system,
                BlinkMacSystemFont,
                "Segoe UI",
                sans-serif;
            background: #f5f5f7;
            color: #111827;
        }
        h1 {
            text-align: center;
            font-size: 22px;
            margin-bottom: 10px;
        }
        .section-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #374151;
        }
        .anchor-nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
            padding: 6px 10px;
            background: #fff;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .anchor-nav a {
            text-decoration: none;
            font-size: 13px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            color: #374151;
        }
        .anchor-nav a:hover {
            background: #f3f4f6;
        }
        .top-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .top-bar-extra label {
            color: #374151;
        }
        .btn,
        button {
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid transparent;
            background-color: #0d6efd;
            color: #fff;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: #fff;
        }
        .btn-help {
            background-color: #f8f9fa;
            color: #111827;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            padding: 0;
            font-weight: 600;
            font-size: 18px;
            line-height: 32px;
            text-align: center;
            border: 1px solid #d1d5db;
        }
        .btn:disabled,
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .input-inline,
        input[type="file"],
        input[type="text"],
        select {
            background-color: #fff;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            padding: 4px 8px;
            font-size: 14px;
            color: #111827;
        }
        .input-inline {
            width: 120px;
            text-align: right;
        }
        label {
            font-size: 14px;
            display: inline-block;
            margin-bottom: 4px;
        }
        .note {
            text-align: center;
            font-size: 12px;
            margin-top: 5px;
            color: #6b7280;
        }
        section {
            margin-top: 10px;
        }
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(4, minmax(180px, 1fr));
            gap: 15px;
            margin: 10px auto;
            max-width: 1200px;
        }
        .kpi-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06);
        }
        .kpi-title {
            font-size: 13px;
            text-transform: uppercase;
            color: #6b7280;
        }
        .kpi-value {
            font-size: 20px;
            font-weight: 600;
            margin-top: 5px;
            color: #111827;
        }
        .kpi-sub {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 2px;
        }
        .row-charts {
            display: grid;
            grid-template-columns: repeat(2, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 10px;
        }
        .row-charts.fdr-row {
            grid-template-columns: 2fr 1fr;
            align-items: stretch;
        }
        .row-charts.fdr-row .chart-container {
            min-height: 260px;
            display: flex;
            flex-direction: column;
        }
        .row-charts.fdr-row .chart-container canvas {
            flex: 1 1 auto;
        }
        .chart-container {
            background-color: #fff;
            color: #111827;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06);
        }
        .chart-container h2 {
            text-align: center;
            font-size: 18px;
            margin-bottom: 10px;
            color: #111827;
        }
        .fdr-side-panel {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }
        .fdr-side-panel .kpi-value {
            font-size: 24px;
        }
        .fdr-side-panel .kpi-sub {
            font-size: 13px;
        }
        canvas {
            max-height: 340px !important;
        }
        #backToTop {
            display: none;
            position: fixed;
            bottom: 40px;
            right: 40px;
            z-index: 9999;
            background: #0d6efd;
            color: #fff;
            padding: 10px 14px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 14px;
            border: none;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.2);
        }
        .toolbox-root {
            font-family: inherit;
            background-color: transparent;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 0;
        }
        .tabs {
            display: flex;
            justify-content: center;
            width: 100%;
            background-color: #fff;
            border-bottom: 1px solid #e5e7eb;
            gap: 4px;
            padding: 4px 0;
        }
        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            font-size: 14px;
            color: #374151;
        }
        .tab.active {
            background-color: #fff;
            border-bottom-color: #fff;
        }
        .tab-content {
            width: 100%;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background-color: #fff;
            margin-top: 12px;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .file-content {
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New",
                monospace;
            font-size: 13px;
            background: #f9fafb;
            border-radius: 4px;
            padding: 8px;
            border: 1px solid #e5e7eb;
        }
        .code-preview {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: Consolas, "Courier New", monospace;
            white-space: pre;
            overflow-x: auto;
            margin-top: 20px;
            max-height: 400px;
            border: 1px solid #333;
        }
        .table-preview-container {
            margin-top: 20px;
            overflow-x: auto;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #fff;
        }
        .table-preview {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            min-width: 800px;
        }
        .table-preview th {
            background: #f2f2f2;
            font-weight: 700;
            padding: 6px 8px;
            border: 1px solid #ddd;
            text-align: left;
            white-space: nowrap;
        }
        .table-preview td {
            padding: 6px 8px;
            border: 1px solid #ddd;
            white-space: nowrap;
        }
        .table-preview td.number {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }
        .table-preview-container::-webkit-scrollbar {
            height: 8px;
        }
        .table-preview-container::-webkit-scrollbar-thumb {
            background: #999;
            border-radius: 4px;
        }
        .popup {
            display: none;
            position: fixed;
            z-index: 1000;
            inset: 0;
            background-color: rgba(15, 23, 42, 0.4);
        }
        .popup-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.2);
        }
        .close {
            color: #9ca3af;
            float: right;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
        }
        .close:focus,
        .close:hover {
            color: #111827;
            text-decoration: none;
        }
        .config-message {
            position: absolute;
            top: 73px;
            left: 33px;
            background-color: #fff;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
        }
        .config-button {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: auto;
            padding: 8px 14px;
        }
        .radio-group {
            margin-bottom: 15px;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 5px;
        }
        .radio-group input[type="radio"] {
            margin: 0;
        }
        .download-button {
            margin-top: 20px;
            width: auto;
            padding: 8px 16px;
            display: none;
        }
        .clear-button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: 0 0;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #9ca3af;
        }
        .clear-button:hover {
            color: #4b5563;
        }
        .input-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        .input-container input {
            flex: 1;
        }
        .input-container datalist {
            flex: 1;
            max-width: 100%;
        }
        header.app-header {
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
        }
        .surface,
        .surface-alt {
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }
        .badge-palette {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            color: #6b7280;
        }
        .badge-color-dot {
            width: 12px;
            height: 12px;
            border-radius: 999px;
        }
        .node:hover {
            cursor: pointer;
            opacity: 0.85;
        }
        .sunburst-wrapper,
        .waterfall-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        .sunburst-svg {
            width: 350px;
            height: 350px;
        }
        .waterfall-svg {
            width: 650px;
            height: 350px;
        }
        .budget-timeline-wrapper {
            position: relative;
            width: 100%;
            margin-top: 20px;
        }
        .htimeline {
            list-style: none;
            padding: 0;
            margin: 40px 0 0;
            display: flex;
            width: 100%;
        }
        .htimeline .step {
            position: relative;
            flex: 1;
            border-top: 5px solid #d1d5db;
            background: #f9fafb;
            padding: 12px 14px 20px 14px;
            min-height: 140px;
            transition: background-color 0.3s;
            font-size: 14px;
            overflow: visible;
        }
        .htimeline .step:nth-child(odd) {
            background: #f3f4f6;
        }
        .htimeline .step::before {
            content: "";
            position: absolute;
            top: -12px;
            left: -2px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #2563eb;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.25);
            z-index: 5;
        }
        .htimeline .step::after {
            content: attr(data-date-fr);
            position: absolute;
            top: -32px;
            left: 20px;
            font-size: 11px;
            font-style: italic;
            color: #6b7280;
            white-space: nowrap;
        }
        .step-title {
            font-weight: 700;
            color: #111827;
            margin-bottom: 6px;
        }
        .step-desc {
            font-size: 13px;
            color: #374151;
            line-height: 1.35;
        }
        .htimeline .step.past {
            background: #e5e7eb;
        }
        .htimeline .step.past::before {
            border-color: #9ca3af;
        }
        .htimeline .step.past .step-desc,
        .htimeline .step.past .step-title {
            color: #6b7280;
        }
        #today-marker {
            position: absolute;
            top: 0;
            transform: translateX(-50%);
            text-align: center;
            pointer-events: none;
            z-index: 30;
        }
        .today-label {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            font-size: 12px;
            font-weight: 700;
            color: #ef4444;
            white-space: nowrap;
        }
        .today-dot {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 10px solid #ef4444;
            margin: 0 auto;
        }
        #srh-page .srh-summary-card {
            border-radius: 0.75rem;
        }
        #srh-page h5,
        #srh-page h6 {
            font-weight: 600;
        }
        #srh-page .srh-table input {
            min-width: 80px;
        }
        #srh-page .srh-table td,
        #srh-page .srh-table th {
            font-size: 0.86rem;
        }
        #srh-page .card-header {
            border-bottom-width: 1px;
        }
        @media print {
            @page {
                size: landscape;
                margin: 12mm;
            }
            body {
                background: #fff;
                color: #000;
            }
            #backToTop,
            #file-ecbu,
            #file-fdr,
            #file-input,
            #help-overlay,
            .anchor-nav,
            .btn,
            .btn-help,
            .top-bar-extra,
            button {
                display: none !important;
            }
            .chart-container {
                width: 95% !important;
                max-width: 100% !important;
                background-color: #fff !important;
                color: #000 !important;
                page-break-inside: avoid;
            }
            .chart-container h2 {
                color: #000 !important;
            }
            .kpi-container {
                page-break-inside: avoid;
            }
            .timeline-wrapper {
                width: 100%;
                overflow-x: auto;
                padding: 1rem 0;
            }
            .timeline-h {
                position: relative;
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                gap: 1.5rem;
                min-width: 900px;
                padding: 1.5rem 0 0.5rem;
            }
        }
    </style>
    <ul class="nav nav-tabs bg-light px-3 sticky-top" id="mainTabs" role="tablist" style="z-index: 1030">
        <li class="nav-item" role="presentation">
            <button
                class="nav-link active"
                type="button"
                data-bs-target="#tab-tdb"
                data-bs-toggle="tab"
                aria-controls="tab-tdb"
                aria-selected="true"
                id="tab-tdb-tab"
                role="tab"
            >
                Tableau de bord – Exécution budgétaire
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                class="nav-link"
                type="button"
                data-bs-target="#tab-explo"
                data-bs-toggle="tab"
                aria-controls="tab-explo"
                aria-selected="false"
                id="tab-explo-tab"
                role="tab"
            >
                Explorateur budgétaire
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                class="nav-link"
                type="button"
                data-bs-target="#tab-toolbox"
                data-bs-toggle="tab"
                aria-controls="tab-toolbox"
                aria-selected="false"
                id="tab-toolbox-tab"
                role="tab"
            >
                Toolbox Op@le
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                class="nav-link"
                type="button"
                data-bs-target="#tab-calendar"
                data-bs-toggle="tab"
                aria-controls="tab-calendar"
                aria-selected="false"
                id="tab-calendar-tab"
                role="tab"
            >
                Calendrier budgétaire
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                class="nav-link"
                id="tab-simulation-tab"
                data-bs-toggle="tab"
                data-bs-target="#tab-simulation"
                type="button"
                role="tab"
                aria-controls="tab-simulation"
                aria-selected="false"
            >
                Simulation de projets
            </button>
        </li>
    </ul>
    <div class="tab-content" id="mainTabsContent" style="padding-top: 4px">
        <div class="fade tab-pane active show" id="tab-tdb" aria-labelledby="tab-tdb-tab" role="tabpanel">
            <div class="d-flex align-items-center justify-content-between mb-2 flex-wrap gap-2">
                <h1 class="mb-0">Tableau de bord de l'exécution budgétaire – Dépenses & Recettes</h1>
                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-sm" type="button" onclick="window.print()">
                        Imprimer
                    </button>
                    <!-- Bouton pour ouvrir la fenêtre de création d'issue -->
                    <button class="btn btn-sm"
                        type="button"
                        data-bs-target="#issueModal"
                        data-bs-toggle="modal"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bug" viewBox="0 0 16 16">
                        <path d="M4.355.522a.5.5 0 0 1 .623.333l.291.956A5 5 0 0 1 8 1c1.007 0 1.946.298 2.731.811l.29-.956a.5.5 0 1 1 .957.29l-.41 1.352A5 5 0 0 1 13 6h.5a.5.5 0 0 0 .5-.5V5a.5.5 0 0 1 1 0v.5A1.5 1.5 0 0 1 13.5 7H13v1h1.5a.5.5 0 0 1 0 1H13v1h.5a1.5 1.5 0 0 1 1.5 1.5v.5a.5.5 0 1 1-1 0v-.5a.5.5 0 0 0-.5-.5H13a5 5 0 0 1-10 0h-.5a.5.5 0 0 0-.5.5v.5a.5.5 0 1 1-1 0v-.5A1.5 1.5 0 0 1 2.5 10H3V9H1.5a.5.5 0 0 1 0-1H3V7h-.5A1.5 1.5 0 0 1 1 5.5V5a.5.5 0 0 1 1 0v.5a.5.5 0 0 0 .5.5H3c0-1.364.547-2.601 1.432-3.503l-.41-1.352a.5.5 0 0 1 .333-.623M4 7v4a4 4 0 0 0 3.5 3.97V7zm4.5 0v7.97A4 4 0 0 0 12 11V7zM12 6a4 4 0 0 0-1.334-2.982A3.98 3.98 0 0 0 8 2a3.98 3.98 0 0 0-2.667 1.018A4 4 0 0 0 4 6z"/>
                      </svg>
                      Bug
                    </button>
                    <button
                        class="btn btn-sm"
                        type="button"
                        data-bs-target="#helpModal"
                        data-bs-toggle="modal"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-life-preserver" viewBox="0 0 16 16">
                        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m6.43-5.228a7.03 7.03 0 0 1-3.658 3.658l-1.115-2.788a4 4 0 0 0 1.985-1.985zM5.228 14.43a7.03 7.03 0 0 1-3.658-3.658l2.788-1.115a4 4 0 0 0 1.985 1.985zm9.202-9.202-2.788 1.115a4 4 0 0 0-1.985-1.985l1.115-2.788a7.03 7.03 0 0 1 3.658 3.658m-8.087-.87a4 4 0 0 0-1.985 1.985L1.57 5.228A7.03 7.03 0 0 1 5.228 1.57zM8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6"/>
                      </svg>
                      Aide
                    </button>
                </div>
            </div>
            <div class="anchor-nav">
                <a href="#bloc-synthese">Vue synthétique</a> <a href="#bloc-cumul">Cumul mensuel</a>
                <a href="#bloc-nature">Analyse par nature</a> <a href="#bloc-services">Par service</a>
                <a href="#bloc-zoom-ap">Zoom pédagogique (AP)</a> <a href="#bloc-zoom-srh">Zoom restauration (SRH)</a>
                <a href="#bloc-fdr">Fond de roulement & CAF</a> <a href="#bloc-clca">Commandes (CLCA)</a>
            </div>
            <div class="p-3 mb-3 surface-alt">
                <button
                    class="d-flex align-items-center justify-content-between btn btn-outline-secondary btn-sm w-100"
                    type="button"
                    data-bs-target="#collapse-params"
                    data-bs-toggle="collapse"
                    aria-expanded="false"
                >
                    <span>Paramètres du tableau de bord</span> <i class="bi bi-chevron-down"></i>
                </button>
                <div class="mt-3 collapse" id="collapse-params">
                    <div class="p-3 surface rounded mb-3">
                        <div class="g-3 row align-items-end">
                            <div class="col-md-3">
                                <label for="select-exercice" class="small text-secondary form-label">Exercice</label>
                                <select class="form-select form-select-sm" id="select-exercice">
                                    <option value="">Tous</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="budget-dep" class="small text-secondary form-label"
                                    >Budget dépenses (€)</label
                                >
                                <input
                                    type="number"
                                    class="form-control form-control-sm"
                                    id="budget-dep"
                                    placeholder="ex : 900000"
                                />
                            </div>
                            <div class="col-md-3">
                                <label for="budget-rec" class="small text-secondary form-label"
                                    >Budget recettes (€)</label
                                >
                                <input
                                    type="number"
                                    class="form-control form-control-sm"
                                    id="budget-rec"
                                    placeholder="ex : 900000"
                                />
                            </div>
                            <div class="d-flex align-items-end col-md-3">
                                <button class="btn btn-sm w-100 btn-secondary" onclick="recalculerTheorique()">
                                    Recalculer théorique
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 surface rounded">
                        <div class="g-3 row">
                            <div class="col-md-3">
                                <label for="file-input" class="small text-secondary form-label">YCMCPT (.xlsx)</label>
                                <input
                                    type="file"
                                    accept=".xlsx"
                                    class="form-control form-control-sm"
                                    id="file-input"
                                    multiple
                                />
                            </div>
                            <div class="col-md-3">
                                <label for="file-fdr" class="small text-secondary form-label"
                                    >FDR – YFDR (.xlsx,.xls)</label
                                >
                                <input
                                    type="file"
                                    accept=".xlsx,.xls"
                                    class="form-control form-control-sm"
                                    id="file-fdr"
                                />
                            </div>
                            <div class="col-md-3">
                                <label for="file-clca" class="small text-secondary form-label">Commandes – CLCA</label>
                                <input
                                    type="file"
                                    accept=".xlsx,.xls"
                                    class="form-control form-control-sm"
                                    id="file-clca"
                                />
                            </div>
                            <div class="col-md-3">
                                <label for="file-balance" class="small text-secondary form-label">Balance EBLC</label>
                                <input
                                    type="file"
                                    accept=".xlsx,.xls"
                                    class="form-control form-control-sm"
                                    id="file-balance"
                                />
                            </div>
                            <div class="col-12 mt-2">
                                <button class="btn btn-sm w-100 btn-secondary" onclick="clearSavedData()">
                                    Réinitialiser fichiers
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="note">
                Les fichiers chargés (YCMCPT, YFDR, CLCA & EBCL) sont mémorisés dans le navigateur : vous n'avez
                normalement pas à les recharger à chaque ouverture de la page (sauf changement de poste / navigateur ou
                réinitialisation).<br />Utiliser un export <strong>YCMCPT</strong> par année d'exercice (un fichier par
                année), un export <strong>YFDR</strong> pour le fond de roulement, un export <strong>CLCA</strong> pour
                les commandes et un export <strong>EBLC</strong> pour la balance.
            </div>
            <section id="bloc-synthese">
                <div class="section-title">Vue synthétique de l'exécution</div>
                <div class="kpi-container">
                    <div class="kpi-card">
                        <div class="kpi-title">DÉPENSES – Budget global</div>
                        <div class="kpi-value" id="kpi-budget-dep">–</div>
                        <div class="kpi-sub">Saisi ou estimé à partir des données</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">DÉPENSES – Exécuté</div>
                        <div class="kpi-value" id="kpi-exec-dep">–</div>
                        <div class="kpi-sub" id="kpi-taux-dep">Taux d'exécution : –</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">RECETTES – Budget global</div>
                        <div class="kpi-value" id="kpi-budget-rec">–</div>
                        <div class="kpi-sub">Saisi ou estimé à partir des données</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">RECETTES – Réalisé</div>
                        <div class="kpi-value" id="kpi-exec-rec">–</div>
                        <div class="kpi-sub" id="kpi-taux-rec">Taux de réalisation : –</div>
                    </div>
                </div>
                <div class="kpi-container">
                    <div class="kpi-card">
                        <div class="kpi-title">DÉPENSES – Reste à consommer</div>
                        <div class="kpi-value" id="kpi-reste-dep">–</div>
                        <div class="kpi-sub" id="kpi-reste-dep-sub">Budget restant à consommer</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Avancement année vs exécution dépenses</div>
                        <div class="kpi-value" id="kpi-ecart-cal">–</div>
                        <div class="kpi-sub" id="kpi-ecart-cal-sub">Écart : –</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Concentration des dépenses (Top 5 comptes)</div>
                        <div class="kpi-value" id="kpi-top5">–</div>
                        <div class="kpi-sub" id="kpi-top5-sub">Poids des 5 premiers comptes de charges</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Évolution du FDR vs N-1</div>
                        <div class="kpi-value" id="kpi-delta-fdr">–</div>
                        <div class="kpi-sub" id="kpi-delta-fdr-sub">Var. du fond de roulement définitif</div>
                    </div>
                </div>
            </section>
            <section id="bloc-cumul">
                <div class="section-title">Cumul mensuel vs profil théorique</div>
                <div class="row-charts">
                    <div class="chart-container">
                        <h2>Cumul des dépenses (barres) & courbe théorique</h2>
                        <canvas id="chart-dep-cumul"></canvas>
                    </div>
                    <div class="chart-container">
                        <h2>Cumul des recettes (barres) & courbe théorique</h2>
                        <canvas id="chart-rec-cumul"></canvas>
                    </div>
                </div>
            </section>
            <section id="bloc-nature">
                <div class="section-title">Analyse par nature comptable (6 chiffres)</div>
                <div class="row-charts">
                    <div class="chart-container">
                        <h2>Analyse par nature – Dépenses (compte 6xxxxx)</h2>
                        <canvas id="chart-nature-dep"></canvas>
                    </div>
                    <div class="chart-container">
                        <h2>Analyse par nature – Recettes (compte 7xxxxx)</h2>
                        <canvas id="chart-nature-rec"></canvas>
                    </div>
                </div>
            </section>
            <section id="bloc-services">
                <div class="section-title">Analyse par service (AP, VE, ALO, SRH, OPC)</div>
                <div class="row-charts">
                    <div class="chart-container">
                        <h2>Dépenses par service – Mandaté / Engagé / Disponible</h2>
                        <canvas id="chart-services-dep"></canvas>
                    </div>
                    <div class="chart-container">
                        <h2>Recettes par service – Réalisé</h2>
                        <canvas id="chart-services-rec"></canvas>
                    </div>
                </div>
            </section>
            <section id="bloc-zoom-ap">
                <div class="section-title">Zoom pédagogique – Service AP</div>
                <div class="kpi-container">
                    <div class="kpi-card">
                        <div class="kpi-title">Dépenses AP mandatées</div>
                        <div class="kpi-value" id="zoom-ap-dep">–</div>
                        <div class="kpi-sub">Part des dépenses totales : <span id="zoom-ap-part-dep">–</span></div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Budget AP estimé</div>
                        <div class="kpi-value" id="zoom-ap-budget">–</div>
                        <div class="kpi-sub">Reste à consommer AP : <span id="zoom-ap-reste">–</span></div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Poids AP dans le budget</div>
                        <div class="kpi-value" id="zoom-ap-part-budget">–</div>
                        <div class="kpi-sub">Part du budget global affectée à AP (estimation)</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">AP vs autres services</div>
                        <div class="kpi-value" id="zoom-ap-ratio">–</div>
                        <div class="kpi-sub">Dépenses AP / moyenne des autres services</div>
                    </div>
                </div>
            </section>
            <section id="bloc-zoom-srh">
                <div class="section-title">Focus SRH – Service restauration & hébergement</div>
                <div class="kpi-container">
                    <div class="kpi-card">
                        <div class="kpi-title">Dépenses SRH mandatées</div>
                        <div class="kpi-value" id="zoom-srh-dep">–</div>
                        <div class="kpi-sub">Part des dépenses totales : <span id="zoom-srh-part-dep">–</span></div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Recettes SRH réalisées</div>
                        <div class="kpi-value" id="zoom-srh-rec">–</div>
                        <div class="kpi-sub">
                            Taux de couverture des charges : <span id="zoom-srh-taux-couv">–</span>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Résultat SRH (recettes – dépenses)</div>
                        <div class="kpi-value" id="zoom-srh-resultat">–</div>
                        <div class="kpi-sub">Excédent / déficit SRH sur l'exercice sélectionné</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Lecture rapide</div>
                        <div class="kpi-sub">
                            Si les <strong>courbes SRH</strong> de recettes restent sous celles des dépenses sur
                            plusieurs mois, envisager une intensification des campagnes de recettage (relances familles,
                            bourses, facturation hébergement…).
                        </div>
                    </div>
                </div>
                <div class="row-charts">
                    <div class="chart-container">
                        <h2>SRH – Dépenses vs recettes (exercice en cours)</h2>
                        <canvas id="chart-srh-dep-rec"></canvas>
                    </div>
                    <div class="chart-container">
                        <h2>SRH – rythme mensuel dépenses / recettes</h2>
                        <canvas id="chart-srh-mensuel"></canvas>
                        <p class="note" style="margin-top: 6px">
                            Objectif : visualiser le rythme des dépenses et des recettes SRH par mois pour ajuster les
                            campagnes de recettage (facturations, relances, échéanciers).
                        </p>
                    </div>
                </div>
            </section>
            <section id="bloc-fdr">
                <div class="section-title">Fond de roulement, CAF et coût journalier</div>
                <div class="row-charts fdr-row">
                    <div class="chart-container">
                        <h2>Fond de roulement – valeurs définitives (CF)</h2>
                        <canvas id="chart-fdr"></canvas>
                        <p class="note" style="margin-top: 8px">
                            La courbe représente le fond de roulement <strong>définitif</strong> par exercice (valeurs
                            marquées « D » dans le fichier YFDR).
                        </p>
                    </div>
                    <div class="chart-container fdr-side-panel">
                        <div class="kpi-title" id="fdr-year-label">Exercice –</div>
                        <div class="kpi-value" id="fdr-val">FDR : –</div>
                        <div class="kpi-sub" id="fdr-cj">Coût journalier de l'établissement : –</div>
                        <div class="kpi-sub" id="fdr-days">Nombre de jours de FDR : –</div>
                        <div class="kpi-sub" id="fdr-caf">CAF / IAF : –</div>
                        <div class="kpi-sub" id="fdr-info" style="margin-top: 10px"></div>
                    </div>
                </div>
            </section>
            <section id="bloc-fdr-bfdr" class="mt-3">
                <div class="section-title">Fonds de roulement, BFdR et trésorerie nette</div>
                <div class="g-3 row">
                    <div class="col-md-4">
                        <div class="kpi-card card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Fonds de roulement (FDR)</h5>
                                <p class="kpi-value" id="kpi-fdr-valeur">–</p>
                                <p class="small kpi-subtext text-muted" id="kpi-fdr-detail">
                                    Valeur calculée pour l'exercice sélectionné.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="kpi-card card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Besoin en fonds de roulement (BFdR)</h5>
                                <p class="kpi-value" id="kpi-bfdr-valeur">–</p>
                                <p class="small kpi-subtext text-muted" id="kpi-bfdr-detail">
                                    Actif circulant – dettes d'exploitation et hors exploitation.
                                </p>
                                <div class="mt-1">
                                    <span class="badge bg-secondary rounded-pill" id="kpi-bfdr-badge">En analyse</span>
                                </div>
                                <p class="small kpi-subtext text-muted mt-1" id="kpi-bfdr-diagnostic">
                                    Le diagnostic sera calculé après import de la balance.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="kpi-card card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Jours de Fonds de roulement</h5>
                                <p class="kpi-value" id="kpi-jours-fdr">–</p>
                                <p class="small kpi-subtext text-muted">
                                    (FDR / charges nettes 60 à 65 hors 656) × 360.
                                </p>
                                <div class="mt-1">
                                    <span class="badge bg-secondary rounded-pill" id="kpi-jours-fdr-badge"
                                        >En analyse</span
                                    >
                                </div>
                                <p class="small kpi-subtext text-muted mt-1" id="kpi-jours-fdr-diagnostic">
                                    Le diagnostic sera calculé après import de la balance.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-1 g-3 row">
                    <div class="col-md-3">
                        <div class="kpi-card card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Jours de trésorerie</h5>
                                <p class="kpi-value" id="kpi-jours-tresorerie">–</p>
                                <p class="small kpi-subtext text-muted">
                                    (Trésorerie / charges nettes 60 à 65 hors 656) × 360.
                                </p>
                                <div class="mt-1">
                                    <span class="badge bg-secondary rounded-pill" id="kpi-jours-tn-badge"
                                        >En analyse</span
                                    >
                                </div>
                                <p class="small kpi-subtext text-muted mt-1" id="kpi-jours-tn-diagnostic">
                                    Le diagnostic sera calculé après import de la balance.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="kpi-card card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Trésorerie nette</h5>
                                <p class="kpi-value" id="kpi-tresorerie-nette">–</p>
                                <p class="small kpi-subtext text-muted">Trésorerie nette = FDR – BFdR.</p>
                                <div class="mt-1">
                                    <span class="badge bg-secondary rounded-pill" id="kpi-tn-badge">En analyse</span>
                                </div>
                                <p class="small kpi-subtext text-muted mt-1" id="kpi-tn-diagnostic">
                                    Le diagnostic sera calculé après import de la balance.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="kpi-card card h-100">
                            <div class="card-body">
                                <h5 class="card-title">TmCAP – Taux de charges à payer</h5>
                                <p class="kpi-value" id="kpi-tmcap">–</p>
                                <p class="small kpi-subtext text-muted">
                                    (4081, 4282/4286, 4382/4386, 4686) / charges 60 à 65.
                                </p>
                                <div class="mt-1">
                                    <span class="badge bg-secondary rounded-pill" id="kpi-tmcap-badge">En analyse</span>
                                </div>
                                <p class="small kpi-subtext text-muted mt-1" id="kpi-tmcap-diagnostic">
                                    Le diagnostic sera calculé après import de la balance.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="kpi-card card h-100">
                            <div class="card-body">
                                <h5 class="card-title">TnR – Taux de non-recouvrement</h5>
                                <p class="kpi-value" id="kpi-tnr">–</p>
                                <p class="small kpi-subtext text-muted">(Compte 41 / produits du compte 70) × 100.</p>
                                <div class="mt-1">
                                    <span class="badge bg-secondary rounded-pill" id="kpi-tnr-badge">En analyse</span>
                                </div>
                                <p class="small kpi-subtext text-muted mt-1" id="kpi-tnr-diagnostic">
                                    Le diagnostic sera calculé après import de la balance.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="bloc-clca">
                <div class="section-title">Commandes (CLCA) – Synthèse & graphiques</div>
                <div class="kpi-container">
                    <div class="kpi-card">
                        <div class="kpi-title">Commandes CLCA (exercice sélectionné)</div>
                        <div class="kpi-value" id="kpi-clca-nb">–</div>
                        <div class="kpi-sub">Nombre de commandes (N° commande distincts)</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Montant total facturé TTC</div>
                        <div class="kpi-value" id="kpi-clca-montant">–</div>
                        <div class="kpi-sub">Somme des montants facturés TTC des lignes CLCA</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Fournisseur principal</div>
                        <div class="kpi-value" id="kpi-clca-top-fourn">–</div>
                        <div class="kpi-sub" id="kpi-clca-top-fourn-sub">Part dans le total des montants facturés</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Service le plus consommateur</div>
                        <div class="kpi-value" id="kpi-clca-service">–</div>
                        <div class="kpi-sub" id="kpi-clca-service-sub">
                            Répartition par service (AP, VE, ALO, SRH, OPC)
                        </div>
                    </div>
                </div>
                <div class="row-charts">
                    <div class="chart-card">
                        <div class="chart-title">Commandes par mois</div>
                        <canvas id="chart-clca-cmd-month"></canvas>
                        <div class="chart-sub">Nombre de commandes (N° commande) par mois civil.</div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Top 10 fournisseurs – Montants facturés TTC</div>
                        <canvas id="chart-clca-top-fourn"></canvas>
                        <div class="chart-sub">
                            Total des montants facturés TTC, du plus important au moins important.
                        </div>
                    </div>
                </div>
                <div class="row-charts">
                    <div class="chart-card">
                        <div class="chart-title">Répartition des montants par service</div>
                        <canvas id="chart-clca-services"></canvas>
                        <div class="chart-sub">
                            Total des montants facturés TTC par service (AP, VE, ALO, SRH, OPC, Autres).
                        </div>
                    </div>
                </div>
            </section>
            <div class="fade modal" id="helpModal" aria-labelledby="helpModalLabel" aria-hidden="true" tabindex="-1">
                <div class="modal-dialog modal-dialog-scrollable modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="helpModalLabel">
                                Mode d'emploi – Tableau de bord exécution budgétaire
                            </h5>
                            <button
                                class="btn-close"
                                type="button"
                                data-bs-dismiss="modal"
                                aria-label="Fermer"
                            ></button>
                        </div>
                        <div class="modal-body">
                            <h6>1. Fichiers à fournir</h6>
                            <p>
                                <strong>a) Export YCMCPT (Op@le)</strong> – Un fichier <em>par année d'exercice</em> :
                            </p>
                            <ul>
                                <li>Type d'état : <strong>YCMCPT</strong> (mouvements comptables).</li>
                                <li>
                                    Colonnes indispensables :
                                    <ul>
                                        <li><code>Date comptable</code> (format jj/mm/aaaa)</li>
                                        <li><code>Compte</code> (classe 6 et 7)</li>
                                        <li><code>Libellé du compte</code></li>
                                        <li><code>Montant débit</code> et <code>Montant crédit</code></li>
                                        <li>
                                            <code>CGR A</code> : chaîne concaténée
                                            <em>« service  domaine  activité »</em> avec au moins deux espaces entre
                                            chaque bloc
                                        </li>
                                    </ul>
                                </li>
                                <li>Dépenses : comptes <strong>6xxxxx</strong> (montant débit).</li>
                                <li>Recettes : comptes <strong>7xxxxx</strong> (montant crédit).</li>
                            </ul>
                            <p><strong>b) Export YFDR</strong> – Fonds de roulement :</p>
                            <ul>
                                <li>1ʳᵉ colonne : date de l'exercice (exemple : <code>01/2025</code> → année 2025)</li>
                                <li>2ᵉ colonne : montant de fonds de roulement</li>
                                <li>
                                    3ᵉ colonne : indicateur :
                                    <ul>
                                        <li><code>D</code> = valeur définitive validée par le compte financier</li>
                                        <li>autre / vide = valeur intermédiaire (non utilisée pour la courbe)</li>
                                    </ul>
                                </li>
                            </ul>
                            <p><strong>c) Export CLCA (Op@le)</strong> – Trésorerie / comptes bancaires :</p>
                            <ul>
                                <li>Type d'état : <strong>CLCA</strong> (situation des comptes de trésorerie).</li>
                                <li>
                                    Colonnes indispensables :
                                    <ul>
                                        <li><code>Compte</code> (classe 5 : banques, caisse, régies...)</li>
                                        <li><code>Libellé du compte</code></li>
                                        <li><code>Solde débit</code> et <code>Solde crédit</code></li>
                                    </ul>
                                </li>
                                <li>
                                    Les soldes de trésorerie sont utilisés pour rapprocher la trésorerie nette et
                                    analyser la structure des liquidités.
                                </li>
                            </ul>
                            <p>
                                <strong>d) Balance générale (EBLC)</strong> – Calcul FdR, BFdR, trésorerie nette et
                                ratios :
                            </p>
                            <ul>
                                <li>État souhaité : <strong>EBLC</strong> (balance comptable complète).</li>
                                <li>Format recommandé : <strong>Excel (.xlsx)</strong></li>
                                <li>
                                    Colonnes indispensables :
                                    <ul>
                                        <li><code>Numéro de compte</code> (toutes classes 1 à 7)</li>
                                        <li><code>Libellé du compte</code></li>
                                        <li>
                                            <code>Soldes débit</code> et <code>Soldes crédit</code> en fin d'exercice
                                        </li>
                                    </ul>
                                </li>
                                <li>
                                    Ces soldes servent au calcul automatique du FdR, BFdR, trésorerie nette, jours de
                                    FdR / trésorerie, TmCAP et TnR.
                                </li>
                                <li>
                                    Pour avoir la version excel :
                                    <ul>
                                        <li>Cliquer sur transactions liées,</li>
                                        <li>Sélectionner <strong>GTPARTRT</strong>,</li>
                                        <li>Cliquer sur "Mise en forme"</li>
                                        <li>Sélectionner "EBLC Excel"</li>
                                    </ul>
                                </li>
                            </ul>
                            <h6>2. Fonctionnement général</h6>
                            <ul>
                                <li>
                                    Les fichiers chargés sont
                                    <strong>mémorisés dans le navigateur</strong> (localStorage).
                                </li>
                                <li>
                                    Au prochain accès à la page, les données sont rechargées automatiquement (sauf si
                                    vous avez vidé le cache / changé de navigateur ou utilisé « Réinitialiser fichiers
                                    »).
                                </li>
                                <li>
                                    Les ancres en haut de page permettent de se rendre directement sur :
                                    <em>Vue synthétique</em>, <em>Cumul mensuel</em>, <em>Natures</em>,
                                    <em>Services</em>, <em>Zoom AP</em>, <em>Zoom SRH</em>, <em>FDR & CAF</em>.
                                </li>
                            </ul>
                            <h6>3. Fond de roulement, coût journalier et CAF</h6>
                            <ul>
                                <li>
                                    <strong>Coût journalier CJ</strong> par année :<br /><code
                                        >CJ(année) = Σ comptes 60x à 65x (débits)</code
                                    >
                                </li>
                                <li>
                                    <strong>Coût journalier par jour</strong> (exercice sélectionné) :<br /><code
                                        >CJ / 360</code
                                    >
                                </li>
                                <li>
                                    <strong>Nombre de jours de FDR</strong> :<br /><code
                                        >Jours FDR = FDR × 360 / CJ</code
                                    >
                                </li>
                                <li>
                                    <strong>Capacité d'autofinancement (CAF)</strong> (approche simplifiée à partir des
                                    mouvements) :<br /><code
                                        >Résultat = Σ produits (classe 7) – Σ charges (classe 6)</code
                                    ><br /><code>Charges calculées ≈ Σ comptes 68x</code><br /><code
                                        >Produits calculés ≈ Σ comptes 78x</code
                                    ><br /><code
                                        >CAF = Résultat + Charges calculées – Produits calculés + Σ675 – Σ775</code
                                    ><br /><em
                                        >Si la CAF est négative, on parle d'IAF (insuffisance d'autofinancement).</em
                                    >
                                </li>
                            </ul>
                            <h6>4. KPI de pilotage</h6>
                            <ul>
                                <li>
                                    <strong>Reste à consommer (dépenses)</strong> : Budget dépenses – Dépenses
                                    exécutées.
                                </li>
                                <li>
                                    <strong>Avancement calendaire vs exécution</strong> : % d'année écoulée (mois du
                                    dernier mouvement) vs % du budget dépensé.
                                </li>
                                <li>
                                    <strong>Concentration des dépenses</strong> : poids des 5 principaux comptes de
                                    charges (6xxxxx) dans le total des dépenses.
                                </li>
                                <li>
                                    <strong>Évolution du FDR vs N-1</strong> : variation du fond de roulement définitif
                                    d'une année sur l'autre.
                                </li>
                                <li>
                                    <strong>Zoom pédagogique (AP)</strong> : niveau et poids des dépenses AP, estimation
                                    de budget AP et reste à consommer, comparaison AP / autres services.
                                </li>
                            </ul>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Fenêtre (modal) pour préparer la demande -->
            <div class="fade modal" id="issueModal" aria-labelledby="issueModalLabel" aria-hidden="true" tabindex="-1">
                <div class="modal-dialog modal-dialog-scrollable modal-lg">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title" id="issueModalLabel">
                                Signaler un problème / Demander une évolution
                            </h5>
                            <button
                                class="btn-close"
                                type="button"
                                data-bs-dismiss="modal"
                                aria-label="Fermer"
                            ></button>
                        </div>

                        <div class="modal-body">

                            <div class="mb-3">
                                <label for="issueType" class="form-label">Type de demande :</label>
                                <select id="issueType" class="form-select">
                                    <option value="bug">Bug – Quelque chose ne fonctionne pas</option>
                                    <option value="documentation">Documentation – Amélioration ou ajout</option>
                                    <option value="enhancement">Évolution – Nouvelle fonctionnalité ou demande</option>
                                    <option value="help wanted">Aide souhaitée – Un coup de main est nécessaire</option>
                                    <option value="invalid">Non valide – Cela ne semble pas correct</option>
                                    <option value="question">Question – Informations complémentaires demandées</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="issueTitle" class="form-label">Titre :</label>
                                <input id="issueTitle" type="text" class="form-control" placeholder="Titre court de votre demande" />
                            </div>

                            <div class="mb-3">
                                <label for="issueDescription" class="form-label">Description :</label>
                                <textarea id="issueDescription" class="form-control" style="height:180px;"
                                    placeholder="Décrivez le contexte, les étapes pour reproduire, le résultat attendu..."
                                ></textarea>
                            </div>

                        </div>

                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                            <button class="btn btn-primary" id="sendIssueMailBtn">Envoyer la demande</button>
                        </div>

                    </div>
                </div>
            </div>
            <div id="backToTop" onclick='window.scrollTo({top:0,behavior:"smooth"})'>↑ Haut de page</div>
        </div>
        <div class="fade tab-pane" id="tab-explo" aria-labelledby="tab-explo-tab" role="tabpanel">
            <header class="mb-2 app-header px-4 py-3">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                    <div>
                        <div class="small text-secondary fw-semibold text-uppercase">Pilotage Op@le</div>
                        <h1 class="mb-0 text-white h4">Explorateur Dépenses / Recettes – Sunburst & Waterfall</h1>
                    </div>
                    <div class="d-flex align-items-center flex-wrap gap-2">
                        <div class="badge-palette">
                            <span class="badge-color-dot" style="background: var(--col-accent)"></span> Dépenses
                            (OBCHCGB)
                        </div>
                        <div class="badge-palette">
                            <span class="badge-color-dot" style="background: var(--col-accent-2)"></span> Recettes
                            (OBCHPOB)
                        </div>
                        <button class="btn btn-sm btn-outline-danger ms-2" type="button" @click="clearStorage()">
                            Vider le cache local
                        </button>
                    </div>
                </div>
            </header>
            <div class="container-fluid">
                <div class="p-3 mb-3 surface-alt">
                    <button
                        class="d-flex align-items-center justify-content-between btn btn-outline-secondary btn-sm w-100"
                        type="button"
                        data-bs-target="#collapse-obch"
                        data-bs-toggle="collapse"
                        aria-expanded="false"
                    >
                        <span>Imports OBCH – Dépenses & Recettes</span>
                        <span class="ms-2"><i class="bi bi-chevron-down"></i></span>
                    </button>
                    <div class="mt-3 collapse" id="collapse-obch">
                        <div class="g-3 row align-items-end">
                            <div class="col-md-4">
                                <label class="small text-secondary form-label">Dépenses – OBCHCGB (.xlsx)</label>
                                <input
                                    type="file"
                                    accept=".xlsx"
                                    class="form-control form-control-sm bg-dark border-secondary text-light"
                                    @change="handleFileDep($event)"
                                />
                                <div class="text-secondary form-text">Export <strong>OBCHCGB</strong> (dépenses).</div>
                            </div>
                            <div class="col-md-4">
                                <label class="small text-secondary form-label">Recettes – OBCHPOB (.xlsx)</label>
                                <input
                                    type="file"
                                    accept=".xlsx"
                                    class="form-control form-control-sm bg-dark border-secondary text-light"
                                    @change="handleFileRec($event)"
                                />
                                <div class="text-secondary form-text">Export <strong>OBCHPOB</strong> (recettes).</div>
                            </div>
                            <div class="small text-secondary col-md-4">
                                <strong>Comportement :</strong><br />• Données mémorisées en
                                <code>localStorage</code>.<br />• Les filtres <strong>dépenses</strong> lient
                                <em>Sunburst Dépenses</em> et <em>Waterfall Dépenses</em>.<br />• Les filtres
                                <strong>recettes</strong> lient <em>Sunburst Recettes</em> et
                                <em>Waterfall Recettes</em>.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="g-3 row">
                    <div class="col-md-6">
                        <div class="d-flex flex-column h-100 p-3 surface">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div>
                                    <h2 class="mb-0 text-white h6">Dépenses – OBCHCGB</h2>
                                    <div class="small text-secondary">Sunburst & Waterfall liés (base dépenses)</div>
                                </div>
                            </div>
                            <div class="d-flex flex-wrap gap-3 align-items-end mb-3">
                                <div class="ms-auto">
                                    <button
                                        class="btn btn-sm btn-outline-light"
                                        type="button"
                                        @click="resetDepFilters()"
                                    >
                                        Réinit. dépenses
                                    </button>
                                </div>
                            </div>
                            <div class="d-flex flex-column flex-grow-1">
                                <div class="small text-secondary mb-1">Sunburst Dépenses</div>
                                <div class="sunburst-wrapper"><svg class="sunburst-svg" id="sunburstDep"></svg></div>
                                <div class="small text-secondary mt-1">
                                    Cliquez sur un nœud pour focaliser le waterfall sur son sous-arbre (cliquez à
                                    nouveau pour revenir au global).
                                </div>
                                <div class="small align-items-center d-flex justify-content-between mt-3">
                                    <span class="text-secondary">Waterfall Dépenses</span>
                                    <span class="text-info" x-text="focusDepLabel"></span>
                                </div>
                                <div class="waterfall-wrapper"><svg class="waterfall-svg" id="waterfallDep"></svg></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex flex-column h-100 p-3 surface">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div>
                                    <h2 class="mb-0 text-white h6">Recettes – OBCHPOB</h2>
                                    <div class="small text-secondary">Sunburst & Waterfall liés (base recettes)</div>
                                </div>
                            </div>
                            <div class="d-flex flex-wrap gap-3 align-items-end mb-3">
                                <div class="ms-auto">
                                    <button
                                        class="btn btn-sm btn-outline-light"
                                        type="button"
                                        @click="resetRecFilters()"
                                    >
                                        Réinit. recettes
                                    </button>
                                </div>
                            </div>
                            <div class="d-flex flex-column flex-grow-1">
                                <div class="small text-secondary mb-1">Sunburst Recettes</div>
                                <div class="sunburst-wrapper"><svg class="sunburst-svg" id="sunburstRec"></svg></div>
                                <div class="small text-secondary mt-1">Root : REC → RECETTES / OS-REC → comptes.</div>
                                <div class="small align-items-center d-flex justify-content-between mt-3">
                                    <span class="text-secondary">Waterfall Recettes</span>
                                    <span class="text-info" x-text="focusRecLabel"></span>
                                </div>
                                <div class="waterfall-wrapper"><svg class="waterfall-svg" id="waterfallRec"></svg></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="fade tab-pane" id="tab-toolbox" aria-labelledby="tab-toolbox-tab" role="tabpanel">
            <div class="toolbox-root">
                <div class="config-message" id="configMessage"></div>
                <button class="config-button" id="configButton">Configurer</button>
                <ul class="mt-3 nav nav-tabs" id="toolboxTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button
                            class="nav-link active"
                            type="button"
                            data-bs-target="#clca"
                            data-bs-toggle="tab"
                            aria-controls="clca"
                            aria-selected="true"
                            id="clca-tab"
                            role="tab"
                        >
                            CLCA
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button
                            class="nav-link"
                            type="button"
                            data-bs-target="#ygpie1"
                            data-bs-toggle="tab"
                            aria-controls="ygpie1"
                            aria-selected="false"
                            id="ygpie1-tab"
                            role="tab"
                        >
                            YGPIE1
                        </button>
                    </li>
                </ul>
                <div class="mt-3 tab-content" id="toolboxTabsContent">
                    <div class="fade tab-pane active show" id="clca" aria-labelledby="clca-tab" role="tabpanel">
                        <div class="container">
                            <h1>Génération d'un tableau de dépenses par CGR pour joindre à un TR</h1>
                            <form id="uploadForm">
                                <div class="form-group">
                                    <label for="fileInput">Importer l'export d'Op@le CLCA:</label>
                                    <div class="input-container">
                                        <input
                                            type="file"
                                            accept=".xlsx"
                                            id="fileInput"
                                            name="file"
                                            required
                                        /><datalist id="cgrOptions"></datalist>
                                    </div>
                                </div>
                                <button type="submit" id="generateButton">Générer le tableau</button>
                            </form>
                            <button class="download-button" id="downloadButtonCLCA">Télécharger le fichier</button>
                            <div class="file-content" id="fileContent"></div>
                            <pre class="table-preview-container" id="previewCLCA"></pre>
                        </div>
                    </div>
                    <div class="fade tab-pane" id="ygpie1" aria-labelledby="ygpie1-tab" role="tabpanel">
                        <div class="container">
                            <h1>YGPIE1</h1>
                            <form id="ygpie1UploadForm">
                                <div class="form-group">
                                    <label for="ygpie1FileInput">Importer l'export d'Op@le YGPIE1:</label>
                                    <input
                                        type="file"
                                        accept=".xlsx"
                                        id="ygpie1FileInput"
                                        multiple
                                        name="file"
                                        required
                                    />
                                </div>
                                <div class="radio-group">
                                    <label
                                        ><input type="radio" name="ygpie1Option" required value="rapprocher" />
                                        Rapprocher des écritures par tiers (crédits et débits égaux)</label
                                    >
                                    <label
                                        ><input type="radio" name="ygpie1Option" required value="prises_en_charge" />
                                        Prises en charges par tiers (crédits et débits inégaux)</label
                                    >
                                    <label
                                        ><input
                                            type="radio"
                                            name="ygpie1Option"
                                            required
                                            value="prises_en_charge_associes"
                                        />
                                        Prises en charges par tiers associés (crédits et débits inégaux)</label
                                    >
                                    <label
                                        ><input type="radio" name="ygpie1Option" required value="aide_compensation" />
                                        Aide compensation agence comptable</label
                                    >
                                </div>
                                <button type="submit">Générer le tableau</button>
                            </form>
                            <button class="download-button" id="downloadButton">Télécharger le fichier</button>
                            <div class="file-content" id="ygpie1FileContent"></div>
                            <div class="table-preview-container" id="previewYGPIE1"></div>
                        </div>
                    </div>
                </div>
                <div class="popup" id="cgrPopup">
                    <div class="popup-content">
                        <span class="close" id="closeCgrPopup">×</span>
                        <h2>Sélectionner un CGR</h2>
                        <form id="cgrForm">
                            <div class="form-group">
                                <label for="cgrSelect"
                                    >Tapez les premiers caractères du CGR ou cliquez pour afficher la liste
                                    déroulante:</label
                                >
                                <div class="form-control">
                                    <div class="input-container">
                                        <input
                                            name="cgrSelect"
                                            required
                                            id="cgrSelect"
                                            list="cgrOptions"
                                            placeholder="Rechercher un CGR..."
                                        />
                                        <span class="clear-button" id="clearCgrSelect">×</span
                                        ><datalist id="cgrOptions"></datalist>
                                    </div>
                                </div>
                            </div>
                            <button type="submit">Sélectionner</button>
                        </form>
                    </div>
                </div>
                <div class="popup" id="popup">
                    <div class="popup-content">
                        <span class="close" id="closePopup">×</span>
                        <h2>Configuration</h2>
                        <form id="configForm">
                            <div class="form-group">
                                <label for="etablissement">Établissement:</label>
                                <input name="etablissement" required id="etablissement" />
                            </div>
                            <div class="form-group">
                                <label for="chefEtablissement">Chef d'établissement:</label>
                                <input name="chefEtablissement" required id="chefEtablissement" />
                            </div>
                            <button type="submit">Enregistrer</button>
                            <button type="button" id="deleteConfig">Supprimer</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===================== ONGLET 3 : TOOLBOX ===================== -->
        <!-- https://blogacabdx.ac-bordeaux.fr/opalefaq/2025/01/30/boite-a-outils-ople/ -->
        <div
            class="tab-pane fade"
            id="tab-toolbox"
            role="tabpanel"
            aria-labelledby="tab-toolbox-tab"
        >
            <div class="toolbox-root">
                <div class="config-message" id="configMessage"></div>
                <button class="config-button" id="configButton">Configurer</button>

                <!-- Sous-onglets Bootstrap -->
                <ul class="nav nav-tabs mt-3" id="toolboxTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button
                            class="nav-link active"
                            id="clca-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#clca"
                            type="button"
                            role="tab"
                            aria-controls="clca"
                            aria-selected="true"
                        >
                            CLCA
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button
                            class="nav-link"
                            id="ygpie1-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#ygpie1"
                            type="button"
                            role="tab"
                            aria-controls="ygpie1"
                            aria-selected="false"
                        >
                            YGPIE1
                        </button>
                    </li>
                </ul>

                <!-- Contenu des sous-onglets -->
                <div class="tab-content mt-3" id="toolboxTabsContent">
                    <!-- Onglet CLCA -->
                    <div
                        class="tab-pane fade show active"
                        id="clca"
                        role="tabpanel"
                        aria-labelledby="clca-tab"
                    >
                        <div class="container">
                            <h1>Génération d'un tableau de dépenses par CGR pour joindre à un TR</h1>
                            <form id="uploadForm">
                                <div class="form-group">
                                    <label for="fileInput">Importer l'export d'Op@le CLCA:</label>
                                    <div class="input-container">
                                        <input
                                            id="fileInput"
                                            name="file"
                                            type="file"
                                            accept=".xlsx"
                                            required
                                        />
                                        <datalist id="cgrOptions"></datalist>
                                    </div>
                                </div>
                                <button id="generateButton" type="submit">
                                    Générer le tableau
                                </button>
                            </form>
                            <button class="download-button" id="downloadButtonCLCA">
                                Télécharger le fichier
                            </button>
                            <div class="file-content" id="fileContent"></div>
                            <pre id="previewCLCA" class="table-preview-container"></pre>
                        </div>
                    </div>

                    <!-- Onglet YGPIE1 -->
                    <div
                        class="tab-pane fade"
                        id="ygpie1"
                        role="tabpanel"
                        aria-labelledby="ygpie1-tab"
                    >
                        <div class="container">
                            <h1>YGPIE1</h1>
                            <form id="ygpie1UploadForm">
                                <div class="form-group">
                                    <label for="ygpie1FileInput">Importer l'export d'Op@le YGPIE1:</label>
                                    <input
                                        id="ygpie1FileInput"
                                        name="file"
                                        type="file"
                                        accept=".xlsx"
                                        multiple
                                        required
                                    />
                                </div>

                                <div class="radio-group">
                                    <label>
                                        <input
                                            type="radio"
                                            name="ygpie1Option"
                                            value="rapprocher"
                                            required
                                        />
                                        Rapprocher des écritures par tiers (crédits et débits égaux)
                                    </label>
                                    <label>
                                        <input
                                            type="radio"
                                            name="ygpie1Option"
                                            value="prises_en_charge"
                                            required
                                        />
                                        Prises en charges par tiers (crédits et débits inégaux)
                                    </label>
                                    <label>
                                        <input
                                            type="radio"
                                            name="ygpie1Option"
                                            value="prises_en_charge_associes"
                                            required
                                        />
                                        Prises en charges par tiers associés (crédits et débits inégaux)
                                    </label>
                                    <label>
                                        <input
                                            type="radio"
                                            name="ygpie1Option"
                                            value="aide_compensation"
                                            required
                                        />
                                        Aide compensation agence comptable
                                    </label>
                                </div>

                                <button type="submit">Générer le tableau</button>
                            </form>

                            <button class="download-button" id="downloadButton">
                                Télécharger le fichier
                            </button>
                            <div class="file-content" id="ygpie1FileContent"></div>
                            <div id="previewYGPIE1" class="table-preview-container"></div>
                        </div>
                    </div>
                </div>

                <!-- Popups (inchangées) -->
                <div class="popup" id="cgrPopup">
                    <div class="popup-content">
                        <span class="close" id="closeCgrPopup">×</span>
                        <h2>Sélectionner un CGR</h2>
                        <form id="cgrForm">
                            <div class="form-group">
                                <label for="cgrSelect">
                                    Tapez les premiers caractères du CGR ou cliquez pour afficher la liste déroulante:
                                </label>
                                <div class="form-control">
                                    <div class="input-container">
                                        <input
                                            id="cgrSelect"
                                            name="cgrSelect"
                                            type="text"
                                            list="cgrOptions"
                                            placeholder="Rechercher un CGR..."
                                            required
                                        />
                                        <span class="clear-button" id="clearCgrSelect">×</span>
                                        <datalist id="cgrOptions"></datalist>
                                    </div>
                                </div>
                            </div>
                            <button type="submit">Sélectionner</button>
                        </form>
                    </div>
                </div>

                <div class="popup" id="popup">
                    <div class="popup-content">
                        <span class="close" id="closePopup">×</span>
                        <h2>Configuration</h2>
                        <form id="configForm">
                            <div class="form-group">
                                <label for="etablissement">Établissement:</label>
                                <input
                                    id="etablissement"
                                    name="etablissement"
                                    type="text"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label for="chefEtablissement">Chef d'établissement:</label>
                                <input
                                    id="chefEtablissement"
                                    name="chefEtablissement"
                                    type="text"
                                    required
                                />
                            </div>
                            <button type="submit">Enregistrer</button>
                            <button id="deleteConfig" type="button">Supprimer</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ----------- TIMELINE ----------- -->
        <div class="fade tab-pane" id="tab-calendar" aria-labelledby="tab-calendar-tab" role="tabpanel">
            <h2>Calendrier budgétaire EPLE</h2>
            <p>
                Cycle type pour un budget d’EPLE (année N) – d’après le document « Les documents budgétaires d’un EPLE »
                (MEN DGESCO-DAF).
            </p>
            <div class="budget-timeline-wrapper">
                <ul class="htimeline">
                    <li class="step" data-date="09-01">
                        <div class="step-title">Septembre (N-1)</div>
                        <div class="step-desc">
                            Définition des priorités de l’établissement : analyse des besoins pédagogiques, vie
                            scolaire, maintenance, projets, investissements. Cadrage stratégique du CE et articulation
                            avec le projet d’établissement.
                        </div>
                    </li>
                    <li class="step" data-date="10-01">
                        <div class="step-title">Octobre (N-1)</div>
                        <div class="step-desc">
                            Recueil consolidé des besoins auprès des coordonnateurs, équipes pédagogiques, personnels
                            techniques, service gestion, agent comptable. Évaluation financière prévisionnelle des
                            demandes.
                        </div>
                    </li>
                    <li class="step" data-date="11-15">
                        <div class="step-title">Mi-novembre (N-1)</div>
                        <div class="step-desc">
                            Notification des dotations par la collectivité et l’État. Arbitrages internes, priorisation,
                            rédaction du projet de budget et des annexes réglementaires. Préparation du dossier CA.
                        </div>
                    </li>
                    <li class="step" data-date="12-01">
                        <div class="step-title">Début décembre (N-1)</div>
                        <div class="step-desc">
                            Conseil d’administration : présentation, débat et vote du budget. Ajustements éventuels.
                            Transmission aux autorités de contrôle (collectivité + DSDEN).
                        </div>
                    </li>
                    <li class="step" data-date="01-01">
                        <div class="step-title">1er janvier (N)</div>
                        <div class="step-desc">
                            Début de l’exécution budgétaire. Ouverture des crédits. Lancement des engagements, services
                            faits, OR, mandats. Mise en œuvre des lignes budgétaires dans Op@le.
                        </div>
                    </li>
                    <li class="step" data-date="04-30">
                        <div class="step-title">30 avril (N+1)</div>
                        <div class="step-desc">
                            Conseil d’administration : vote du compte financier. Analyse des recettes, dépenses, FDR,
                            BFDR, trésorerie, TmCAP et TnR. Présentation par l’agent comptable et le chef
                            d’établissement.
                        </div>
                    </li>
                    <li class="step" data-date="06-15">
                        <div class="step-title">Mi-juin (N+1)</div>
                        <div class="step-desc">
                            Rapport annuel au CA : bilan pédagogique, matériel et financier. Retour sur l’exécution,
                            performance du budget, indicateurs, propositions d’amélioration.
                        </div>
                    </li>
                    <li class="step" data-date="08-31">
                        <div class="step-title">Fin août (N+1)</div>
                        <div class="step-desc">
                            Fin du cycle budgétaire. Préparation du cycle suivant : analyse de l’exécution réelle, mise
                            à jour des besoins récurrents, prévisions de charges, planification pluriannuelle.
                        </div>
                    </li>
                </ul>
                <div id="today-marker">
                    <span class="today-dot"></span> <span class="today-label">Aujourd'hui</span>
                </div>
            </div>
            <h3 style="margin-top: 1.5rem">Références utiles</h3>
            <ul>
                <li>
                    <a href="http://eduscol.education.fr" rel="noopener noreferrer" target="_blank"
                        >Eduscol – Ressources sur les documents budgétaires</a
                    >
                </li>
                <li>
                    <a
                        href="https://www.legifrance.gouv.fr/codes/article_lc/LEGIARTI000018380640/"
                        rel="noopener noreferrer"
                        target="_blank"
                        >Code de l’éducation – Article R.421-58 (Structure du budget)</a
                    >
                </li>
                <li>
                    <a
                        href="https://www.legifrance.gouv.fr/codes/article_lc/LEGIARTI000018380786/"
                        rel="noopener noreferrer"
                        target="_blank"
                        >Code de l’éducation – Article R.421-3 (Missions de l’EPLE)</a
                    >
                </li>
                <li>
                    <a
                        href="https://www.legifrance.gouv.fr/codes/article_lc/LEGIARTI000026549163/"
                        rel="noopener noreferrer"
                        target="_blank"
                        >Code de l’éducation – Article R.421-59 (Préparation & exécution du budget)</a
                    >
                </li>
            </ul>
        </div>

        <!-- ===================== ONGLET 5 : Simulation projets ===================== -->
        <div
            class="tab-pane fade"
            id="tab-simulation"
            role="tabpanel"
            aria-labelledby="tab-simulation-tab"
        >
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="fw-bold mb-0">Simulation de projets</h3>
                <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#formProjet">
                Ajouter un projet
                </button>
            </div>

            <!-- Formulaire pliable -->
            <div class="collapse mb-4" id="formProjet">
                <div class="card shadow-sm">
                <div class="card-body">

                    <form id="project-form" class="row g-3">

                    <div class="col-md-6">
                        <label class="form-label">Nom du projet</label>
                        <input type="text" id="proj-name" class="form-control" required>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Début fonctionnement</label>
                        <input type="number" id="proj-start-year" class="form-control" value="2025">
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Horizon (années)</label>
                        <input type="number" id="proj-horizon" class="form-control" value="5" min="1" max="10">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Recettes annuelles (€)</label>
                        <input type="number" id="proj-recettes" class="form-control" value="0">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Dépenses annuelles (€)</label>
                        <input type="number" id="proj-dep-fonct" class="form-control" value="0">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Montant OPC (invest.) (€)</label>
                        <input type="number" id="proj-opc" class="form-control" value="0">
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Année OPC</label>
                        <input type="number" id="proj-opc-year" class="form-control" value="2025">
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Durée amort. (ans)</label>
                        <input type="number" id="proj-amort-duree" class="form-control" value="5">
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Début amort.</label>
                        <input type="number" id="proj-amort-start" class="form-control" value="2026">
                    </div>

                    <div class="col-12 text-end">
                        <button class="btn btn-success" type="submit">Ajouter</button>
                    </div>

                    </form>

                </div>
                </div>
            </div>

            <!-- Liste des projets -->
            <div class="card shadow-sm mb-4">
                <div class="card-header fw-semibold">Projets simulés</div>
                <div class="table-responsive">
                <table class="table align-middle mb-0" id="projects-table">
                    <thead class="table-light">
                    <tr>
                        <th>Projet</th>
                        <th>Début</th>
                        <th>Recettes</th>
                        <th>Dép. fonct.</th>
                        <th>OPC</th>
                        <th>Année OPC</th>
                        <th>Durée</th>
                        <th>Début amort.</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody class="table-striped"></tbody>
                </table>
                </div>
            </div>

            <!-- Impact -->
            <div class="card shadow-sm">
                <div class="card-header fw-semibold">Impact budgétaire simulé</div>
                <div class="table-responsive">
                <table class="table align-middle mb-0" id="impact-table">
                    <thead class="table-light">
                    <tr>
                        <th>Année</th>
                        <th>Recettes</th>
                        <th>Dépenses</th>
                        <th>Amort.</th>
                        <th>Résultat</th>
                        <th>OPC</th>
                        <th>CAF/IAF projet</th>
                        <th>FdR projet cumulé</th>
                    </tr>
                    </thead>
                    <tbody class="table-striped"></tbody>
                </table>
                </div>
                <div class="p-3">
                <canvas id="impact-chart" class="w-100" style="max-height: 350px;"></canvas>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.0/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-zoom/3.0.0/d3-zoom.min.js"></script>
    <div id="fileLoadingOverlay" class="loading-overlay" aria-hidden="true">
        <div class="loading-box">
            <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
            <div class="loading-text" id="fileLoadingText">Traitement du fichier…</div>
        </div>
    </div>
	  <footer class="text-center mt-4 mb-2">
        <small id="app-version"></small>
    </footer>
<script>
/**
 * TDB Op@le - Tableau de bord exécution budgétaire
 * Basé sur exports Op@le : YCMCPT, CLCA, YFDR, EBLC
 *
 * @version 1.0.0
 * @author Yann Bogdanovic
 * @description
 *  - Tableau de bord OP@LE pour pilotage budgétaire
 */
    Chart.register(ChartDataLabels);

	const APP_VERSION = "TDB OP@LE – 1.11.0";
	window.addEventListener("DOMContentLoaded", () => {
		const el = document.getElementById("app-version");
		if (el) el.textContent = APP_VERSION;
	});

    const MOIS_LABELS = [
      "Janvier","Février","Mars","Avril","Mai","Juin",
      "Juillet","Août","Septembre","Octobre","Novembre","Décembre"
    ];

    const SERVICES_CLES = ["AP", "VE", "ALO", "SRH", "OPC"];

    // Répartition théorique (%) du budget sur l'année, avec creux juillet-août
    let repartitionTheorique = [10, 11, 12, 12, 13, 14, 5, 3, 9, 6, 4, 1];
    const sommeRepartition = repartitionTheorique.reduce((a,b)=>a+b,0);
    if (sommeRepartition !== 100) {
      repartitionTheorique = repartitionTheorique.map(v => v * 100 / sommeRepartition);
    }

    // Données mémorisées brutes
    let allRows = [];
    let exercicesDispo = [];
    let setYears = new Set(); // années détectées dans YCMCPT
    let exerciceCourant = null;

    // Données agrégées pour l'exercice courant
    let depMensuel = new Array(12).fill(0);
    let depCumul = new Array(12).fill(0);
    let depCumulTheo = new Array(12).fill(0);
    let budgetDep = 0;

    let recMensuel = new Array(12).fill(0);
    let recCumul = new Array(12).fill(0);
    let recCumulTheo = new Array(12).fill(0);
    let budgetRec = 0;

    // Données SRH par mois
    let depMensuelSRH = new Array(12).fill(0);
    let recMensuelSRH = new Array(12).fill(0);

    // Avancement calendaire (0-1)
    let avancementCalendaire = 0;

    // Natures à 6 chiffres + libellés
    let natureDepMap = {};
    let natureRecMap = {};
    let natureDepLibs = [];
    let natureRecLibs = [];

    // Services
    let depParService = { "AP":0, "VE":0, "ALO":0, "SRH":0, "OPC":0 };
    let recParService = { "AP":0, "VE":0, "ALO":0, "SRH":0, "OPC":0 };

    // Fond de roulement / CAF
    let fdrData = [];
    let fdrByYear = {};
    let chartFDR = null;
    let cjByYear = {};
    let cafByYear = {};

    // Graphiques
    let chartDepCumul, chartRecCumul, chartNatureDep, chartNatureRec,
        chartServicesDep, chartServicesRec;
    let chartClcaCmdMonth = null, chartClcaTopFourn = null, chartClcaServices = null;
    let clcaData = [];
    // Graphiques SRH
    let chartSrhDepRec = null;
    let chartSrhMensuel = null;


    document.getElementById('file-input').addEventListener('change', handleFiles, false);
    document.getElementById('file-fdr').addEventListener('change', handleFDRFile, false);
    const fileClcaEl = document.getElementById('file-clca');
    if (fileClcaEl) {
      fileClcaEl.addEventListener('change', handleCLCAFile, false);
    }
    const selectExerciceEl = document.getElementById('select-exercice');
    if (selectExerciceEl) {
      selectExerciceEl.addEventListener('change', () => {
        exerciceCourant = selectExerciceEl.value || null;
        recalculerPourExercice();
        updateFDRInfo();
        calculerKPICLCA();
        renderCLCACharts();
        initSrhDelaisTable();
        localStorage.setItem("exerciceCourant", exerciceCourant || "");
      });
    }

// Chargement automatique des données mémorisées
    
    window.addEventListener("DOMContentLoaded", () => {
      // Lecture d'abord de la version compacte (v2) si disponible
      const savedCompact = localStorage.getItem("opaleExecBudget_v2");
      if (savedCompact) {
        try {
          const compact = JSON.parse(savedCompact);
          allRows = compact.map(r => ({
            "Date comptable": r.d,
            "Compte": r.c,
            "Libellé du compte": r.l,
            "Montant débit": r.md,
            "Montant crédit": r.mc,
            "CGR A": r.g
          }));
        } catch (e) {
          console.error("Erreur lors du chargement des données Op@le (v2 compacte) :", e);
        }
      } else {
        const saved = localStorage.getItem("opaleExecBudget");
        if (saved) {
          try {
            allRows = JSON.parse(saved);
          } catch (e) {
            console.error("Erreur lors du chargement des données Op@le :", e);
          }
        }
      }

      const savedFDR = localStorage.getItem("fdrData");
      if (savedFDR) {
        try {
          fdrData = JSON.parse(savedFDR);
        } catch (e) {
          console.error("Erreur lors du chargement du fond de roulement :", e);
        }
      }

      const savedCLCA = localStorage.getItem("clcaData_v1");
      if (savedCLCA) {
        try {
          clcaData = JSON.parse(savedCLCA);
        } catch (e) {
          console.error("Erreur lors du chargement des données CLCA :", e);
        }
      }

      const savedExo = localStorage.getItem("exerciceCourant");
      if (savedExo) {
        exerciceCourant = savedExo;
      }

      initialiserExercicesEtRecalculer();
      if (fdrData && fdrData.length > 0) {
        calculerFDR();
      }
      updateFDRInfo();
      calculerKPICLCA();
      renderCLCACharts();
    });

	function showFileLoading(message) {
	  const overlay = document.getElementById("fileLoadingOverlay");
	  const textEl = document.getElementById("fileLoadingText");
	  if (!overlay || !textEl) return;

	  textEl.textContent = message || "Traitement du fichier…";
	  overlay.classList.add("active");
	}

	function hideFileLoading() {
	  const overlay = document.getElementById("fileLoadingOverlay");
	  if (!overlay) return;
	  overlay.classList.remove("active");
	}

    async function handleFiles(e) {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;

	  const msg = files.length > 1
		? `Traitement de ${files.length} fichiers YCMCPT…`
		: `Traitement du fichier YCMCPT « ${files[0].name} »…`;
	  showFileLoading(msg);
	  
      let combined = [];
      for (const file of files) {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);
        combined = combined.concat(jsonData);
      }

      // On garde en mémoire la version complète pour les calculs,
      // mais on ne stocke dans localStorage qu'une version compacte.
      allRows = combined;

      try {
        const compact = combined.map(r => ({
          d: r["Date comptable"] || "",
          c: r["Compte"] || "",
          l: r["Libellé du compte"] || r["Libellé compte"] || "",
          md: r["Montant débit"] || 0,
          mc: r["Montant crédit"] || 0,
          g: r["CGR A"] || ""
        }));
        localStorage.setItem("opaleExecBudget_v2", JSON.stringify(compact));
        localStorage.removeItem("opaleExecBudget");
      } catch (e) {
        console.error("Impossible de mémoriser les données (quota localStorage ?)", e);
      } finally {
		hideFileLoading();
	  }

      initialiserExercicesEtRecalculer();
      updateFDRInfo();
    }


    async function handleFDRFile(e) {
      const file = e.target.files[0];
      if (!file) return;
	  
	  showFileLoading(`Traitement du fichier FDR « ${file.name} »…`);
	  
      try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });

        fdrData = [];
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          if (!row || row.length < 2) continue;
          const year = parseFDRYear(row[0]);
          const montant = parseFDRMontant(row[1]);
          const flag = (row[2] || "").toString().trim().toUpperCase();
          if (!year || isNaN(montant)) continue;
          const definitive = (flag === "D");
          fdrData.push({ year, montant, definitive });
        }
        localStorage.setItem("fdrData", JSON.stringify(fdrData));
        calculerFDR();
        updateFDRInfo();
      } catch (err) {
        console.error("Erreur de lecture du fichier FDR :", err);
      } finally {
		hideFileLoading();
	  }
    

    }


    
    
    // === CLCA : lecture, KPI et graphiques ===================================
	function computeMontantCLCARecord(r) {
	  // 1) Montant facture (total de ligne)
	  let m = r["Montant facture"];
	  if (m !== undefined && m !== null && m !== "") {
		return m; // Nombre ou texte numérique → géré ensuite par parseMontantCLCA
	  }

	  // Quantité (pour lignes sans Montant facture)
	  const qRaw = r["Quantité"];
	  const q = (qRaw !== undefined && qRaw !== null && qRaw !== "")
		? Number(String(qRaw).replace(",", "."))
		: 1;

	  // Helper interne pour convertir proprement un prix
	  function toNum(v) {
		if (v === undefined || v === null || v === "") return NaN;
		const n = Number(String(v).replace(",", "."));
		return isNaN(n) ? NaN : n;
	  }

	  // 2) Prix facture (si présent)
	  let p = toNum(r["Prix facture"]);
	  if (!isNaN(p)) return q * p;

	  // 3) Prix réceptionné
	  p = toNum(r["Prix réceptionné"]);
	  if (!isNaN(p)) return q * p;

	  // 4) Prix commandé HT
	  p = toNum(r["Prix commandé HT"]);
	  if (!isNaN(p)) return q * p;

	  // 5) Prix tarif HT
	  p = toNum(r["Prix tarif HT"]);
	  if (!isNaN(p)) return q * p;

	  // Sinon : 0 (ligne non valorisable)
	  return 0;
	}

	function getCGR2FromRow(r) {
	  // On récupère toutes les colonnes dont le nom commence par "CGR A"
	  const keys = Object.keys(r).filter(k => k.startsWith("CGR A"));

	  // S'il y en a au moins 2 → on prend la 2ᵉ
	  if (keys.length >= 2) {
		return r[keys[1]] || "";
	  }

	  // Sinon, s'il n'y en a qu'une → on prend la seule
	  if (keys.length === 1) {
		return r[keys[0]] || "";
	  }

	  // Sinon, rien
	  return "";
	}

    /**
     * Lecture du fichier CLCA (commandes).
     * - Détecte la feuille contenant « CLCA » si elle existe, sinon la première.
     * - Compacte les colonnes utiles dans clcaData.
     * - Sauvegarde clcaData dans localStorage (clé "clcaData_v1").
     * - Recalcule immédiatement KPI + graphiques CLCA.
     */
	async function handleCLCAFile(event) {
	  const file = event.target.files[0];
	  if (!file) return;

      showFileLoading(`Traitement du fichier CLCA « ${file.name} »…`);
	  
	  try {
		const data = await file.arrayBuffer();
		const workbook = XLSX.read(data, { type: "array" });

		// Choix de la feuille CLCA
		let sheetName = workbook.SheetNames[0];
		for (const name of workbook.SheetNames) {
		  if (name.toUpperCase().includes("CLCA")) {
			sheetName = name;
			break;
		  }
		}

		const ws = workbook.Sheets[sheetName];
		const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

		if (!rows || rows.length === 0) {
		  clcaData = [];
		  localStorage.removeItem("clcaData_v1");
		  calculerKPICLCA();
		  renderCLCACharts();
		  return;
		}

		clcaData = rows.map(r => {
		  const codeFourn = r["Fournisseur"] || "";
		  // Pour EPLE, on n'a pas "Nom du fournisseur / élève" -> on affiche le code.
		  const nomFourn = codeFourn;

		  return {
			date: r["Date"] || "",                                  // format jj/mm/aaaa
			commande: r["N° commande"] || r["No commande"] || "",   // N° de commande
			fournisseur: nomFourn || "Inconnu",
			numeroFournisseur: codeFourn,
			// Service : CGR A.1 (AP / VE / ALO / SRH / OPC ...) sinon CGR A
			cgr: getCGR2FromRow(r),
			// Montant : Montant facture ou reconstitution HT (TVA 0%)
			montant: computeMontantCLCARecord
			  ? computeMontantCLCARecord(r) // helper montant
			  : (r["Montant facture"] || r["Prix facture TTC"] || "")
		  };
		});

		try {
		  localStorage.setItem("clcaData_v1", JSON.stringify(clcaData));
		} catch (e) {
		  console.error("Impossible de mémoriser les données CLCA (quota localStorage ?)", e);
		}

		calculerKPICLCA();
		renderCLCACharts();
	  } catch (err) {
		console.error("Erreur lors de la lecture du fichier CLCA :", err);
		alert("Impossible de lire le fichier CLCA. Vérifiez le format de l'export.");
	  } finally {
		hideFileLoading();
	  }
	}

    /**
     * Convertit un montant CLCA (texte) en nombre JS.
     * Exemple : "1 234,56" -> 1234.56
     */
    function parseMontantCLCA(v) {
      if (v === null || v === undefined || v === "") return 0;
      let s = v.toString()
        .replace(/\u00A0/g, "")  // espaces insécables
        .replace(/\s/g, "")      // tous les espaces
        .replace(",", ".");       // virgule -> point
      const n = parseFloat(s);
      if (isNaN(n)) return 0;
      // Arrondi systématique à 2 décimales pour les montants CLCA
      return Math.round(n * 100) / 100;
    }

    /**
     * Déduit le service (AP / VE / ALO / SRH / OPC / AUTRES) à partir du CGR A.
     */
	function serviceFromCGR(cgr) {
	  if (!cgr) return "AUTRES";
	  const upper = cgr.toString().toUpperCase().trim();
	  if (upper.startsWith("AP"))  return "AP";
	  if (upper.startsWith("VE"))  return "VE";
	  if (upper.startsWith("ALO")) return "ALO";
	  if (upper.startsWith("SRH")) return "SRH";
	  if (upper.startsWith("OPC")) return "OPC";
	  return "AUTRES";
	}


    /**
     * Filtre les enregistrements CLCA selon l'exercice en cours.
     * Utilise extraireDateInfos(date) qui existe déjà dans le tableau de bord.
     */
    function filtrerCLCAParExercice() {
      if (!clcaData || clcaData.length === 0) return [];
      if (!exerciceCourant) return clcaData;
      return clcaData.filter(r => {
        const info = extraireDateInfos(r.date);
        return info && String(info.year) === String(exerciceCourant);
      });
    }

    /**
     * Calcule et affiche les KPI CLCA :
     * - nombre de commandes,
     * - montant total facturé TTC,
     * - fournisseur principal (+ part),
     * - service le plus consommateur (+ part).
     */
    function calculerKPICLCA() {
      const data = filtrerCLCAParExercice();

      const elNb      = document.getElementById("kpi-clca-nb");
      const elMontant = document.getElementById("kpi-clca-montant");
      const elTopF    = document.getElementById("kpi-clca-top-fourn");
      const elTopFSub = document.getElementById("kpi-clca-top-fourn-sub");
      const elServ    = document.getElementById("kpi-clca-service");
      const elServSub = document.getElementById("kpi-clca-service-sub");

      // Si le bloc CLCA n'est pas présent dans la page, on sort
      if (!elNb) return;

      if (!data || data.length === 0) {
        elNb.innerText      = "–";
        elMontant.innerText = "–";
        elTopF.innerText    = "–";
        elTopFSub.innerText = "Aucune donnée CLCA pour l'exercice sélectionné.";
        elServ.innerText    = "–";
        elServSub.innerText = "Aucune donnée CLCA pour l'exercice sélectionné.";
        return;
      }

      // 1) Nombre de commandes distinctes
      const setCmd = new Set();
      data.forEach(r => { if (r.commande) setCmd.add(r.commande); });
      elNb.innerText = setCmd.size.toString();

      // 2) Montant total facturé TTC
      let total = 0;
      data.forEach(r => { total += parseMontantCLCA(r.montant); });
      elMontant.innerText = formatEuro(total);

      // 3) Fournisseur principal
      const montParFourn = {};
      data.forEach(r => {
        const f  = r.fournisseur || "Inconnu";
        const mt = parseMontantCLCA(r.montant);
        if (!montParFourn[f]) montParFourn[f] = 0;
        montParFourn[f] += mt;
      });

      const topFList = Object.entries(montParFourn).sort((a,b)=>b[1]-a[1]);
      if (topFList.length > 0) {
        const [nom, mt] = topFList[0];
        elTopF.innerText = nom;
        const part = total > 0 ? (mt / total * 100) : 0;
        elTopFSub.innerText = formatEuro(mt) + " (" + part.toFixed(2) + " % des montants CLCA)";
      } else {
        elTopF.innerText = "–";
        elTopFSub.innerText = "Aucun fournisseur identifié.";
      }

      // 4) Service le plus consommateur
      const montParServ = { AP:0, VE:0, ALO:0, SRH:0, OPC:0, AUTRES:0 };
      data.forEach(r => {
        const serv = serviceFromCGR(r.cgr);
        const mt   = parseMontantCLCA(r.montant);
        if (!montParServ.hasOwnProperty(serv)) montParServ[serv] = 0;
        montParServ[serv] += mt;
      });

      const topSList = Object.entries(montParServ).sort((a,b)=>b[1]-a[1]);
      if (topSList.length > 0) {
        const [serv, mt] = topSList[0];
        const part = total > 0 ? (mt / total * 100) : 0;
        elServ.innerText = serv;
        elServSub.innerText = formatEuro(mt) + " (" + part.toFixed(2) + " % des montants CLCA)";
      } else {
        elServ.innerText = "–";
        elServSub.innerText = "Aucun service identifié.";
      }
    }

    /**
     * Construit ou reconstruit les 3 graphiques CLCA :
     * - commandes par mois (bar chart),
     * - top 10 fournisseurs (bar horizontale),
     * - répartition des montants par service (camembert).
     */
    function renderCLCACharts() {
      const data = filtrerCLCAParExercice();

      const ctxMonthEl = document.getElementById("chart-clca-cmd-month");
      const ctxTopFEl  = document.getElementById("chart-clca-top-fourn");
      const ctxServEl  = document.getElementById("chart-clca-services");
      if (!ctxMonthEl || !ctxTopFEl || !ctxServEl) return;

      // Détruire les anciens graphiques si présents
      if (chartClcaCmdMonth) chartClcaCmdMonth.destroy();
      if (chartClcaTopFourn) chartClcaTopFourn.destroy();
      if (chartClcaServices) chartClcaServices.destroy();

      if (!data || data.length === 0) {
        return; // rien à tracer
      }

      // --- 1. Commandes par mois ---
      // On veut toujours 12 mois affichés (même si certaines périodes n'ont pas de commandes)
      const commandesParMois = Array.from({ length: 12 }, () => new Set());

      data.forEach(r => {
        const info = extraireDateInfos(r.date);
        if (!info) return;
        const mIndex = typeof info.monthIndex === "number" ? info.monthIndex : null;
        if (mIndex !== null && mIndex >= 0 && mIndex <= 11 && r.commande) {
          commandesParMois[mIndex].add(r.commande);
        }
      });

      // Construction des labels MM/AAAA pour l'exercice courant
      let anneeLabel = exerciceCourant;
      if (!anneeLabel && data.length > 0) {
        const info0 = extraireDateInfos(data[0].date);
        if (info0) {
          anneeLabel = info0.year;
        }
      }

      const moisLabels = [];
      const moisValues = [];
      for (let m = 1; m <= 12; m++) {
        const label = String(m).padStart(2, "0") + (anneeLabel ? "/" + anneeLabel : "");
        moisLabels.push(label);
        moisValues.push(commandesParMois[m - 1].size);
      }

      chartClcaCmdMonth = new Chart(ctxMonthEl.getContext("2d"), {
        type: "bar",
        data: {
          labels: moisLabels,
          datasets: [{
            label: "Nombre de commandes",
            data: moisValues,
            backgroundColor: "#3498db"
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => ctx.raw + " commande(s)"
              }
            }
          },
          scales: {
            x: { ticks: { color: "#000000" } },
            y: { ticks: { color: "#000000" } }
          }
        }
      });

      // --- 2. Top 10 fournisseurs ---
      const montParFourn = {};
      data.forEach(r => {
        const f    = r.fournisseur || "Inconnu";
        const code = r.numeroFournisseur || "";
        const mt   = parseMontantCLCA(r.montant);
        if (!montParFourn[f]) {
          montParFourn[f] = { total: 0, code: code };
        }
        montParFourn[f].total += mt;
      });

      const topFList = Object.entries(montParFourn)
        .sort((a,b) => b[1].total - a[1].total)
        .slice(0, 10);

      const labelsF  = topFList.map(x => x[0]);
      const valeursF = topFList.map(x => x[1].total);
      const codesF   = topFList.map(x => x[1].code || "");

      chartClcaTopFourn = new Chart(ctxTopFEl.getContext("2d"), {
        type: "bar",
        data: {
          labels: labelsF,
          datasets: [{
            label: "Montant facturé TTC",
            data: valeursF,
            backgroundColor: "#2ecc71"
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const idx = ctx.dataIndex;
                  const name = ctx.label;
                  const code = codesF[idx];
                  const montant = ctx.raw;
                  const info = code ? (name + " (" + code + ")") : name;
                  return info + " : " + formatEuro(montant);
                }
              }
            },
            datalabels: {
              color: "#000000",
              anchor: "end",
              align: "right",
              font: { size: 9, weight: "bold" },
              formatter: value => formatEuro(value)
            }
          },
          scales: {
            x: {
              ticks: {
                color: "#000000",
                callback: v => formatK(v)
              }
            },
            y: { ticks: { color: "#000000" } }
          }
        }
      });

      // --- 3. Montants par service ---
      const montParServ = { AP:0, VE:0, ALO:0, SRH:0, OPC:0, AUTRES:0 };
      data.forEach(r => {
        const serv = serviceFromCGR(r.cgr);
        const mt   = parseMontantCLCA(r.montant);
        if (!montParServ.hasOwnProperty(serv)) montParServ[serv] = 0;
        montParServ[serv] += mt;
      });

      const labelsS  = Object.keys(montParServ);
      const valeursS = labelsS.map(k => montParServ[k]);

      chartClcaServices = new Chart(ctxServEl.getContext("2d"), {
        type: "pie",
        data: {
          labels: labelsS,
          datasets: [{
            data: valeursS,
            backgroundColor: labelsS.map((_, i) => couleurPalette(i)),
            borderColor: "#ffffff",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: "bottom",
              labels: {
                color: "#000000",
                font: { size: 11 }
              }
            },
            tooltip: {
              callbacks: {
                label: ctx => ctx.label + " : " + formatEuro(ctx.raw)
              }
            },
            datalabels: {
              color: "#000000",
              font: { size: 10, weight: "bold" },
              formatter: value => formatEuro(value)
            }
          }
        }
      });
    }
function clearSavedData() {
      localStorage.removeItem("opaleExecBudget");
      localStorage.removeItem("opaleExecBudget_v2");
      localStorage.removeItem("fdrData");
      localStorage.removeItem("clcaData_v1");
      localStorage.removeItem("exerciceCourant");
      localStorage.removeItem("EBLC_BALANCE_DATA");
      alert("Les données mémorisées (YCMCPT, YFDR, CLCA et EBLC) ont été supprimées. Rechargez les fichiers pour reconstruire le tableau de bord.");
      location.reload();
    }

        function initialiserExercicesEtRecalculer() {
      cjByYear = {};
            cafByYear = {};
      
            const sum6ByYear = {};
            const sum7ByYear = {};
            const chargesCalcByYear = {};
            const produitsCalcByYear = {};
            const valCessionByYear = {};
            const prodCessionByYear = {};
            const neutraByYear = {};     // 776
            const subInvByYear = {};     // 777
      
            allRows.forEach(row => {
              const dateStr = row["Date comptable"];
              const info = extraireDateInfos(dateStr);
              if (!info) return;
              const year = info.year;
              setYears.add(year);
      
              const compteBrut = String(row["Compte"] || "");
              const compte = compteBrut.trim();
              const montantDebit = parseFloat(row["Montant débit"] || 0);
              const montantCredit = parseFloat(row["Montant crédit"] || 0);
      
              if (compte.startsWith("6") && !isNaN(montantDebit) && montantDebit !== 0) {
                if (!sum6ByYear[year]) sum6ByYear[year] = 0;
                sum6ByYear[year] += montantDebit;
              }
              if (compte.startsWith("7") && !isNaN(montantCredit) && montantCredit !== 0) {
                if (!sum7ByYear[year]) sum7ByYear[year] = 0;
                sum7ByYear[year] += montantCredit;
              }
      
              if (/^6[0-5]/.test(compte) && !isNaN(montantDebit) && montantDebit !== 0) {
                if (!cjByYear[year]) cjByYear[year] = 0;
                cjByYear[year] += montantDebit;
              }
      
              if (/^68/.test(compte) && !isNaN(montantDebit) && montantDebit !== 0) {
                if (!chargesCalcByYear[year]) chargesCalcByYear[year] = 0;
                chargesCalcByYear[year] += montantDebit;
              }
      
              if (/^78/.test(compte) && !isNaN(montantCredit) && montantCredit !== 0) {
                if (!produitsCalcByYear[year]) produitsCalcByYear[year] = 0;
                produitsCalcByYear[year] += montantCredit;
              }
      
              if (compte.startsWith("675") && !isNaN(montantDebit) && montantDebit !== 0) {
                if (!valCessionByYear[year]) valCessionByYear[year] = 0;
                valCessionByYear[year] += montantDebit;
              }
      
              if (compte.startsWith("775") && !isNaN(montantCredit) && montantCredit !== 0) {
                if (!prodCessionByYear[year]) prodCessionByYear[year] = 0;
                prodCessionByYear[year] += montantCredit;
              }

              if (compte.startsWith("776") && !isNaN(montantCredit) && montantCredit !== 0) {
                if (!neutraByYear[year]) neutraByYear[year] = 0;
                neutraByYear[year] += montantCredit;
              }

              if (compte.startsWith("777") && !isNaN(montantCredit) && montantCredit !== 0) {
                if (!subInvByYear[year]) subInvByYear[year] = 0;
                subInvByYear[year] += montantCredit;
              }
            });
      
            Array.from(setYears).forEach(year => {
              const charges = sum6ByYear[year] || 0;
              const produits = sum7ByYear[year] || 0;
              const resultat = produits - charges;
              const chargesCalc = chargesCalcByYear[year] || 0;   // C68
              const produitsCalc = produitsCalcByYear[year] || 0; // C78
              const valC = valCessionByYear[year] || 0;           // C675
              const prodC = prodCessionByYear[year] || 0;         // C775
              const neutra = neutraByYear[year] || 0;             // C776
              const subInv = subInvByYear[year] || 0;             // C777

              // CAF = Résultat net + C68 - C78 - C776 + C675 - C775 - C777
              const caf = resultat + chargesCalc - produitsCalc - neutra + valC - prodC - subInv;

              cafByYear[year] = {
                caf,
                resultat,
                chargesCalc,
                produitsCalc,
                valCession: valC,
                prodCession: prodC,
                neutra776: neutra,
                subventions777: subInv
              };
            });
      
            exercicesDispo = Array.from(setYears).sort((a,b)=>a-b);
      
            const select = document.getElementById('select-exercice');
            select.innerHTML = '<option value="">Tous</option>';
            exercicesDispo.forEach(y => {
              const opt = document.createElement("option");
              opt.value = y;
              opt.textContent = y;
              select.appendChild(opt);
            });
      
            if (!exerciceCourant) {
              exerciceCourant = exercicesDispo.length ? exercicesDispo[exercicesDispo.length - 1] : null;
            }
            if (exerciceCourant) {
              select.value = exerciceCourant;
            }
      
            if (typeof recalculerPourExercice === "function") {
        recalculerPourExercice();
      }
          
    }


    function filtrerRowsExercice() {
      if (!exerciceCourant) return allRows;
      return allRows.filter(row => {
        const info = extraireDateInfos(row["Date comptable"]);
        return info && info.year == exerciceCourant;
      });
    }

    function recalculerPourExercice() {
      const rows = filtrerRowsExercice();

      depMensuel = new Array(12).fill(0);
      recMensuel = new Array(12).fill(0);
      depMensuelSRH = new Array(12).fill(0);
      recMensuelSRH = new Array(12).fill(0);
      natureDepMap = {};
      natureRecMap = {};
      depParService = { "AP":0, "VE":0, "ALO":0, "SRH":0, "OPC":0 };
      recParService = { "AP":0, "VE":0, "ALO":0, "SRH":0, "OPC":0 };
      avancementCalendaire = 0;
      let dernierMois = null;

      rows.forEach(row => {
        const dateStr = row["Date comptable"];
        if (!dateStr) return;
        const info = extraireDateInfos(dateStr);
        if (!info) return;
        const m = info.monthIndex;
        if (dernierMois === null || m > dernierMois) {
          dernierMois = m;
        }

        const compteBrut = String(row["Compte"] || "");
        const compte = compteBrut.trim();
        const libelleCompte = String(row["Libellé du compte"] || row["Libellé compte"] || "");
        const montantDebit = parseFloat(row["Montant débit"] || 0);
        const montantCredit = parseFloat(row["Montant crédit"] || 0);

        const cgrA = row["CGR A"] || "";
        const parsedCGR = parseCGRA(cgrA);
        const service = parsedCGR.service;

        if (compte.startsWith("6") && !isNaN(montantDebit) && montantDebit !== 0) {
          depMensuel[m] += montantDebit;

          const natureKey = compte.substring(0, 6);
          if (!natureDepMap[natureKey]) {
            natureDepMap[natureKey] = { montant: 0, libelle: libelleCompte };
          }
          natureDepMap[natureKey].montant += montantDebit;
          if (!natureDepMap[natureKey].libelle && libelleCompte) {
            natureDepMap[natureKey].libelle = libelleCompte;
          }

          if (service) {
            if (!depParService.hasOwnProperty(service)) depParService[service] = 0;
            depParService[service] += montantDebit;

            // SRH : agrégation mensuelle spécifique
            if (service === "SRH") {
              depMensuelSRH[m] += montantDebit;
            }
          }
        }

        if (compte.startsWith("7") && !isNaN(montantCredit) && montantCredit !== 0) {
          recMensuel[m] += montantCredit;

          const natureKeyR = compte.substring(0, 6);
          if (!natureRecMap[natureKeyR]) {
            natureRecMap[natureKeyR] = { montant: 0, libelle: libelleCompte };
          }
          natureRecMap[natureKeyR].montant += montantCredit;
          if (!natureRecMap[natureKeyR].libelle && libelleCompte) {
            natureRecMap[natureKeyR].libelle = libelleCompte;
          }

          if (service) {
            if (!recParService.hasOwnProperty(service)) recParService[service] = 0;
            recParService[service] += montantCredit;

            // SRH : agrégation mensuelle spécifique
            if (service === "SRH") {
              recMensuelSRH[m] += montantCredit;
            }
          }
        }
      });

      if (dernierMois !== null) {
        avancementCalendaire = (dernierMois + 1) / 12;
      } else {
        avancementCalendaire = 0;
      }

      depCumul = cumuliser(depMensuel);
      recCumul = cumuliser(recMensuel);

      const inputDep = parseFloat(document.getElementById('budget-dep').value || "0");
      const totalDep = depCumul[11] || depCumul[dernierIndexNonNul(depCumul)] || 0;
      budgetDep = !isNaN(inputDep) && inputDep > 0 ? inputDep : totalDep;

      const inputRec = parseFloat(document.getElementById('budget-rec').value || "0");
      const totalRec = recCumul[11] || recCumul[dernierIndexNonNul(recCumul)] || 0;
      budgetRec = !isNaN(inputRec) && inputRec > 0 ? inputRec : totalRec;

      recalculerTheorique(false);
      majKPIs(totalDep, totalRec);
      renderCharts();
      updateFDRInfo();
    }

	function extraireDateInfos(dateStr) {
	  if (!dateStr) return null;

	  // Cas déjà géré : objet Date
	  if (dateStr instanceof Date) {
		return { year: dateStr.getFullYear(), monthIndex: dateStr.getMonth() };
	  }

	  // Si c'est un nombre (ex : 20250106), on le transforme en chaîne
	  if (typeof dateStr === "number") {
		dateStr = String(dateStr);
	  }

	  if (typeof dateStr === "string") {
		const s = dateStr.trim();

		// 1) Format AAAAMMJJ (ex : 20250106)
		if (/^\d{8}$/.test(s)) {
		  const annee = parseInt(s.slice(0, 4), 10);
		  const mois  = parseInt(s.slice(4, 6), 10);
		  const jour  = parseInt(s.slice(6, 8), 10);
		  if (!isNaN(jour) && !isNaN(mois) && !isNaN(annee) && mois >= 1 && mois <= 12) {
			return { year: annee, monthIndex: mois - 1 };
		  }
		}

		// 2) Format ISO AAAA-MM-JJ (au cas où)
		if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
		  const parts = s.split("-");
		  const annee = parseInt(parts[0], 10);
		  const mois  = parseInt(parts[1], 10);
		  const jour  = parseInt(parts[2], 10);
		  if (!isNaN(jour) && !isNaN(mois) && !isNaN(annee) && mois >= 1 && mois <= 12) {
			return { year: annee, monthIndex: mois - 1 };
		  }
		}

		// 3) Ton format historique jj/mm/aaaa
		const parts = s.split("/");
		if (parts.length === 3) {
		  const jour  = parseInt(parts[0], 10);
		  const mois  = parseInt(parts[1], 10);
		  const annee = parseInt(parts[2], 10);
		  if (!isNaN(jour) && !isNaN(mois) && !isNaN(annee) && mois >= 1 && mois <= 12) {
			return { year: annee, monthIndex: mois - 1 };
		  }
		}
	  }

	  return null;
	}


    function parseCGRA(value) {
      let res = { service: null, domaine: "Sans domaine", activite: "Sans activité" };
      if (!value) return res;
      let txt = String(value).trim();
      if (!txt) return res;

      let parts = txt.split(/\s{2,}/).filter(p => p.trim().length > 0);
      if (parts.length >= 3) {
        res.service = detectCodeService(parts[0]);
        res.domaine = parts[1].trim() || res.domaine;
        res.activite = parts.slice(2).join(" ").trim() || res.activite;
        if (!res.service) {
          res.service = detectCodeService(txt);
        }
        return res;
      }

      res.service = detectCodeService(txt);
      let reste = txt;
      if (res.service) {
        const idx = txt.toUpperCase().indexOf(res.service);
        if (idx >= 0) {
          reste = txt.slice(idx + res.service.length).trim();
        }
      }

      let sub = reste.split(/\s{2,}|\s-\s|\s\/\s/).filter(p => p.trim().length > 0);
      if (sub.length >= 2) {
        res.domaine = sub[0].trim();
        res.activite = sub.slice(1).join(" ").trim();
      } else if (reste) {
        res.domaine = reste;
        res.activite = reste;
      }
      return res;
    }

    function detectCodeService(txt) {
      if (!txt) return null;
      const upper = String(txt).toUpperCase();
      const codes = ["AP","VE","ALO","SRH","OPC"];
      const tokens = upper.split(/\s+/);
      for (const c of codes) {
        if (tokens.includes(c)) return c;
      }
      for (const c of codes) {
        if (upper.includes(c)) return c;
      }
      return null;
    }

    function cumuliser(arr) {
      let cumul = 0;
      return arr.map(v => (cumul += v));
    }

    function recalculerTheorique(regenererCharts = true) {
      const inputDep = parseFloat(document.getElementById('budget-dep').value || "0");
      if (!isNaN(inputDep) && inputDep > 0) budgetDep = inputDep;
      const inputRec = parseFloat(document.getElementById('budget-rec').value || "0");
      if (!isNaN(inputRec) && inputRec > 0) budgetRec = inputRec;

      const depTheoMensuel = repartitionTheorique.map(p => budgetDep * (p / 100));
      depCumulTheo = cumuliser(depTheoMensuel);
      const recTheoMensuel = repartitionTheorique.map(p => budgetRec * (p / 100));
      recCumulTheo = cumuliser(recTheoMensuel);

      if (regenererCharts) {
        renderCharts();
      }
    }

    function dernierIndexNonNul(arr) {
      for (let i = arr.length - 1; i >= 0; i--) {
        if (arr[i] && arr[i] !== 0) return i;
      }
      return -1;
    }

    function extraireTopNature(mapObj, n = 30) {
      const entries = Object.entries(mapObj).map(([code, obj]) => [code, obj.montant || 0, obj.libelle || ""]);
      entries.sort((a,b)=>b[1]-a[1]);
      const top = entries.slice(0, n);
      const codes = top.map(e => e[0]);
      const valeurs = top.map(e => e[1]);
      const libelles = top.map(e => e[2]);
      return [codes, valeurs, libelles];
    }

    function computeTopShare(mapObj, n = 5) {
      const entries = Object.entries(mapObj).map(([code, obj]) => obj.montant || 0);
      if (entries.length === 0) return { share: 0, total: 0, topTotal: 0 };
      const total = entries.reduce((a,b)=>a+b,0);
      const sorted = entries.sort((a,b)=>b-a);
      const topTotal = sorted.slice(0, n).reduce((a,b)=>a+b,0);
      const share = total > 0 ? (topTotal * 100 / total) : 0;
      return { share, total, topTotal };
    }

    function majKPIs(totalDep, totalRec) {
      document.getElementById('kpi-budget-dep').innerText = formatEuro(budgetDep);
      document.getElementById('kpi-budget-rec').innerText = formatEuro(budgetRec);
      document.getElementById('kpi-exec-dep').innerText = formatEuro(totalDep);
      document.getElementById('kpi-exec-rec').innerText = formatEuro(totalRec);

      const tauxDepNum = budgetDep > 0 ? (totalDep / budgetDep) * 100 : 0;
      const tauxRecNum = budgetRec > 0 ? (totalRec / budgetRec) * 100 : 0;
      document.getElementById('kpi-taux-dep').innerText = "Taux d'exécution : " + (budgetDep>0 ? tauxDepNum.toFixed(1)+" %" : "–");
      document.getElementById('kpi-taux-rec').innerText = "Taux de réalisation : " + (budgetRec>0 ? tauxRecNum.toFixed(1)+" %" : "–");

      const resteDep = Math.max(budgetDep - totalDep, 0);
      document.getElementById('kpi-reste-dep').innerText = formatEuro(resteDep);

      const anneePct = avancementCalendaire * 100;
      const ecart = tauxDepNum - anneePct;
      const ecartEl = document.getElementById('kpi-ecart-cal');
      const ecartSubEl = document.getElementById('kpi-ecart-cal-sub');
      if (anneePct > 0) {
        ecartEl.innerText = "Année " + anneePct.toFixed(1) + " % / Dépenses " + tauxDepNum.toFixed(1) + " %";
        const signe = ecart > 0 ? "+" : "";
        ecartSubEl.innerText = "Écart : " + signe + ecart.toFixed(1) + " points";
      } else {
        ecartEl.innerText = "–";
        ecartSubEl.innerText = "Écart : –";
      }

      const topInfo = computeTopShare(natureDepMap, 5);
      const topEl = document.getElementById('kpi-top5');
      const topSubEl = document.getElementById('kpi-top5-sub');
      if (topInfo.total > 0) {
        topEl.innerText = topInfo.share.toFixed(1) + " %";
        topSubEl.innerText = "Top 5 = " + formatEuro(topInfo.topTotal) + " / " + formatEuro(topInfo.total);
      } else {
        topEl.innerText = "–";
        topSubEl.innerText = "Pas de données de dépenses.";
      }
    }

    function renderCharts() {
      if (chartDepCumul) chartDepCumul.destroy();
      if (chartRecCumul) chartRecCumul.destroy();
      if (chartNatureDep) chartNatureDep.destroy();
      if (chartNatureRec) chartNatureRec.destroy();
      if (chartServicesDep) chartServicesDep.destroy();
      if (chartServicesRec) chartServicesRec.destroy();
      if (chartSrhDepRec) chartSrhDepRec.destroy();
      if (chartSrhMensuel) chartSrhMensuel.destroy();

      const ctxDepCumul = document.getElementById('chart-dep-cumul').getContext('2d');
      chartDepCumul = new Chart(ctxDepCumul, {
        data: {
          labels: MOIS_LABELS,
          datasets: [
            {
              type: 'bar',
              label: 'Cumul dépenses exécutées',
              data: depCumul,
              backgroundColor: 'rgba(255,60,60,0.7)',
              borderColor: '#ff3c3c',
              borderWidth: 1
            },
            {
              type: 'line',
              label: 'Cumul théorique dépenses',
              data: depCumulTheo,
              borderColor: '#1abc9c',
              borderWidth: 2,
              tension: 0.25,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: "#000000", font: { size: 12 } }
            },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label} : ${formatEuro(ctx.raw)}`
              }
            },
            datalabels: { display: false }
          },
          scales: {
            x: { ticks: { color: "#000000", font: { size: 10 } } },
            y: {
              beginAtZero: true,
              ticks: {
                color: "#000000",
                font: { size: 10 },
                callback: value => formatK(value)
              }
            }
          }
        }
      });

      const ctxRecCumul = document.getElementById('chart-rec-cumul').getContext('2d');
      chartRecCumul = new Chart(ctxRecCumul, {
        data: {
          labels: MOIS_LABELS,
          datasets: [
            {
              type: 'bar',
              label: 'Cumul recettes réalisées',
              data: recCumul,
              backgroundColor: 'rgba(52,152,219,0.7)',
              borderColor: '#3498db',
              borderWidth: 1
            },
            {
              type: 'line',
              label: 'Cumul théorique recettes',
              data: recCumulTheo,
              borderColor: '#2ecc71',
              borderWidth: 2,
              tension: 0.25,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: "#000000", font: { size: 12 } }
            },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label} : ${formatEuro(ctx.raw)}`
              }
            },
            datalabels: { display: false }
          },
          scales: {
            x: { ticks: { color: "#000000", font: { size: 10 } } },
            y: {
              beginAtZero: true,
              ticks: {
                color: "#000000",
                font: { size: 10 },
                callback: value => formatK(value)
              }
            }
          }
        }
      });

      const [codesDep, valeursDep, libsDep] = extraireTopNature(natureDepMap, 30);
      const [codesRec, valeursRec, libsRec] = extraireTopNature(natureRecMap, 30);
      natureDepLibs = libsDep;
      natureRecLibs = libsRec;

      const ctxNatDep = document.getElementById('chart-nature-dep').getContext('2d');
      chartNatureDep = new Chart(ctxNatDep, {
        type: 'pie',
        data: {
          labels: codesDep,
          datasets: [{
            data: valeursDep,
            backgroundColor: codesDep.map((_,i)=>couleurPalette(i)),
            borderColor: '#ffffff',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom', labels: { color: "#000000", font: { size: 11 } } },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const i = ctx.dataIndex;
                  const code = ctx.label || '';
                  const lib = natureDepLibs[i] || '';
                  return `${code} – ${lib} : ${formatEuro(ctx.raw)}`;
                }
              }
            },
            datalabels: {
              color: '#000000',
              font: { size: 9, weight: 'bold' },
              formatter: (value, ctx) => {
                const code = ctx.chart.data.labels[ctx.dataIndex];
                const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0) || 1;
                const p = (value*100/total).toFixed(1);
                return `${code}
${p} %`;
              }
            }
          }
        }
      });

      const ctxNatRec = document.getElementById('chart-nature-rec').getContext('2d');
      chartNatureRec = new Chart(ctxNatRec, {
        type: 'pie',
        data: {
          labels: codesRec,
          datasets: [{
            data: valeursRec,
            backgroundColor: codesRec.map((_,i)=>couleurPalette(i+5)),
            borderColor: '#ffffff',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom', labels: { color: "#000000", font: { size: 11 } } },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const i = ctx.dataIndex;
                  const code = ctx.label || '';
                  const lib = natureRecLibs[i] || '';
                  return `${code} – ${lib} : ${formatEuro(ctx.raw)}`;
                }
              }
            },
            datalabels: {
              color: '#000000',
              font: { size: 9, weight: 'bold' },
              formatter: (value, ctx) => {
                const code = ctx.chart.data.labels[ctx.dataIndex];
                const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0) || 1;
                const p = (value*100/total).toFixed(1);
                return `${code}
                ${p} %`;
              }
            }
          }
        }
      });

      const ctxServDep = document.getElementById('chart-services-dep').getContext('2d');
      const mandats = SERVICES_CLES.map(s => depParService[s] || 0);
      const totalDepServices = mandats.reduce((a,b)=>a+b,0) || 1;
      const budgetsServ = SERVICES_CLES.map((s,idx) => (budgetDep * (mandats[idx] / totalDepServices)));
      const engagesServ = new Array(SERVICES_CLES.length).fill(0);
      const disponiblesServ = budgetsServ.map((b,idx) => Math.max(b - mandats[idx] - engagesServ[idx], 0));

      chartServicesDep = new Chart(ctxServDep, {
        type: 'bar',
        data: {
          labels: SERVICES_CLES.map(s => labelServiceLong(s)),
          datasets: [
            { label: 'Mandaté (payé)', data: mandats, backgroundColor: '#3498db', stack: 'stack1' },
            { label: 'Engagé', data: engagesServ, backgroundColor: '#e74c3c', stack: 'stack1' },
            { label: 'Disponible', data: disponiblesServ, backgroundColor: '#2ecc71', stack: 'stack1' }
          ]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: { position: 'bottom', labels: { color: "#000000", font: { size: 11 } } },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label} : ${formatEuro(ctx.raw)}`
              }
            },
            datalabels: {
              color: '#000000',
              anchor: 'center',
              align: 'center',
              font: { size: 10, weight: 'bold' },
              formatter: value => value > 0 ? formatEuro(value) : ''
            }
          },
          scales: {
            x: {
              stacked: true,
              ticks: {
                color: "#000000",
                font: { size: 10 },
                callback: value => formatK(value)
              }
            },
            y: {
              stacked: true,
              ticks: { color: "#000000", font: { size: 10 } }
            }
          }
        }
      });

      const ctxServRec = document.getElementById('chart-services-rec').getContext('2d');
      const recs = SERVICES_CLES.map(s => recParService[s] || 0);
      chartServicesRec = new Chart(ctxServRec, {
        type: 'bar',
        data: {
          labels: SERVICES_CLES.map(s => labelServiceLong(s)),
          datasets: [
            {
              label: 'Recettes réalisées',
              data: recs,
              backgroundColor: 'rgba(52,152,219,0.8)',
              borderColor: '#3498db',
              borderWidth: 1
            }
          ]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: { position: 'bottom', labels: { color: "#000000", font: { size: 11 } } },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label} : ${formatEuro(ctx.raw)}`
              }
            },
            datalabels: {
              color: '#000000',
              anchor: 'end',
              align: 'right',
              font: { size: 9, weight: 'bold' },
              formatter: value => value > 0 ? formatK(value) : ''
            }
          },
          scales: {
            x: {
              ticks: {
                color: "#000000",
                font: { size: 10 },
                callback: value => formatK(value)
              }
            },
            y: { ticks: { color: "#000000", font: { size: 10 } } }
          }
        }
      });

      // Zoom AP
      const apIndex = SERVICES_CLES.indexOf("AP");
      const apDep = apIndex >= 0 ? mandats[apIndex] : 0;
      const totalDep = mandats.reduce((a,b)=>a+b,0) || 0;
      const apBudget = apIndex >= 0 ? budgetsServ[apIndex] : 0;
      const apReste = apIndex >= 0 ? Math.max(apBudget - apDep - engagesServ[apIndex], 0) : 0;
      updateZoomPedagogique(apDep, totalDep, apBudget, apReste, mandats, budgetsServ);

      // --- Focus SRH (global + mensuel) ---
      const srhIndex = SERVICES_CLES.indexOf("SRH");
      if (srhIndex >= 0) {
        const srhDep = mandats[srhIndex] || 0;
        const srhRec = recs[srhIndex] || 0;
        const srhBudget = budgetsServ[srhIndex] || 0;
        updateZoomSRH(srhDep, srhRec, srhBudget, totalDep);
        updateSrhDepRecChart(srhDep, srhRec);
      } else {
        updateZoomSRH(0, 0, 0, totalDep);
        updateSrhDepRecChart(0, 0);
      }

      // Graphique SRH mensuel (rythme de l'année)
      updateSrhMensuelChart();
    }

    function calculerFDR() {
      if (!fdrData || fdrData.length === 0) {
        if (chartFDR) {
          chartFDR.destroy();
          chartFDR = null;
        }
        fdrByYear = {};
        return;
      }

      const map = {};
      fdrData.forEach(r => {
        if (!map[r.year]) {
          map[r.year] = { definitif: null, hasDef: false };
        }
        if (r.definitive) {
          map[r.year].definitif = r.montant;
          map[r.year].hasDef = true;
        }
      });
      fdrByYear = map;

      const yearsAll = Object.keys(map).map(y => parseInt(y,10)).sort((a,b)=>a-b);
      const years = yearsAll.filter(y => map[y].hasDef);
      const valsDef = years.map(y => map[y].definitif);

      const ctx = document.getElementById('chart-fdr').getContext('2d');
      if (chartFDR) chartFDR.destroy();

      if (years.length === 0) {
        chartFDR = new Chart(ctx, {
          type: 'line',
          data: { labels: [], datasets: [] },
          options: { plugins: { legend: { display: false } } }
        });
        return;
      }

      chartFDR = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: [
            {
              label: 'Fond de roulement définitif (CF)',
              data: valsDef,
              borderColor: '#27ae60',
              borderWidth: 2,
              tension: 0.15,
              fill: false,
              pointRadius: 4,
              pointBackgroundColor: '#2ecc71'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom', labels: { color: '#000000', font: { size: 11 } } },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label} : ${formatEuro(ctx.raw)}`
              }
            },
            datalabels: {
              color: '#000000',
              anchor: 'end',
              align: 'top',
              font: { size: 9, weight: 'bold' },
              formatter: value => value ? formatK(value) : ''
            }
          },
          scales: {
            x: { ticks: { color: '#000000', font: { size: 10 } } },
            y: {
              beginAtZero: true,
              ticks: {
                color: '#000000',
                font: { size: 10 },
                callback: value => formatK(value)
              }
            }
          }
        }
      });
    }

    function updateFDRInfo() {
      const yearLabelEl = document.getElementById('fdr-year-label');
      const fdrValEl = document.getElementById('fdr-val');
      const fdrCjEl = document.getElementById('fdr-cj');
      const fdrDaysEl = document.getElementById('fdr-days');
      const fdrCafEl = document.getElementById('fdr-caf');
      const infoEl = document.getElementById('fdr-info');
      const kpiDeltaFdrEl = document.getElementById('kpi-delta-fdr');
      const kpiDeltaFdrSubEl = document.getElementById('kpi-delta-fdr-sub');

      if (!yearLabelEl || !fdrValEl || !fdrCjEl || !fdrDaysEl || !infoEl || !fdrCafEl) return;

      yearLabelEl.textContent = "Exercice " + (exerciceCourant || "–");
      fdrValEl.textContent = "FDR : –";
      fdrCjEl.textContent = "Coût journalier de l'établissement : –";
      fdrDaysEl.textContent = "Nombre de jours de FDR : –";
      fdrCafEl.textContent = "CAF / IAF : –";
      infoEl.textContent = "";
      if (kpiDeltaFdrEl && kpiDeltaFdrSubEl) {
        kpiDeltaFdrEl.textContent = "–";
        kpiDeltaFdrSubEl.textContent = "Var. du fond de roulement définitif";
      }

      const year = exerciceCourant ? parseInt(exerciceCourant, 10) : null;
      if (!year) {
        infoEl.textContent = "Sélectionnez un exercice et chargez les fichiers YCMCPT et YFDR pour afficher FDR, CAF et CJ.";
        return;
      }

      if (!fdrByYear[year] || !fdrByYear[year].hasDef || !cjByYear[year]) {
        infoEl.textContent = "Charger au moins un export YCMCPT pour l'exercice choisi et un fichier YFDR avec une valeur « D » afin de calculer le coût journalier, la CAF et le nombre de jours de fond de roulement.";
      }

      if (fdrByYear[year] && fdrByYear[year].hasDef && cjByYear[year]) {
        const fdr = fdrByYear[year].definitif;
        const cjAnnuel = cjByYear[year];
        if (fdr && cjAnnuel) {
          const coutParJour = cjAnnuel / 360;
          const fdrJours = (fdr * 360) / cjAnnuel;
          fdrValEl.textContent = "FDR : " + formatEuro(fdr);
          fdrCjEl.textContent = "Coût journalier de l'établissement : " + formatEuro(coutParJour);
          fdrDaysEl.textContent = "Nombre de jours de FDR : " + fdrJours.toFixed(1) + " jours";
          infoEl.textContent = "CJ (Σ comptes 60x-65x pour " + year + ") : " + formatEuro(cjAnnuel) + ".";
        }
      }

      if (cafByYear[year]) {
        const caf = cafByYear[year].caf || 0;
        if (caf >= 0) {
          fdrCafEl.textContent = "CAF : " + formatEuro(caf);
        } else {
          fdrCafEl.textContent = "IAF : " + formatEuro(-caf);
        }
      } else {
        fdrCafEl.textContent = "CAF / IAF : données insuffisantes.";
      }

      if (kpiDeltaFdrEl && kpiDeltaFdrSubEl && fdrByYear[year] && fdrByYear[year].hasDef) {
        const prevYear = year - 1;
        if (fdrByYear[prevYear] && fdrByYear[prevYear].hasDef) {
          const delta = fdrByYear[year].definitif - fdrByYear[prevYear].definitif;
          const signe = delta > 0 ? "+" : "";
          kpiDeltaFdrEl.textContent = signe + formatEuro(delta);
          kpiDeltaFdrSubEl.textContent = "FDR " + year + " : " + formatEuro(fdrByYear[year].definitif) +
            " / " + prevYear + " : " + formatEuro(fdrByYear[prevYear].definitif);
        } else {
          kpiDeltaFdrEl.textContent = "–";
          kpiDeltaFdrSubEl.textContent = "FDR N-1 non disponible.";
        }
      }
    }

    function updateZoomPedagogique(apDep, totalDep, apBudget, apReste, mandats, budgetsServ) {
      const depEl = document.getElementById('zoom-ap-dep');
      const partDepEl = document.getElementById('zoom-ap-part-dep');
      const budgetEl = document.getElementById('zoom-ap-budget');
      const resteEl = document.getElementById('zoom-ap-reste');
      const partBudgetEl = document.getElementById('zoom-ap-part-budget');
      const ratioEl = document.getElementById('zoom-ap-ratio');

      if (!depEl || !partDepEl || !budgetEl || !resteEl || !partBudgetEl || !ratioEl) return;

      depEl.innerText = formatEuro(apDep);
      partDepEl.innerText = totalDep > 0 ? (apDep * 100 / totalDep).toFixed(1) + " %" : "–";
      budgetEl.innerText = formatEuro(apBudget);
      resteEl.innerText = formatEuro(apReste);

      if (budgetDep > 0 && apBudget > 0) {
        partBudgetEl.innerText = (apBudget * 100 / budgetDep).toFixed(1) + " %";
      } else {
        partBudgetEl.innerText = "–";
      }

      const nbAutres = SERVICES_CLES.length - 1;
      const totalAutres = totalDep - apDep;
      let ratio = null;
      if (nbAutres > 0 && totalAutres > 0 && apDep > 0) {
        const moyenneAutres = totalAutres / nbAutres;
        ratio = apDep / moyenneAutres;
        ratioEl.innerText = ratio.toFixed(2) + " ×";
      } else {
        ratioEl.innerText = "–";
      }
    }

    function updateZoomSRH(srhDep, srhRec, srhBudget, totalDep) {
      const depEl = document.getElementById('zoom-srh-dep');
      const partDepEl = document.getElementById('zoom-srh-part-dep');
      const recEl = document.getElementById('zoom-srh-rec');
      const tauxCouvEl = document.getElementById('zoom-srh-taux-couv');
      const resEl = document.getElementById('zoom-srh-resultat');

      if (!depEl || !partDepEl || !recEl || !tauxCouvEl || !resEl) return;

      depEl.innerText = formatEuro(srhDep);
      recEl.innerText = formatEuro(srhRec);

      const resultat = srhRec - srhDep;
      resEl.innerText = formatEuro(resultat);

      partDepEl.innerText =
        (totalDep > 0 && srhDep > 0)
          ? (srhDep * 100 / totalDep).toFixed(1) + " %"
          : "–";

      if (srhDep > 0 && srhRec >= 0) {
        const taux = (srhRec * 100 / srhDep);
        tauxCouvEl.innerText = taux.toFixed(1) + " %";
      } else {
        tauxCouvEl.innerText = "–";
      }
    }

    function updateSrhDepRecChart(srhDep, srhRec) {
      const canvas = document.getElementById('chart-srh-dep-rec');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      if (chartSrhDepRec) {
        chartSrhDepRec.destroy();
      }

      chartSrhDepRec = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Dépenses SRH', 'Recettes SRH'],
          datasets: [{
            label: 'Montants SRH (exercice en cours)',
            data: [srhDep, srhRec],
            backgroundColor: ['rgba(231, 76, 60, 0.8)', 'rgba(46, 204, 113, 0.8)'],
            borderColor: ['#e74c3c', '#27ae60'],
            borderWidth: 1
          },]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: "#000000", font: { size: 11 } }
            },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.label} : ${formatEuro(ctx.raw)}`
              }
            },
            datalabels: {
              color: '#000000',
              anchor: 'end',
              align: 'right',
              font: { size: 10, weight: 'bold' },
              formatter: value => value > 0 ? formatEuro(value) : ''
            }
          },
          scales: {
            x: {
              ticks: {
                color: "#000000",
                font: { size: 10 },
                callback: value => formatK(value)
              }
            },
            y: {
              ticks: { color: "#000000", font: { size: 11 } }
            }
          }
        }
      });
    }

    function updateSrhMensuelChart() {
      const canvas = document.getElementById('chart-srh-mensuel');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      if (chartSrhMensuel) {
        chartSrhMensuel.destroy();
      }

      chartSrhMensuel = new Chart(ctx, {
        data: {
          labels: MOIS_LABELS,
          datasets: [
            {
              type: 'line',
              label: 'Dépenses SRH par mois',
              data: depMensuelSRH,
              borderColor: '#e74c3c',
              borderWidth: 2,
              tension: 0.25,
              fill: false
            },
            {
              type: 'line',
              label: 'Recettes SRH par mois',
              data: recMensuelSRH,
              borderColor: '#3498db',
              borderWidth: 2,
              tension: 0.25,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: "#000000", font: { size: 11 } }
            },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.dataset.label} : ${formatEuro(ctx.raw)}`
              }
            },
            datalabels: {
              display: false
            }
          },
          scales: {
            x: {
              ticks: { color: "#000000", font: { size: 10 } }
            },
            y: {
              beginAtZero: true,
              ticks: {
                color: "#000000",
                font: { size: 10 },
                callback: v => formatK(v)
              }
            }
          }
        }
      });
    }

    function initSrhDelaisTable() {
      const tbody = document.getElementById('srh-delais-tbody');
      if (!tbody) return;

      tbody.innerHTML = '';
      MOIS_LABELS.forEach((mois, index) => {
        const tr = document.createElement('tr');

        const tdMois = document.createElement('td');
        tdMois.textContent = mois;
        tr.appendChild(tdMois);

        const makeInputCell = (field, step) => {
          const td = document.createElement('td');
          const input = document.createElement('input');
          input.type = 'number';
          input.min = '0';
          input.step = step || '1';
          input.classList.add('srh-input');
          input.dataset.field = field;
          input.dataset.monthIndex = index;
          input.addEventListener('input', recalcSrhDelais);
          td.appendChild(input);
          return td;
        };

        tr.appendChild(makeInputCell('tr', '1'));      // nb TR
        tr.appendChild(makeInputCell('ratt', '0.1'));  // délai rattachement
        tr.appendChild(makeInputCell('regl', '0.1'));  // délai règlement

        tbody.appendChild(tr);
      });

      recalcSrhDelais();
    }

    function recalcSrhDelais() {
      const inputs = document.querySelectorAll('.srh-input');
      if (!inputs.length) return;

      const trParMois = new Array(MOIS_LABELS.length).fill(0);
      const delaiRattParMois = new Array(MOIS_LABELS.length).fill(null);
      const delaiReglParMois = new Array(MOIS_LABELS.length).fill(null);

      inputs.forEach(input => {
        const idx = parseInt(input.dataset.monthIndex, 10);
        const field = input.dataset.field;
        const val = input.value === '' ? null : parseFloat(input.value.replace(',', '.'));

        if (Number.isNaN(idx) || idx < 0 || idx >= MOIS_LABELS.length) return;

        if (field === 'tr' && val !== null && !isNaN(val)) {
          trParMois[idx] = val;
        }
        if (field === 'ratt') {
          delaiRattParMois[idx] = (val !== null && !isNaN(val)) ? val : null;
        }
        if (field === 'regl') {
          delaiReglParMois[idx] = (val !== null && !isNaN(val)) ? val : null;
        }
      });

      // KPIs globaux (simples)
      const totalTR = trParMois.reduce((a, b) => a + (b || 0), 0);
      const delaisRatt = delaiRattParMois.filter(v => v !== null && !isNaN(v));
      const delaisRegl = delaiReglParMois.filter(v => v !== null && !isNaN(v));

      const moyRatt = delaisRatt.length ? (delaisRatt.reduce((a,b)=>a+b,0) / delaisRatt.length) : null;
      const moyRegl = delaisRegl.length ? (delaisRegl.reduce((a,b)=>a+b,0) / delaisRegl.length) : null;

      const trEl = document.getElementById('zoom-srh-tr-retard');
      const rattEl = document.getElementById('zoom-srh-delai-ratt-moy');
      const reglEl = document.getElementById('zoom-srh-delai-regl-moy');

      if (trEl) trEl.textContent = totalTR > 0 ? (totalTR + " TR en retard") : "Aucun TR en retard saisi";
      if (rattEl) rattEl.textContent = moyRatt !== null ? moyRatt.toFixed(1) + " j" : "–";
      if (reglEl) reglEl.textContent = moyRegl !== null ? moyRegl.toFixed(1) + " j" : "–";

      updateSrhDelaisChart(trParMois, delaiReglParMois);
    }

    function updateSrhDelaisChart(trParMois, delaiReglParMois) {
      const canvas = document.getElementById('chart-srh-delais');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      if (chartSrhDelais) {
        chartSrhDelais.destroy();
      }

      chartSrhDelais = new Chart(ctx, {
        data: {
          labels: MOIS_LABELS,
          datasets: [
            {
              type: 'bar',
              label: 'TR SRH en retard',
              data: trParMois,
              backgroundColor: 'rgba(231, 76, 60, 0.7)',
              borderColor: '#e74c3c',
              borderWidth: 1,
              yAxisID: 'y'
            },
            {
              type: 'line',
              label: 'Délai moyen de règlement (jours)',
              data: delaiReglParMois.map(v => v === null ? null : v),
              borderColor: '#2980b9',
              borderWidth: 2,
              tension: 0.2,
              fill: false,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: "#000000", font: { size: 11 } }
            },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const lab = ctx.dataset.label || '';
                  const v = ctx.raw;
                  if (v === null || v === undefined) return lab + " : –";
                  if (ctx.datasetIndex === 0) {
                    return lab + " : " + v;
                  } else {
                    return lab + " : " + v.toFixed(1) + " j";
                  }
                }
              }
            },
            datalabels: { display: false }
          },
          scales: {
            y: {
              position: 'left',
              beginAtZero: true,
              ticks: { color: "#000000", font: { size: 10 } },
              title: { display: true, text: 'TR en retard', color: "#000000" }
            },
            y1: {
              position: 'right',
              beginAtZero: true,
              grid: { drawOnChartArea: false },
              ticks: { color: "#000000", font: { size: 10 } },
              title: { display: true, text: 'Délai moyen (jours)', color: "#000000" }
            },
            x: {
              ticks: { color: "#000000", font: { size: 10 } }
            }
          }
        }
      });
    }

    function parseFDRYear(v) {
      if (!v) return null;
      if (typeof v === 'number') {
        if (v > 1900 && v < 2100) return v;
      }
      const s = String(v);
      const m = s.match(/(\d{4})/);
      if (m) return parseInt(m[1], 10);
      return null;
    }

    function parseFDRMontant(v) {
      if (v === null || v === undefined) return NaN;
      if (typeof v === 'number') return v;
      let s = String(v).trim();
      s = s.replace(/\s/g, '').replace(',', '.');
      const num = parseFloat(s);
      return isNaN(num) ? NaN : num;
    }

    function labelServiceLong(code) {
      if (code === "AP") return "Activité pédagogique (AP)";
      if (code === "VE") return "Vie de l'élève (VE)";
      if (code === "ALO") return "Administration & Logistique (ALO)";
      if (code === "SRH") return "Restauration & Hébergement (SRH)";
      if (code === "OPC") return "Opérations communes (OPC)";
      return code;
    }

    function couleurPalette(i) {
      const base = [
        "#1abc9c","#3498db","#9b59b6","#e67e22","#e74c3c",
        "#2ecc71","#f1c40f","#16a085","#2980b9","#8e44ad",
        "#d35400","#27ae60","#f39c12","#7f8c8d"
      ];
      return base[i % base.length];
    }

    function formatEuro(v) {
      if (!v || isNaN(v)) return "0,00 €";
      return Number(v).toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €";
    }

    function formatK(v) {
      if (v >= 1000000) {
        return (v / 1000000).toFixed(1) + " M€";
      }
      if (v >= 1000) {
        return (v / 1000).toFixed(0) + " k€";
      }
      return v;
    }

    function toggleHelp(force) {
      const overlay = document.getElementById('help-overlay');
      if (!overlay) return;
      if (typeof force === "boolean") {
        overlay.style.display = force ? 'flex' : 'none';
      } else {
        overlay.style.display = (overlay.style.display === 'flex') ? 'none' : 'flex';
      }
    }

    // Bouton retour haut de page
    window.addEventListener('scroll', () => {
      const btn = document.getElementById('backToTop');
      if (!btn) return;
      if (window.scrollY > 300) {
        btn.style.display = 'block';
      } else {
        btn.style.display = 'none';
      }
    });
  

// ======================================================================
// === EBLC : lecture de la balance et calcul FDR / BFdR / ratios    ===
// ======================================================================

// Balance en mémoire : { "106810": { debit: 0, credit: 12345 }, ... }
let eblcBalance = null;

// ------------------------------
// 1. Utilitaires généraux
// ------------------------------

/**
 * Convertit un montant issu d'Excel en nombre JS.
 * Gère : "1 234,56", "1234.56", nombres, cellules vides...
 */
function parseAmountExcel(v) {
  if (v === null || v === undefined || v === "") return 0;
  if (typeof v === "number") return v;

  let s = String(v)
    .replace(/\u00A0/g, "") // espaces insécables
    .replace(/\s/g, "")     // tous les espaces
    .replace(",", ".");     // virgule -> point

  const n = parseFloat(s);
  if (isNaN(n)) return 0;
  return Math.round(n * 100) / 100;
}

/**
 * Somme les soldes (débit - crédit) des comptes dont le numéro vérifie un prédicat.
 */
function sumBalance(balance, predicate) {
  if (!balance) return 0;
  let total = 0;
  for (const [compte, { debit, credit }] of Object.entries(balance)) {
    if (!predicate(compte)) continue;
    const net = parseAmountExcel(debit) - parseAmountExcel(credit);
    total += net;
  }
  return total;
}

/**
 * Retourne le solde net (débit - crédit) d'un compte ou d'un groupe de comptes.
 * - accountStartsWith : "41", "60", etc.
 * - exactList : ["4081", "4282", ...]
 */
function sumByStartsWith(balance, startsWith) {
  return sumBalance(balance, c => c.startsWith(startsWith));
}

function sumByExactList(balance, list) {
  const set = new Set(list);
  return sumBalance(balance, c => set.has(c));
}

/**
 * Formatage en euros pour affichage KPI.
 */
function formatEuroFR(val) {
  if (val === null || val === undefined || isNaN(val)) return "–";
  return val.toLocaleString("fr-FR", {
    style: "currency",
    currency: "EUR",
    maximumFractionDigits: 0
  });
}

/**
 * Formatage en pourcentage.
 */
function formatPct(val) {
  if (val === null || val === undefined || isNaN(val)) return "–";
  return val.toFixed(1).replace(".", ",") + " %";
}

/**
 * Formatage en nombre de jours.
 */
function formatDays(val) {
  if (val === null || val === undefined || isNaN(val)) return "–";
  return val.toFixed(0) + " j";
}

// ------------------------------
// 2. Parsing EBLC (XLS / XLSX)
// ------------------------------

/**
 * Parse un fichier EBLC Excel (XLS/XLSX) au format EPLE actuel :
 * - ligne d'en-têtes en ligne 7 (index 6)
 * - première colonne = comptes (avec ou sans libellé)
 * - plusieurs paires Débit / Crédit -> on prend la DERNIÈRE (solde final)
 * Retourne : Promise<balanceObject>.
 */
async function parseEBLC_XLS(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = function (e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });

        // On cherche une feuille contenant "BALANCE" sinon la 1ère.
        const sheetName =
          workbook.SheetNames.find(n => n.toUpperCase().includes("BALANCE")) ||
          workbook.SheetNames[0];

        const sheet = workbook.Sheets[sheetName];

        const rows = XLSX.utils.sheet_to_json(sheet, {
          header: 1,
          raw: true
        });

        if (!rows || rows.length === 0) {
          console.warn("EBLC vide ou illisible");
          resolve({});
          return;
        }

        // ----- En-têtes en ligne 7 (index 6) -----
        if (!rows[6]) {
          console.warn("Format EBLC inattendu : ligne d'en-têtes manquante");
          resolve({});
          return;
        }

        const header = rows[6].map(c => (c == null ? "" : String(c).trim()));
        console.log("EBLC – En-têtes détectés ligne 7 :", header);

        // Normalisation pour recherche insensible aux accents/majuscules
        const normalize = (s) =>
          (s == null ? "" : String(s))
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toUpperCase();

        const headerNorm = header.map(normalize);

        function findCol(keywords) {
          return headerNorm.findIndex(h => {
            if (typeof h !== "string") return false;
            return keywords.every(kw => h.includes(kw));
          });
        }

        // ----- Détection colonne COMPTE -----
        let colCompte = findCol(["NUMERO", "COMPTE"]);
        if (colCompte === -1) {
          colCompte = 0; // Fallback : 1ère colonne = numéros de comptes
        }

        // ----- Détection colonnes Débit / Crédit : on prend la DERNIÈRE paire -----
        const debitIdx = [];
        const creditIdx = [];

        headerNorm.forEach((h, i) => {
          if (typeof h !== "string") return;
          if (h.includes("DEBIT")) debitIdx.push(i);
          if (h.includes("CREDIT")) creditIdx.push(i);
        });

        let colDebit = debitIdx.length ? debitIdx[debitIdx.length - 1] : -1;
        let colCredit = creditIdx.length ? creditIdx[creditIdx.length - 1] : -1;

        if (colCompte === -1 || (colDebit === -1 && colCredit === -1)) {
          console.warn(
            "Impossible de détecter les colonnes EBLC. En-têtes lus :",
            header
          );
          resolve({});
          return;
        }

        console.log(
          "EBLC – colonnes utilisées → compte:",
          colCompte,
          "débit:",
          colDebit,
          "crédit:",
          colCredit
        );

        // ----- Détection automatique de la première ligne de comptes -----
        let dataStartRow = 7; // par défaut (ligne Excel 8)
        const regexCompte = /\d{3,}/; // au moins 3 chiffres consécutifs

        for (let i = 7; i < rows.length; i++) {
          const row = rows[i];
          if (!row || row.length === 0) continue;

          const cellCompte = row[colCompte];
          if (cellCompte == null || cellCompte === "") continue;

          const brut = String(cellCompte).trim();
          const match = brut.replace(/\s/g, "").match(regexCompte);
          if (match) {
            dataStartRow = i;
            break;
          }
        }

        console.log(
          "EBLC – première ligne de compte détectée à l'index",
          dataStartRow,
          "(ligne Excel",
          dataStartRow + 1,
          ")"
        );

        // ----- Construction de la balance -----
        const balance = {};

        for (let i = dataStartRow; i < rows.length; i++) {
          const row = rows[i];
          if (!row || row.length === 0) continue;

          const cellCompte = row[colCompte];
          if (cellCompte == null || cellCompte === "") continue;

          const brut = String(cellCompte).trim();
          const match = brut.replace(/\s/g, "").match(regexCompte);
          if (!match) continue;

          const compte = match[0]; // ex : "106810" dans "106810  RESERVES"

          const debitRaw = colDebit !== -1 ? row[colDebit] : null;
          const creditRaw = colCredit !== -1 ? row[colCredit] : null;

          if (debitRaw == null && creditRaw == null) continue;

          const debit = parseAmountExcel(debitRaw);
          const credit = parseAmountExcel(creditRaw);

          if (debit === 0 && credit === 0) continue;

          balance[compte] = { debit, credit };
        }

        console.log(
          "📘 Balance EBLC XLS/XLSX parsée – comptes trouvés :",
          Object.keys(balance).length,
          balance
        );
        resolve(balance);
      } catch (err) {
        console.error("Erreur parseEBLC_XLS :", err);
        reject(err);
      }
    };

    reader.onerror = (err) => reject(err);
    reader.readAsArrayBuffer(file);
  });
}

/**
 * Wrapper unique : pour .xls / .xlsx on passe par parseEBLC_XLS.
 */
async function parseEBLC(file) {
  const name = file.name.toLowerCase();
  if (name.endsWith(".xls") || name.endsWith(".xlsx")) {
    return parseEBLC_XLS(file);
  }
  throw new Error("Format EBLC non supporté (seulement .xls / .xlsx).");
}

// ------------------------------
// 3. Calcul des indicateurs à partir de la balance
// ------------------------------

/**
 * Calcule FDR, BFdR, TN, jours, TmCAP, TnR à partir de la balance EBLC.
 * Rappel des formules simplifiées (approche EPLE) :
 * - FDR = Capitaux permanents – Actif immobilisé
 * - BFdR = Actif circulant – Dettes d'exploitation et hors exploitation
 * - Trésorerie nette = FDR – BFdR
 * - Jours de FDR = FDR / charges nettes (60 à 65 hors 656) × 360
 * - Jours de TN = TN / charges nettes (60 à 65 hors 656) × 360
 * - TmCAP = (4081, 4282/4286, 4382/4386, 4686) / charges 60 à 65
 * - TnR = (compte 41 / produits du compte 70) × 100
 * :contentReference[oaicite:1]{index=1}
 */
function computeEBLCAggregates(balance) {
  if (!balance) return null;

  // 1) Charges nettes 60 à 65 hors 656 (dépenses)
  const chargesNettes = sumBalance(balance, c => {
    if (!c.startsWith("6")) return false;
    if (c.startsWith("656")) return false;
    const num = parseInt(c, 10);
    return num >= 600 && num < 660;
  });

  // 2) Produits 70 (recettes)
  const produits70 = sumBalance(balance, c => c.startsWith("7"));

  // 3) Capitaux permanents (classe 1 hors 18x) + dettes financières 16
  const capitauxPermanents = sumBalance(balance, c => {
    const num = parseInt(c, 10);
    if (isNaN(num)) return false;
    // 10 à 15 = fonds propres, réserves, résultats, etc.
    if (num >= 100 && num < 160) return true;
    // 16 = dettes financières
    if (num >= 160 && num < 170) return true;
    return false;
  });

  // 4) Actif immobilisé (classe 2)
  const actifImmobilise = sumBalance(balance, c => c.startsWith("2"));

  // 5) Actif circulant (comptes 3 et 4 d'actif : stocks, créances, etc.)
  const actifCirculant = sumBalance(balance, c => {
    const num = parseInt(c, 10);
    if (isNaN(num)) return false;
    // Classe 3 : stocks et en-cours
    if (num >= 300 && num < 400) return true;
    // Classe 4 : créances / comptes de tiers (actif)
    if (num >= 400 && num < 500) return true;
    return false;
  });

  // 6) Dettes d'exploitation et hors exploitation (certains 4xx côté passif)
  const dettesExploit = sumBalance(balance, c => {
    const num = parseInt(c, 10);
    if (isNaN(num)) return false;
    // 40x fournisseurs, 42x personnels, 43x organismes sociaux, 46x divers
    if (num >= 400 && num < 480) return true;
    return false;
  });

  // 7) Trésorerie (classe 5)
  const tresorerie = sumBalance(balance, c => c.startsWith("5"));

  // 8) FDR, BFdR, TN
  const fdr = capitauxPermanents - actifImmobilise;
  const bfdr = actifCirculant - dettesExploit;
  const tresorerieNette = fdr - bfdr; // cohérent avec relation FDR = BFdR + TN

  // 9) Jours de FDR & Jours de trésorerie
  const baseCharges = Math.abs(chargesNettes);
  const joursFDR =
    baseCharges > 0 ? (fdr * 360) / baseCharges : NaN;
  const joursTN =
    baseCharges > 0 ? (tresorerieNette * 360) / baseCharges : NaN;

  // 10) TmCAP – Taux de charges à payer
  const tmcapNumerateur = sumByExactList(balance, [
    "4081",
    "4282",
    "4286",
    "4382",
    "4386",
    "4686"
  ]);
  const tmcap =
    baseCharges !== 0 ? Math.abs(tmcapNumerateur) / Math.abs(baseCharges) * 100 : NaN;

  // 11) TnR – Taux de non-recouvrement
  const creances41 = sumBalance(balance, c => c.startsWith("41"));
  const tnr =
    produits70 !== 0 ? Math.abs(creances41) / Math.abs(produits70) * 100 : NaN;

  return {
    chargesNettes,
    produits70,
    capitauxPermanents,
    actifImmobilise,
    actifCirculant,
    dettesExploit,
    tresorerie,
    fdr,
    bfdr,
    tresorerieNette,
    joursFDR,
    joursTN,
    tmcap,
    tnr
  };
}

// ------------------------------
// 4. Mise à jour des KPI dans le DOM
// ------------------------------

function updateEBLCKPIs(aggr) {
  if (!aggr) return;

  const {
    fdr,
    bfdr,
    tresorerieNette,
    joursFDR,
    joursTN,
    tmcap,
    tnr
  } = aggr;

  // FDR
  const elFdrVal = document.getElementById("kpi-fdr-valeur");
  const elFdrDetail = document.getElementById("kpi-fdr-detail");
  if (elFdrVal) elFdrVal.textContent = formatEuroFR(fdr);
  if (elFdrDetail) {
    elFdrDetail.textContent =
      "Fonds de roulement = capitaux permanents – actif immobilisé.";
  }

  // BFdR
  const elBfdrVal = document.getElementById("kpi-bfdr-valeur");
  const elBfdrDetail = document.getElementById("kpi-bfdr-detail");
  const elBfdrBadge = document.getElementById("kpi-bfdr-badge");
  const elBfdrDiag = document.getElementById("kpi-bfdr-diagnostic");
  if (elBfdrVal) elBfdrVal.textContent = formatEuroFR(bfdr);
  if (elBfdrDetail) {
    elBfdrDetail.textContent =
      "Actif circulant – dettes d'exploitation et hors exploitation.";
  }
  if (elBfdrBadge) {
    elBfdrBadge.textContent = bfdr >= 0 ? "BFdR positif" : "BFdR négatif";
    elBfdrBadge.className =
      "badge bg-" + (bfdr >= 0 ? "success" : "danger") + " rounded-pill";
  }
  if (elBfdrDiag) {
    elBfdrDiag.textContent =
      bfdr >= 0
        ? "Un BFdR positif indique un excédent structurel de ressources à court terme."
        : "Un BFdR négatif traduit un besoin structurel de trésorerie (fonds de roulement insuffisant).";
  }

  // Jours de FDR
  const elJoursFdr = document.getElementById("kpi-jours-fdr");
  const elJoursFdrBadge = document.getElementById("kpi-jours-fdr-badge");
  const elJoursFdrDiag = document.getElementById("kpi-jours-fdr-diagnostic");
  if (elJoursFdr) elJoursFdr.textContent = formatDays(joursFDR);
  if (elJoursFdrBadge) {
    let label = "En analyse";
    let cls = "secondary";
    if (!isNaN(joursFDR)) {
      if (joursFDR >= 30) {
        label = "Zone de confort";
        cls = "success";
      } else if (joursFDR >= 15) {
        label = "Acceptable";
        cls = "warning";
      } else {
        label = "Sous tension";
        cls = "danger";
      }
    }
    elJoursFdrBadge.textContent = label;
    elJoursFdrBadge.className = "badge bg-" + cls + " rounded-pill";
  }
  if (elJoursFdrDiag) {
    elJoursFdrDiag.textContent =
      "Plus le nombre de jours de FDR est élevé, plus l'établissement dispose de marge de manœuvre financière.";
  }

  // Jours de trésorerie
  const elJoursTN = document.getElementById("kpi-jours-tresorerie");
  const elJoursTnBadge = document.getElementById("kpi-jours-tn-badge");
  const elJoursTnDiag = document.getElementById("kpi-jours-tn-diagnostic");
  if (elJoursTN) elJoursTN.textContent = formatDays(joursTN);
  if (elJoursTnBadge) {
    let label = "En analyse";
    let cls = "secondary";
    if (!isNaN(joursTN)) {
      if (joursTN >= 20) {
        label = "Trésorerie confortable";
        cls = "success";
      } else if (joursTN >= 10) {
        label = "Zone de vigilance";
        cls = "warning";
      } else {
        label = "Trésorerie fragile";
        cls = "danger";
      }
    }
    elJoursTnBadge.textContent = label;
    elJoursTnBadge.className = "badge bg-" + cls + " rounded-pill";
  }
  if (elJoursTnDiag) {
    elJoursTnDiag.textContent =
      "Nombre de jours de charges pouvant être financés par la trésorerie nette.";
  }

  // Trésorerie nette
  const elTN = document.getElementById("kpi-tresorerie-nette");
  const elTNBadge = document.getElementById("kpi-tn-badge");
  const elTNDIag = document.getElementById("kpi-tn-diagnostic");
  if (elTN) elTN.textContent = formatEuroFR(tresorerieNette);
  if (elTNBadge) {
    let label = "En analyse";
    let cls = "secondary";
    if (!isNaN(tresorerieNette)) {
      if (tresorerieNette > 0) {
        label = "Trésorerie nette positive";
        cls = "success";
      } else if (tresorerieNette === 0) {
        label = "Équilibre";
        cls = "warning";
      } else {
        label = "Trésorerie nette négative";
        cls = "danger";
      }
    }
    elTNBadge.textContent = label;
    elTNBadge.className = "badge bg-" + cls + " rounded-pill";
  }
  if (elTNDIag) {
    elTNDIag.textContent =
      "Trésorerie nette = Fonds de roulement – Besoin en fonds de roulement.";
  }

  // TmCAP
  const elTmcap = document.getElementById("kpi-tmcap");
  const elTmcapBadge = document.getElementById("kpi-tmcap-badge");
  const elTmcapDiag = document.getElementById("kpi-tmcap-diagnostic");
  if (elTmcap) elTmcap.textContent = formatPct(tmcap);
  if (elTmcapBadge) {
    let label = "En analyse";
    let cls = "secondary";
    if (!isNaN(tmcap)) {
      if (tmcap < 5) {
        label = "Faible taux de charges à payer";
        cls = "success";
      } else if (tmcap < 10) {
        label = "Zone de vigilance";
        cls = "warning";
      } else {
        label = "Charges à payer élevées";
        cls = "danger";
      }
    }
    elTmcapBadge.textContent = label;
    elTmcapBadge.className = "badge bg-" + cls + " rounded-pill";
  }
  if (elTmcapDiag) {
    elTmcapDiag.textContent =
      "TmCAP = (4081, 4282/4286, 4382/4386, 4686) / charges 60 à 65.";
  }

  // TnR
  const elTnr = document.getElementById("kpi-tnr");
  const elTnrBadge = document.getElementById("kpi-tnr-badge");
  const elTnrDiag = document.getElementById("kpi-tnr-diagnostic");
  if (elTnr) elTnr.textContent = formatPct(tnr);
  if (elTnrBadge) {
    let label = "En analyse";
    let cls = "secondary";
    if (!isNaN(tnr)) {
      if (tnr < 5) {
        label = "Bon recouvrement";
        cls = "success";
      } else if (tnr < 10) {
        label = "Zone de vigilance";
        cls = "warning";
      } else {
        label = "Non-recouvrement élevé";
        cls = "danger";
      }
    }
    elTnrBadge.textContent = label;
    elTnrBadge.className = "badge bg-" + cls + " rounded-pill";
  }
  if (elTnrDiag) {
    elTnrDiag.textContent =
      "TnR = (compte 41 / produits du compte 70) × 100.";
  }
}

// ------------------------------
// 5. Rattachement à l'input <input id="file-balance">
// ------------------------------

const fileBalanceEl = document.getElementById("file-balance");
if (fileBalanceEl) {
  fileBalanceEl.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Si tu as déjà showFileLoading/hideFileLoading, tu peux les appeler ici
    if (typeof showFileLoading === "function") {
      showFileLoading(`Traitement de la balance EBLC « ${file.name} »…`);
    }

    try {
      const balance = await parseEBLC(file);
      eblcBalance = balance;

      // Sauvegarde éventuelle dans localStorage
      try {
        localStorage.setItem("eblcBalance_v1", JSON.stringify(balance));
      } catch (err) {
        console.error("Impossible de mémoriser la balance EBLC :", err);
      }

      const aggr = computeEBLCAggregates(balance);
      updateEBLCKPIs(aggr);
    } catch (err) {
      console.error("Erreur lors du traitement EBLC :", err);
      alert("Impossible de lire la balance EBLC. Vérifiez le format de l'export.");
    } finally {
      if (typeof hideFileLoading === "function") {
        hideFileLoading();
      }
    }
  });
}

// Chargement automatique de la balance depuis localStorage au démarrage
window.addEventListener("DOMContentLoaded", () => {
  try {
    const saved = localStorage.getItem("eblcBalance_v1");
    if (saved) {
      const balance = JSON.parse(saved);
      eblcBalance = balance;
      const aggr = computeEBLCAggregates(balance);
      updateEBLCKPIs(aggr);
    }
  } catch (err) {
    console.error("Erreur lors du rechargement de la balance EBLC :", err);
  }
});



// From testTBDBudget.html - <body> script block

    function budgetApp() {
      const LS_DEP_SOURCE = 'tbdbudget_dep_rawSource';
      const LS_REC_SOURCE = 'tbdbudget_rec_rawSource';
      const LS_DEP_NORM   = 'tbdbudget_dep_norm';
      const LS_REC_NORM   = 'tbdbudget_rec_norm';

      return {
        /* Données brutes Excel (lignes telles que lues dans la feuille) */
        rawDepSource: [],
        rawRecSource: [],

        /* Données normalisées (celles utilisées par les graphiques) */
        rawDep: [],
        rawRec: [],

        /* Filtres séparés (sans exercice) */
        filtersDep: { service: 'all', nature: 'all' },
        filtersRec: { service: 'all', nature: 'all' },

        servicesDep: [],
        naturesDep: [],
        servicesRec: [],
        naturesRec: [],

        /* Sunburst metrics */
        sunMetricDep: 'budgetExec',
        sunMetricRec: 'budgetExec',
        sunMetricOptions: [
          { key: 'budgetExec', label: 'Budget exécutoire' },
          { key: 'realise',    label: 'Réalisé comptable' },
          { key: 'dispo',      label: 'Disponible' }
        ],

        /* Focus sunburst -> waterfall */
        focusDepCode: null,
        focusDepLabel: 'Global (filtres)',
        focusRecCode: null,
        focusRecLabel: 'Global (filtres)',

        /* Totaux pour waterfall */
        totalsDep: null,
        totalsRec: null,

        async init() {
          this.loadFromStorage();

          // Si pas de données normalisées, on injecte un jeu de démo en dépenses
          if (!this.rawDep.length && !this.rawRec.length) {
            this.rawDep = await this.fakeLoadDep();
            this.rawDepSource = []; // démo : pas d'Excel brut
          }

          this.refreshDepFilters();
          this.refreshRecFilters();
          this.refreshDep();
          this.refreshRec();
        },

        /* ---------- LocalStorage ---------- */

        loadFromStorage() {
          try {
            const depSrcStr  = localStorage.getItem(LS_DEP_SOURCE);
            const recSrcStr  = localStorage.getItem(LS_REC_SOURCE);
            const depNormStr = localStorage.getItem(LS_DEP_NORM);
            const recNormStr = localStorage.getItem(LS_REC_NORM);

            if (depSrcStr)  this.rawDepSource = JSON.parse(depSrcStr);
            if (recSrcStr)  this.rawRecSource = JSON.parse(recSrcStr);
            if (depNormStr) this.rawDep       = JSON.parse(depNormStr);
            if (recNormStr) this.rawRec       = JSON.parse(recNormStr);
          } catch (e) {
            console.warn('Erreur localStorage (lecture) :', e);
            this.rawDepSource = [];
            this.rawRecSource = [];
            this.rawDep = [];
            this.rawRec = [];
          }
        },

        saveToStorage() {
          try {
            localStorage.setItem(LS_DEP_SOURCE, JSON.stringify(this.rawDepSource || []));
            localStorage.setItem(LS_REC_SOURCE, JSON.stringify(this.rawRecSource || []));
            localStorage.setItem(LS_DEP_NORM,   JSON.stringify(this.rawDep || []));
            localStorage.setItem(LS_REC_NORM,   JSON.stringify(this.rawRec || []));
          } catch (e) {
            console.warn('Erreur localStorage (écriture) :', e);
          }
        },

        clearStorage() {
          try {
            localStorage.removeItem(LS_DEP_SOURCE);
            localStorage.removeItem(LS_REC_SOURCE);
            localStorage.removeItem(LS_DEP_NORM);
            localStorage.removeItem(LS_REC_NORM);
          } catch (e) {
            console.warn('Erreur localStorage (suppression) :', e);
          }

          this.rawDepSource = [];
          this.rawRecSource = [];
          this.rawDep = [];
          this.rawRec = [];
          this.filtersDep = { service: 'all', nature: 'all' };
          this.filtersRec = { service: 'all', nature: 'all' };
          this.servicesDep = [];
          this.naturesDep  = [];
          this.servicesRec = [];
          this.naturesRec  = [];
          this.focusDepCode = null;
          this.focusDepLabel = 'Global (filtres)';
          this.focusRecCode = null;
          this.focusRecLabel = 'Global (filtres)';
          this.totalsDep = null;
          this.totalsRec = null;

          d3.select('#sunburstDep').selectAll('*').remove();
          d3.select('#waterfallDep').selectAll('*').remove();
          d3.select('#sunburstRec').selectAll('*').remove();
          d3.select('#waterfallRec').selectAll('*').remove();
        },

        /* ---------- Upload fichiers ---------- */

        handleFileDep(event) {
          const file = event.target.files[0];
          if (!file) return;

          // RAZ de la mémoire Dépenses uniquement
          try {
            localStorage.removeItem(LS_DEP_SOURCE);
            localStorage.removeItem(LS_DEP_NORM);
          } catch (e) {
            console.warn('Erreur localStorage (suppression DEP) :', e);
          }
          this.rawDepSource = [];
          this.rawDep = [];
          this.filtersDep = { service: 'all', nature: 'all' };
          this.focusDepCode = null;
          this.focusDepLabel = 'Global (filtres)';
          this.totalsDep = null;
          d3.select('#sunburstDep').selectAll('*').remove();
          d3.select('#waterfallDep').selectAll('*').remove();

          const reader = new FileReader();
          reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });

            const sheetName = workbook.SheetNames.find(n => n.toUpperCase().includes('OBCHCGB')) || workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const rowsSource = XLSX.utils.sheet_to_json(sheet, { defval: null });

            this.rawDepSource = rowsSource;
            this.rawDep = this.normalizeRows(rowsSource, 'dep');

            this.saveToStorage();
            this.refreshDepFilters();
            this.refreshDep();
          };

          reader.readAsArrayBuffer(file);
        },

        handleFileRec(event) {
          const file = event.target.files[0];
          if (!file) return;

          // RAZ de la mémoire Recettes uniquement
          try {
            localStorage.removeItem(LS_REC_SOURCE);
            localStorage.removeItem(LS_REC_NORM);
          } catch (e) {
            console.warn('Erreur localStorage (suppression REC) :', e);
          }
          this.rawRecSource = [];
          this.rawRec = [];
          this.filtersRec = { service: 'all', nature: 'all' };
          this.focusRecCode = null;
          this.focusRecLabel = 'Global (filtres)';
          this.totalsRec = null;
          d3.select('#sunburstRec').selectAll('*').remove();
          d3.select('#waterfallRec').selectAll('*').remove();

          const reader = new FileReader();
          reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });

            const sheetName = workbook.SheetNames.find(n => n.toUpperCase().includes('OBCHPOB')) || workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const rowsSource = XLSX.utils.sheet_to_json(sheet, { defval: null });

            this.rawRecSource = rowsSource;
            this.rawRec = this.normalizeRows(rowsSource, 'rec');

            this.saveToStorage();
            this.refreshRecFilters();
            this.refreshRec();
          };

          reader.readAsArrayBuffer(file);
        },

        /* ---------- mapping & normalisation ---------- */

        mapRowCommon(row, type) {
          const pere     = row['Père'] ?? row['Pere'] ?? '*';
          const fils     = row['Fils'] ?? row['FILS'] ?? row['Code'] ?? row['CGR'] ?? row['Poste'] ?? row['POSTE'];
          const intitule = row['Intitulé'] ?? row['Intitule'] ?? '';

          const budgetExecBrut = row['Budget exécutoire']   ?? row['Budget exécutoire '] ?? row['Budget'] ?? 0;
          const engageBrut     = row['Engagé']              ?? row['Engage']             ?? 0;
          const encoursBrut    = row['En cours']            ?? row['En_cours']           ?? 0;
          const realiseBrut    = row['Réalisé comptable']   ?? row['Réalisé']            ?? row['Realise comptable'] ?? 0;
          const dispoBrut      = row['Disponible']          ?? 0;

          const budgetExec = Number(budgetExecBrut) || 0;
          const engage     = Number(engageBrut)     || 0;
          const enCours    = Number(encoursBrut)    || 0;
          const realise    = Number(realiseBrut)    || 0;
          const dispo      = Number(dispoBrut)      || 0;

          const nature  = row['Nature'] ?? row['NATURE'] ?? row['Niveau'] ?? '';
          const service = row['CGR'] ?? row['Poste'] ?? row['POSTE'] ?? '';

          return {
            type,
            Père: pere,
            Fils: fils,
            Intitulé: intitule,
            budgetExec,
            engage,
            enCours,
            realise,
            dispo,
            Exercice: row['Exercice'] ?? row['EXERCICE'] ?? 'N/A',
            CGR: service,
            Nature: nature
          };
        },

        normalizeRows(rows, type) {
          return rows
            .map(row => this.mapRowCommon(row, type))
            .filter(r => r && r.Fils);
        },

        /* ---------- Détection OS/REC ---------- */

        isRowOSRec(row) {
          const nat = (row.Nature || '').toString().toUpperCase();
          return nat.includes('OS');
        },

        /* ---------- Jeu de démo Dépenses ---------- */
        fakeLoadDep() {
          return Promise.resolve([
            { type:'dep', Père:'*',   Fils:'ETS',    Intitulé:'Etablissement',          budgetExec:881564.28, engage:516925.09, enCours:55282.60, realise:461642.49, dispo:364639.19, Exercice:2025, CGR:'ETS',    Nature:'GLO' }
          ]);
        },

        /* ---------- Filtres & agrégation (dépenses) ---------- */

        refreshDepFilters() {
          const rows = this.rawDep;
          this.servicesDep = [...new Set(rows.map(r => r.CGR))].filter(v => v);
          this.naturesDep  = [...new Set(rows.map(r => r.Nature))].filter(v => v);
        },

        getFilteredDep() {
          let rows = this.rawDep;

          if (this.filtersDep.nature !== 'all') {
            rows = rows.filter(r => r.Nature == this.filtersDep.nature);
          }

          if (this.filtersDep.service !== 'all') {
            rows = this.subtreeRows(rows, this.filtersDep.service);
          }

          return rows;
        },

        resetDepFilters() {
          this.filtersDep = { service: 'all', nature: 'all' };
          this.refreshDep();
        },

        refreshDep() {
          const rows = this.getFilteredDep();
          const { root } = this.buildHierarchy(rows); // hiérarchie Père/Fils

          this.focusDepCode = null;
          this.focusDepLabel = 'Global (filtres)';

          this.renderSunburst('dep', root);
          this.computeTotalsDep();
          this.renderWaterfallDep();
        },

        /* ---------- Filtres & agrégation (recettes) ---------- */

        refreshRecFilters() {
          const rows = this.rawRec;
          this.servicesRec = [...new Set(rows.map(r => r.CGR))].filter(v => v); // = Poste
          this.naturesRec  = [...new Set(rows.map(r => r.Nature))].filter(v => v);
        },

        getFilteredRec() {
          let rows = this.rawRec;

          if (this.filtersRec.nature !== 'all') {
            rows = rows.filter(r => r.Nature == this.filtersRec.nature);
          }

          if (this.filtersRec.service !== 'all') {
            rows = this.subtreeRows(rows, this.filtersRec.service);
          }

          return rows;
        },

        resetRecFilters() {
          this.filtersRec = { service: 'all', nature: 'all' };
          this.refreshRec();
        },

        // construction spécifique pour le sunburst REC
        buildRecHierarchyForSunburst(rows) {
          const root = {
            name: 'REC',
            label: 'Recettes',
            metrics: { budgetExec: 0, engage: 0, enCours: 0, realise: 0, dispo: 0 },
            children: []
          };

          const nodeRecettes = {
            name: 'RECETTES',
            label: 'Recettes',
            metrics: { budgetExec: 0, engage: 0, enCours: 0, realise: 0, dispo: 0 },
            children: []
          };

          const nodeOS = {
            name: 'OS/REC',
            label: 'Opérations sur recettes',
            metrics: { budgetExec: 0, engage: 0, enCours: 0, realise: 0, dispo: 0 },
            children: []
          };

          const byCompte = {};
          rows.forEach(r => {
            if (!r.Fils) return;
            if (!byCompte[r.Fils]) byCompte[r.Fils] = [];
            byCompte[r.Fils].push(r);
          });

          Object.keys(byCompte).forEach(compte => {
            const group = byCompte[compte];
            const metrics = { budgetExec: 0, engage: 0, enCours: 0, realise: 0, dispo: 0 };
            let label = group[0].Intitulé || compte;
            let isOS = false;

            group.forEach(r => {
              metrics.budgetExec += r.budgetExec || 0;
              metrics.engage     += r.engage     || 0;
              metrics.enCours    += r.enCours    || 0;
              metrics.realise    += r.realise    || 0;
              metrics.dispo      += r.dispo      || 0;
              if (this.isRowOSRec(r)) isOS = true;
            });

            const childNode = {
              name: compte,
              label: label,
              metrics: metrics,
              children: []
            };

            if (isOS) {
              nodeOS.children.push(childNode);
              nodeOS.metrics.budgetExec += metrics.budgetExec;
              nodeOS.metrics.engage     += metrics.engage;
              nodeOS.metrics.enCours    += metrics.enCours;
              nodeOS.metrics.realise    += metrics.realise;
              nodeOS.metrics.dispo      += metrics.dispo;
            } else {
              nodeRecettes.children.push(childNode);
              nodeRecettes.metrics.budgetExec += metrics.budgetExec;
              nodeRecettes.metrics.engage     += metrics.engage;
              nodeRecettes.metrics.enCours    += metrics.enCours;
              nodeRecettes.metrics.realise    += metrics.realise;
              nodeRecettes.metrics.dispo      += metrics.dispo;
            }

            root.metrics.budgetExec += metrics.budgetExec;
            root.metrics.engage     += metrics.engage;
            root.metrics.enCours    += metrics.enCours;
            root.metrics.realise    += metrics.realise;
            root.metrics.dispo      += metrics.dispo;
          });

          if (nodeRecettes.children.length > 0) root.children.push(nodeRecettes);
          if (nodeOS.children.length > 0)       root.children.push(nodeOS);

          return root;
        },

        refreshRec() {
          const rows = this.getFilteredRec();
          const root = this.buildRecHierarchyForSunburst(rows);

          this.focusRecCode = null;
          this.focusRecLabel = 'Global (filtres)';

          this.renderSunburst('rec', root);
          this.computeTotalsRec();
          this.renderWaterfallRec();
        },

        /* ---------- Construction hiérarchie (générique pour dépenses) ---------- */

        buildHierarchy(rows) {
          const nodes = {};

          rows.forEach(row => {
            if (!row.Fils) return;

            if (!nodes[row.Fils]) {
              nodes[row.Fils] = {
                name: row.Fils,
                label: row.Intitulé,
                metrics: { budgetExec: 0, engage: 0, enCours: 0, realise: 0, dispo: 0 },
                children: []
              };
            }
            const m = nodes[row.Fils].metrics;
            m.budgetExec += row.budgetExec || 0;
            m.engage     += row.engage     || 0;
            m.enCours    += row.enCours    || 0;
            m.realise    += row.realise    || 0;
            m.dispo      += row.dispo      || 0;

            if (row.Père && !nodes[row.Père]) {
              nodes[row.Père] = {
                name: row.Père,
                label: '',
                metrics: { budgetExec: 0, engage: 0, enCours: 0, realise: 0, dispo: 0 },
                children: []
              };
            }
          });

          const keys = Object.keys(nodes);
          if (keys.length === 0) {
            return {
              root: {
                name: 'VIDE',
                label: 'Aucune donnée',
                metrics: { budgetExec: 0, engage: 0, enCours: 0, realise: 0, dispo: 0 },
                children: []
              },
              nodesMap: {}
            };
          }

          const rootKey = nodes['ETS'] ? 'ETS' : keys[0];
          const root = nodes[rootKey];

          rows.forEach(row => {
            const parent = nodes[row.Père];
            const child  = nodes[row.Fils];
            if (parent && child && !parent.children.includes(child)) {
              parent.children.push(child);
            }
          });

          return { root, nodesMap: nodes };
        },

        /* ---------- Sous-arbre & feuilles ---------- */

        subtreeRows(allRows, rootCode) {
          if (!rootCode) return allRows.slice();

          const codes = new Set([rootCode]);
          const queue = [rootCode];

          while (queue.length) {
            const current = queue.shift();
            allRows.forEach(r => {
              if (r.Père === current && !codes.has(r.Fils)) {
                codes.add(r.Fils);
                queue.push(r.Fils);
              }
            });
          }

          return allRows.filter(r => codes.has(r.Fils));
        },

        getLeafRows(rows) {
          const parents = new Set(
            rows
              .map(r => r.Père)
              .filter(p => p !== null && p !== undefined && p !== '')
          );
          return rows.filter(r => !parents.has(r.Fils));
        },

        /* ---------- Totaux & Waterfall Dépenses ---------- */

        computeTotalsDep() {
          let rows = this.getFilteredDep();
          if (this.focusDepCode) {
            rows = this.subtreeRows(rows, this.focusDepCode);
          }

          rows = this.getLeafRows(rows); // éviter les doubles comptes

          const totals = { budgetExec: 0, engage: 0, enCours: 0, realise: 0, dispo: 0 };
          rows.forEach(r => {
            totals.budgetExec += r.budgetExec || 0;
            totals.engage     += r.engage     || 0;
            totals.enCours    += r.enCours    || 0;
            totals.realise    += r.realise    || 0;
            totals.dispo      += r.dispo      || 0;
          });
          this.totalsDep = totals;
        },

        renderWaterfallDep() {
          // Barres bleues, ligne budget exécutoire jaune, ligne théorique bleu clair
          this.renderWaterfallGeneric(this.totalsDep, '#waterfallDep', '#6366f1', '#fbbf24');
        },

        /* ---------- Totaux & Waterfall Recettes ---------- */

        computeTotalsRec() {
          let rows = this.getFilteredRec();

          if (this.focusRecCode) {
            if (this.focusRecCode === 'REC') {
              // global
            } else if (this.focusRecCode === 'RECETTES') {
              rows = rows.filter(r => !this.isRowOSRec(r));
            } else if (this.focusRecCode === 'OS/REC') {
              rows = rows.filter(r => this.isRowOSRec(r));
            } else {
              rows = this.subtreeRows(rows, this.focusRecCode);
            }
          }

          rows = this.getLeafRows(rows); // éviter doubles comptes

          const totals = { budgetExec: 0, engage: 0, enCours: 0, realise: 0, dispo: 0 };
          rows.forEach(r => {
            totals.budgetExec += r.budgetExec || 0;
            totals.engage     += r.engage     || 0;
            totals.enCours    += r.enCours    || 0;
            totals.realise    += r.realise    || 0;
            totals.dispo      += r.dispo      || 0;
          });
          this.totalsRec = totals;
        },

        renderWaterfallRec() {
          // Barres bleues, ligne budget exécutoire jaune, ligne théorique bleu clair
          this.renderWaterfallGeneric(this.totalsRec, '#waterfallRec', '#22c55e', '#38bdf8');
        },

        /* ---------- Sunburst factorisé + dégradés ---------- */
        renderSunburst(side, rootData) {
          const metric = side === 'dep' ? this.sunMetricDep : this.sunMetricRec;
          const svgId  = side === 'dep' ? '#sunburstDep'    : '#sunburstRec';
          const svg = d3.select(svgId);
          svg.selectAll('*').remove();
          if (!rootData) return;

          const width  = 350;
          const height = 350;
          const radius = Math.min(width, height) / 2;

          // hiérarchie avec valeur
          const root = d3.hierarchy(rootData)
            .sum(d => d.metrics ? (d.metrics[metric] || 0) : 0)
            .sort((a,b) => (b.value || 0) - (a.value || 0));

          // ✅ Calcul maison des angles pour que chaque niveau fasse 100 % du disque
          function assignAngles(node, startAngle, endAngle) {
            node.x0 = startAngle;
            node.x1 = endAngle;

            const children = node.children || [];
            if (!children.length) return;

            const totalVal = d3.sum(children, c => c.value || 0) || children.length;
            let current = startAngle;

            children.forEach(ch => {
              const shareVal = (ch.value || 0);
              const share = totalVal ? (shareVal / totalVal) : (1 / children.length);
              const a0 = current;
              const a1 = current + (endAngle - startAngle) * share;
              assignAngles(ch, a0, a1);
              current = a1;
            });
          }

          assignAngles(root, 0, 2 * Math.PI);

          // ✅ Couronnes égales : chaque profondeur a la même épaisseur
          const maxDepth = root.height + 1;
          function assignRadii(node) {
            node.y0 = (node.depth    / maxDepth) * radius;
            node.y1 = ((node.depth+1)/ maxDepth) * radius;
            if (node.children) node.children.forEach(assignRadii);
          }
          assignRadii(root);

          if (!root.children || root.children.length === 0) {
            root.children = [{
              data: { name: 'Aucune donnée', label: 'N/A', metrics: { [metric]: 1 } },
              depth: 1,
              children: []
            }];
          }

          // Couleur de base par parent
          function baseColorFor(name) {
            let hash = 0;
            for (let i=0; i<name.length; i++) {
              hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            const h = Math.abs(hash) % 360;
            return d3.hsl(h, 0.55, 0.50);
          }

          function colorForNode(d) {
            if (!d.parent) {
              return baseColorFor(d.data.name || 'root');
            }
            const siblings = d.parent.children || [];
            const idx = siblings.indexOf(d);
            const base = baseColorFor(d.parent.data.name || 'parent');
            const t = siblings.length <= 1 ? 0.5 : idx / (siblings.length - 1);
            const l = 0.40 + t * 0.25; // 40% → 65% de luminosité
            return d3.hsl(base.h, base.s, l);
          }

          const g = svg
            .attr('viewBox', [0, 0, width, height])
            .append('g')
            .attr('transform', `translate(${width / 2},${height / 2})`);
          // Couleur de base par nom (stable)
          function baseColorFor(name) {
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
              hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            const h = Math.abs(hash) % 360;        // teinte stable 0–359
            return d3.hsl(h, 0.55, 0.50);          // saturation 55 %, luminosité 50 %
          }

          // Dégradé pour les frères d'un même parent
          function colorForNode(d) {
            if (!d.parent) {
              return baseColorFor(d.data.name || 'root');
            }
            const siblings = d.parent.children || [];
            const idx = siblings.indexOf(d);
            const base = baseColorFor(d.parent.data.name || 'parent');

            // position dans la fratrie → 0 à 1
            const t = siblings.length <= 1 ? 0.5 : idx / (siblings.length - 1);

            // luminosité 40 % → 65 %
            const l = 0.40 + t * 0.25;
            return d3.hsl(base.h, base.s, l);
          }

          const arc = d3.arc()
            .startAngle(d => d.x0)
            .endAngle(d => d.x1)
            .innerRadius(d => d.y0)
            .outerRadius(d => d.y1 - 1);

          const self = this;
          g.selectAll('path')
            .data(root.descendants())
            .join('path')
            .attr('fill', d => colorForNode(d))
            .attr('d', arc)
            .attr('class', 'node')
            .on('click', (event, d) => {
              if (side === 'dep') self.focusNodeDep(d.data);
              else self.focusNodeRec(d.data);
            })
            .append('title')
            .text(d => {
              const m = d.data.metrics || {};
              const val = m[metric] || 0;
              const label = self.sunMetricOptions.find(o => o.key === metric)?.label || '';
              return `${d.data.name}\n${label} : ${val.toLocaleString('fr-FR')} €`;
            });
        },

        focusNodeDep(node) {
          if (!node || !node.name) return;

          if (this.focusDepCode === node.name) {
            this.focusDepCode = null;
            this.focusDepLabel = 'Global (filtres)';
          } else {
            this.focusDepCode = node.name;
            this.focusDepLabel = `${node.name} – ${node.label || ''}`;
          }

          this.computeTotalsDep();
          this.renderWaterfallDep();
        },

        focusNodeRec(node) {
          if (!node || !node.name) return;

          if (this.focusRecCode === node.name) {
            this.focusRecCode = null;
            this.focusRecLabel = 'Global (filtres)';
          } else {
            this.focusRecCode = node.name;
            this.focusRecLabel = `${node.name} – ${node.label || ''}`;
          }

          this.computeTotalsRec();
          this.renderWaterfallRec();
        },

        /* ---------- Waterfall générique ---------- */
        /**
         * totals      : { budgetExec, engage, enCours, realise, dispo }
         * svgSelector : '#waterfallDep' ou '#waterfallRec'
         * colorMain   : couleur principale des barres "totales"
         * lineColor   : couleur de la ligne "Budget exécutoire"
         *
         * Affiche :
         *  - une ligne horizontale "Budget exécutoire"
         *  - une ligne horizontale "Profil théorique à date"
         *    = budgetExec × avancementCalendaire
         *      (avancementCalendaire est calculé dans le TDB à partir
         *       de la date du dernier mouvement YCMCPT)
         */
        renderWaterfallGeneric(totals, svgSelector, colorMain, lineColor) {
          const svg = d3.select(svgSelector);
          svg.selectAll('*').remove();
          if (!totals) return;

          const t = totals;

          // 1) Budget exécutoire (référence fixe)
          const budgetExec = t.budgetExec || 0;

          // 2) Profil théorique à date (référence dynamique)
          //    basé sur avancementCalendaire (0–1) calculé à partir de la date du dernier mouvement.
          let budgetTheo = null;
          if (typeof avancementCalendaire === 'number' && avancementCalendaire > 0 && avancementCalendaire <= 1) {
            budgetTheo = budgetExec * avancementCalendaire;
          }

          const stepsDef = [
            { label: 'Budget exécutoire', key: 'budgetExec', value: t.budgetExec, type: 'total' },
            { label: 'Engagé',            key: 'engage',     value: -t.engage,    type: 'delta' },
            { label: 'En cours',          key: 'enCours',    value: -t.enCours,   type: 'delta' },
            { label: 'Réalisé comptable', key: 'realise',    value: -t.realise,   type: 'delta' },
            { label: 'Disponible',        key: 'dispo',      value:  t.dispo,     type: 'total' }
          ];

          // Construction des segments (y0, y1) pour chaque barre waterfall
          let cum = 0;
          const steps = stepsDef.map((s, idx) => {
            let y0, y1;
            if (idx === 0) {
              y0 = 0;
              y1 = s.value;
              cum = y1;
            } else if (idx === stepsDef.length - 1) {
              y0 = 0;
              y1 = s.value;
              cum = y1;
            } else {
              y0 = cum;
              y1 = cum + s.value;
              cum = y1;
            }
            return { ...s, y0, y1 };
          });

          const margin = { top: 20, right: 40, bottom: 40, left: 70 };
          const width  = 650 - margin.left - margin.right;
          const height = 350 - margin.top  - margin.bottom;

          const g = svg.append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);

          const x = d3.scaleBand()
            .domain(steps.map(d => d.label))
            .range([0, width])
            .padding(0.3);

          const yMin = d3.min(steps, d => Math.min(d.y0, d.y1, 0));

          // On inclut dans le domaine Y le budget exécutoire et le théorique (si disponible)
          let yMax = d3.max(steps, d => Math.max(d.y0, d.y1, budgetExec));
          if (budgetTheo !== null) {
            yMax = Math.max(yMax, budgetTheo);
          }

          const y = d3.scaleLinear()
            .domain([yMin, yMax]).nice()
            .range([height, 0]);

          const xAxis = d3.axisBottom(x);
          const yAxis = d3.axisLeft(y).tickFormat(d => d.toLocaleString('fr-FR'));

          g.append('g')
            .attr('transform', `translate(0,${height})`)
            .call(xAxis)
            .selectAll('text')
            .style('fill', '#9ca3af')
            .style('font-size', '10px')
            .attr('text-anchor', 'middle');

          g.append('g')
            .call(yAxis)
            .selectAll('text')
            .style('fill', '#9ca3af')
            .style('font-size', '10px');

          // ---------- LIGNES DE RÉFÉRENCE ----------

          // Couleur pour la ligne théorique (commune dépenses/recettes)
          const theoLineColor = '#0ea5e9';

          // 1) Ligne : Budget exécutoire
          if (budgetExec > 0) {
            g.append('line')
              .attr('x1', 0)
              .attr('x2', width)
              .attr('y1', y(budgetExec))
              .attr('y2', y(budgetExec))
              .attr('stroke', lineColor)
              .attr('stroke-width', 1.5)
              .attr('stroke-dasharray', '6 4');

            g.append('text')
              .attr('x', width)
              .attr('y', y(budgetExec) - 6)
              .attr('text-anchor', 'end')
              .style('fill', lineColor)
              .style('font-size', '11px')
              .text('Budget exécutoire');
          }

          // 2) Ligne : Profil théorique à date (si avancementCalendaire disponible)
          if (budgetTheo !== null && budgetTheo > 0) {
            g.append('line')
              .attr('x1', 0)
              .attr('x2', width)
              .attr('y1', y(budgetTheo))
              .attr('y2', y(budgetTheo))
              .attr('stroke', theoLineColor)
              .attr('stroke-width', 1.5)
              .attr('stroke-dasharray', '2 3');

            g.append('text')
              .attr('x', width)
              .attr('y', y(budgetTheo) - 6 - 14) // on décale un peu pour éviter le chevauchement
              .attr('text-anchor', 'end')
              .style('fill', theoLineColor)
              .style('font-size', '11px')
              .text('Profil théorique à date');
          }

          // ---------- BARRES WATERFALL ----------

          g.selectAll('.bar')
            .data(steps)
            .join('rect')
            .attr('class', 'bar')
            .attr('x', d => x(d.label))
            .attr('width', x.bandwidth())
            .attr('y', d => y(Math.max(d.y0, d.y1)))
            .attr('height', d => Math.abs(y(d.y0) - y(d.y1)))
            .attr('fill', d => {
              if (d.type === 'total') return colorMain;         // Budget exécutoire & Disponible
              return d.value >= 0 ? '#22c55e' : '#f97373';      // Positif / négatif pour les deltas
            });

          // Valeurs au-dessus des barres
          g.selectAll('.label')
            .data(steps)
            .join('text')
            .attr('class', 'label')
            .attr('x', d => x(d.label) + x.bandwidth() / 2)
            .attr('y', d => y(Math.max(d.y0, d.y1)) - 4)
            .attr('text-anchor', 'middle')
            .style('fill', '#e5e7eb')
            .style('font-size', '10px')
            .text(d => d.value.toLocaleString('fr-FR') + ' €');
        }
      }
    }

// ---------------------------------------------------------
// Initialisation de l'explorateur budgétaire (onglet Bootstrap)
// ---------------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
  // On limite tout à l'onglet "Explorateur budgétaire"
  const exploRoot = document.getElementById('tab-explo');
  if (!exploRoot || typeof budgetApp !== 'function') return;

  // Instance unique de l'explorateur
  const app = budgetApp();
  // Optionnel : on expose pour debug dans la console
  window.tdbBudgetExplorateur = app;

  // --- Synchroniser les libellés de focus (x-text) sans Alpine ---
  const spanFocusDep = exploRoot.querySelector('[x-text="focusDepLabel"]');
  const spanFocusRec = exploRoot.querySelector('[x-text="focusRecLabel"]');

  if (spanFocusDep) {
    const initial = app.focusDepLabel;
    delete app.focusDepLabel;
    Object.defineProperty(app, 'focusDepLabel', {
      get() { return this._focusDepLabel; },
      set(v) {
        this._focusDepLabel = v;
        spanFocusDep.textContent = v || '';
      }
    });
    app.focusDepLabel = initial;
  }

  if (spanFocusRec) {
    const initial = app.focusRecLabel;
    delete app.focusRecLabel;
    Object.defineProperty(app, 'focusRecLabel', {
      get() { return this._focusRecLabel; },
      set(v) {
        this._focusRecLabel = v;
        spanFocusRec.textContent = v || '';
      }
    });
    app.focusRecLabel = initial;
  }

  // --- Bouton "Vider le cache local" ---
  const btnClear = exploRoot.querySelector('button.btn-outline-danger');
  if (btnClear) {
    btnClear.addEventListener('click', () => app.clearStorage());
  }

  // --- Inputs fichiers Dépenses / Recettes (.xlsx) ---
  // Dans l'onglet explorateur, il y a 2 inputs .xlsx : OBCHCGB puis OBCHPOB
  const fileInputs = exploRoot.querySelectorAll('input[type="file"][accept=".xlsx"]');
  if (fileInputs[0]) {
    fileInputs[0].addEventListener('change', ev => app.handleFileDep(ev));
  }
  if (fileInputs[1]) {
    fileInputs[1].addEventListener('change', ev => app.handleFileRec(ev));
  }

  // --- Boutons "Réinit. dépenses / recettes" ---
  exploRoot.querySelectorAll('button.btn-outline-light').forEach(btn => {
    const txt = (btn.textContent || '').toLowerCase();
    if (txt.includes('dépenses')) {
      btn.addEventListener('click', () => app.resetDepFilters());
    } else if (txt.includes('recettes')) {
      btn.addEventListener('click', () => app.resetRecFilters());
    }
  });

  // --- Lancer le rendu initial (localStorage + jeu de démo) ---
  app.init();
});

// --- Timeline ---
function updateBudgetTimeline() {
  const wrapper   = document.querySelector(".budget-timeline-wrapper");
  const steps     = [...document.querySelectorAll(".htimeline .step")];
  const todayMark = document.getElementById("today-marker");
  if (!wrapper || !steps.length || !todayMark) return;

  // si le wrapper est caché (onglet non visible), on ne calcule pas
  if (wrapper.offsetParent === null) return;

  const now          = new Date();
  const currentYear  = now.getFullYear();
  const currentMonth = now.getMonth() + 1;

  // Cycle perpétuel de SEPT (N-1) à AOUT (N+1) pour couvrir BDG + COFI + rapport
  const startYear = (currentMonth >= 9) ? currentYear : currentYear - 1;

  // Conversion MM-JJ -> date française courte
  const frenchMonths = [
    "", "janvier", "février", "mars", "avril", "mai", "juin",
    "juillet", "août", "septembre", "octobre", "novembre", "décembre"
  ];

  document.querySelectorAll(".htimeline .step").forEach(step => {
    const [m, d] = step.dataset.date.split("-").map(Number);
    step.setAttribute("data-date-fr", `${d} ${frenchMonths[m]}`);
  });
  // 1) construire les points de la frise
  const points = steps.map(step => {
    const [m, d] = step.dataset.date.split("-").map(Number);  // MM-JJ
    const year   = (m >= 9) ? startYear : startYear + 1;      // sept→déc = N-1, janv→août = N
    const date   = new Date(year, m - 1, d);
    return { el: step, date };
  }).sort((a, b) => a.date - b.date);

  // 2) grisage des étapes passées
  points.forEach(p => {
    p.el.classList.toggle("past", p.date < now);
  });

  // 3) trouver le segment [prev, next] dans lequel on se trouve
  let prev = points[0];
  let next = points[points.length - 1];

  if (now <= points[0].date) {
    prev = next = points[0];
  } else if (now >= points[points.length - 1].date) {
    prev = next = points[points.length - 1];
  } else {
    for (let i = 0; i < points.length - 1; i++) {
      if (points[i].date <= now && now <= points[i + 1].date) {
        prev = points[i];
        next = points[i + 1];
        break;
      }
    }
  }

  // 4) position horizontale du marqueur entre prev et next
  const wrapperRect = wrapper.getBoundingClientRect();
  const prevRect    = prev.el.getBoundingClientRect();
  const nextRect    = next.el.getBoundingClientRect();

  const prevX = prevRect.left - wrapperRect.left;
  const nextX = nextRect.left - wrapperRect.left;

  let ratio = (now - prev.date) / (next.date - prev.date || 1); // 0..1
  ratio = Math.max(0, Math.min(1, ratio));

  const markerX = prevX + ratio * (nextX - prevX);
  todayMark.style.left = markerX + "px";

  // Position verticale : on pose le chevron sur la ligne de la timeline
  const lineY = prevRect.top - wrapperRect.top;   // hauteur de la ligne
  todayMark.style.top = (lineY - 3) + "px";       // -6 = ajustement au pixel
}

// Recalculer la timeline quand l'onglet Calendrier devient visible (Bootstrap)
document.addEventListener('shown.bs.tab', function (event) {
  const target = event.target; // le bouton/tab activé

  // Vérifier si c’est bien ton onglet calendrier
  if (target.getAttribute('data-bs-target') === '#tab-calendar') {
    setTimeout(updateBudgetTimeline, 50); 
  }
});

// =============== Script Demande envoi mail
const _m1 = "refuge-trilogie";
const _m2 = "02";
const _m3 = "icloud";
const _m4 = "com";
const ISSUE_MAIL_TO = `${_m1}.${_m2}@${_m3}.${_m4}`;

const issueTypeEl        = document.getElementById("issueType");
const issueTitleEl       = document.getElementById("issueTitle");
const issueDescriptionEl = document.getElementById("issueDescription");
const sendIssueMailBtn   = document.getElementById("sendIssueMailBtn");

// Si tu veux préremplir quand le type change
issueTypeEl.addEventListener("change", () => {
    issueTitleEl.value = `[${APP_VERSION}] ${labelToDefaultTitle(issueTypeEl.value)}`;
    issueDescriptionEl.value = defaultBody(issueTypeEl.value);
});

sendIssueMailBtn.addEventListener("click", () => {
    const type  = issueTypeEl.value;
    const title = issueTitleEl.value || `[${APP_VERSION}] ${labelToDefaultTitle(type)}`;
    const body  = issueDescriptionEl.value || defaultBody(type);

    const typeLabelFr = labelToFrench(type);

    const subject = `[TDB ${APP_VERSION}] ${typeLabelFr} - ${title}`;

    const mailBodyLines = [
        `Type : ${type} (${typeLabelFr})`,
        `Version du TDB : ${APP_VERSION}`,
        "",
        "Description :",
        body,
        "",
        "— Message généré automatiquement depuis le tableau de bord —"
    ];

    const mailtoUrl = `mailto:${encodeURIComponent(ISSUE_MAIL_TO)}`
        + `?subject=${encodeURIComponent(subject)}`
        + `&body=${encodeURIComponent(mailBodyLines.join("\n"))}`;

    // Ouvre le client mail (Outlook, etc.)
    window.location.href = mailtoUrl;

    // Optionnel : fermer le modal
    const modalEl = document.getElementById('issueModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();
});

// Titre par défaut en fonction du type
function labelToDefaultTitle(type) {
    return {
        "bug": "Bug rencontré",
        "documentation": "Amélioration documentation",
        "enhancement": "Demande d'évolution",
        "help wanted": "Besoin d'aide",
        "invalid": "Issue à vérifier",
        "question": "Question sur le TDB"
    }[type] || "Issue";
}

// Libellé FR pour le sujet du mail
function labelToFrench(type) {
    return {
        "bug": "Bug",
        "documentation": "Documentation",
        "enhancement": "Évolution",
        "help wanted": "Aide souhaitée",
        "invalid": "Non valide",
        "question": "Question"
    }[type] || type;
}

// Corps par défaut (si description vide)
function defaultBody(type) {
    return [
        "**Description du besoin ou problème :**",
        "- ...",
        "",
        "**Étapes pour reproduire (si bug) :**",
        "- 1) ...",
        "- 2) ...",
        "",
        "**Résultat attendu :**",
        "- ...",
        "",
        `**Type d'issue :** ${type}`
    ].join("\n");
}

// SIMULATION PROJET
document.addEventListener("DOMContentLoaded", function () {
  // --- Constantes de stockage ---
  const STORAGE_KEY = "simulationProjetsEPLE";
  const HORIZON_KEY = "simulationProjetsEPLE_HORIZON";

  // --- Données et références DOM ---
  const projects = [];
  let baseYear = new Date().getFullYear(); // année de base pour la simulation
  let simulationHorizon = 5;               // horizon en années (mis à jour via le formulaire)
  const fdrStart = 0;                      // FdR initial lié aux projets (peut être rendu paramétrable)

  const projectForm        = document.getElementById("project-form");
  const projectsTableBody  = document.querySelector("#projects-table tbody");
  const impactTableBody    = document.querySelector("#impact-table tbody");
  const impactCanvas       = document.getElementById("impact-chart");
  const horizonInput       = document.getElementById("proj-horizon");
  const submitBtn          = projectForm ? projectForm.querySelector('button[type="submit"]') : null;
  const formCollapseEl     = document.getElementById("formProjet");

  let impactChart = null;
  let currentEditId = null; // null = mode ajout, sinon = id du projet en édition

  if (!projectForm || !projectsTableBody || !impactTableBody || !impactCanvas) {
    console.warn("Simulation projets : certains éléments HTML sont introuvables.");
    return;
  }

  // --- Chargement initial depuis localStorage ---
  loadProjectsFromStorage();
  renderProjects();
  recomputeImpact();
  updateFormMode(); // initialise le texte du bouton

  // --- Soumission du formulaire : ajout OU édition d'un projet ---
  projectForm.addEventListener("submit", function (e) {
    e.preventDefault();

    const name         = document.getElementById("proj-name").value || "Projet sans nom";
    const startYear    = parseInt(document.getElementById("proj-start-year").value, 10) || baseYear;
    const recettesAnn  = parseFloat(document.getElementById("proj-recettes").value) || 0;
    const depFonctAnn  = parseFloat(document.getElementById("proj-dep-fonct").value) || 0;
    const opcMontant   = parseFloat(document.getElementById("proj-opc").value) || 0;
    const opcYear      = parseInt(document.getElementById("proj-opc-year").value, 10) || startYear;
    const amortDuree   = parseInt(document.getElementById("proj-amort-duree").value, 10) || 0;
    const amortStart   = parseInt(document.getElementById("proj-amort-start").value, 10) || opcYear;
    const horizonVal   = parseInt(horizonInput.value, 10) || 5;

    simulationHorizon = horizonVal; // horizon global de simulation

    if (currentEditId !== null) {
      // --- MODE ÉDITION : on met à jour le projet existant ---
      const idx = projects.findIndex(p => p.id === currentEditId);
      if (idx !== -1) {
        projects[idx].name        = name;
        projects[idx].startYear   = startYear;
        projects[idx].recettesAnn = recettesAnn;
        projects[idx].depFonctAnn = depFonctAnn;
        projects[idx].opcMontant  = opcMontant;
        projects[idx].opcYear     = opcYear;
        projects[idx].amortDuree  = amortDuree;
        projects[idx].amortStart  = amortStart;
      }
    } else {
      // --- MODE AJOUT : on crée un nouveau projet ---
      const p = {
        id: Date.now(),
        name,
        startYear,
        recettesAnn,
        depFonctAnn,
        opcMontant,
        opcYear,
        amortDuree,
        amortStart
      };
      projects.push(p);
    }

    // Met à jour l'année de base de la simulation
    baseYear = calcBaseYear(projects);

    projectForm.reset();
    horizonInput.value = simulationHorizon; // on conserve la valeur
    currentEditId = null;                    // retour en mode ajout
    updateFormMode();

    saveProjectsToStorage();
    renderProjects();
    recomputeImpact();

    // Si le formulaire est dans un collapse Bootstrap, on peut le refermer en fin d'édition/ajout
    if (typeof bootstrap !== "undefined" && formCollapseEl) {
      const collapse = bootstrap.Collapse.getOrCreateInstance(formCollapseEl);
      collapse.hide();
    }
  });

  // --- Mise à jour du libellé du bouton selon le mode (ajout / édition) ---
  function updateFormMode() {
    if (!submitBtn) return;
    if (currentEditId === null) {
      submitBtn.textContent = "Ajouter";
      submitBtn.classList.remove("btn-warning");
      submitBtn.classList.add("btn-success");
    } else {
      submitBtn.textContent = "Mettre à jour";
      submitBtn.classList.remove("btn-success");
      submitBtn.classList.add("btn-warning");
    }
  }

  // --- Affichage de la liste des projets ---
  function renderProjects() {
    projectsTableBody.innerHTML = "";

    projects.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(p.name)}</td>
        <td>${p.startYear}</td>
        <td>${p.recettesAnn.toLocaleString("fr-FR")} €</td>
        <td>${p.depFonctAnn.toLocaleString("fr-FR")} €</td>
        <td>${p.opcMontant.toLocaleString("fr-FR")} €</td>
        <td>${p.opcYear}</td>
        <td>${p.amortDuree} ans</td>
        <td>${p.amortStart}</td>
        <td class="text-end">
          <button type="button" class="btn btn-sm btn-outline-secondary btn-edit me-1" data-id="${p.id}">
            Éditer
          </button>
          <button type="button" class="btn btn-sm btn-outline-danger btn-remove" data-id="${p.id}">
            Supprimer
          </button>
        </td>
      `;
      projectsTableBody.appendChild(tr);
    });

    // Gestion des suppressions
    projectsTableBody.querySelectorAll(".btn-remove").forEach(btn => {
      btn.addEventListener("click", function () {
        const id = parseInt(this.dataset.id, 10);
        const idx = projects.findIndex(p => p.id === id);
        if (idx !== -1) {
          projects.splice(idx, 1);

          // Si on supprimait le projet en cours d'édition → sortir du mode édition
          if (currentEditId === id) {
            currentEditId = null;
            projectForm.reset();
            if (horizonInput) horizonInput.value = simulationHorizon;
            updateFormMode();
          }

          // Si plus aucun projet → on nettoie le localStorage
          if (projects.length === 0) {
            localStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem(HORIZON_KEY);
            baseYear = new Date().getFullYear();
          } else {
            baseYear = calcBaseYear(projects);
            saveProjectsToStorage();
          }

          renderProjects();
          recomputeImpact();
        }
      });
    });

    // Gestion de l'édition
    projectsTableBody.querySelectorAll(".btn-edit").forEach(btn => {
      btn.addEventListener("click", function () {
        const id = parseInt(this.dataset.id, 10);
        const p = projects.find(pr => pr.id === id);
        if (!p) return;

        currentEditId = id;
        updateFormMode();

        // On remplit le formulaire avec les valeurs du projet
        document.getElementById("proj-name").value        = p.name;
        document.getElementById("proj-start-year").value  = p.startYear;
        document.getElementById("proj-recettes").value    = p.recettesAnn;
        document.getElementById("proj-dep-fonct").value   = p.depFonctAnn;
        document.getElementById("proj-opc").value         = p.opcMontant;
        document.getElementById("proj-opc-year").value    = p.opcYear;
        document.getElementById("proj-amort-duree").value = p.amortDuree;
        document.getElementById("proj-amort-start").value = p.amortStart;
        if (horizonInput) {
          horizonInput.value = simulationHorizon;
        }

        // On ouvre le collapse du formulaire si Bootstrap est dispo
        if (typeof bootstrap !== "undefined" && formCollapseEl) {
          const collapse = bootstrap.Collapse.getOrCreateInstance(formCollapseEl);
          collapse.show();
        }

        // Scroll éventuel jusqu’au formulaire
        projectForm.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    });
  }

  // --- Recalcul de l'impact budgétaire ---
  function recomputeImpact() {
    // Si aucun projet, on vide tout
    if (projects.length === 0) {
      impactTableBody.innerHTML = "";
      if (impactChart) {
        impactChart.destroy();
        impactChart = null;
      }
      return;
    }

    const horizon = simulationHorizon;
    const years   = [];
    const recettes = [];
    const depFonct = [];
    const amort   = [];
    const opc     = [];

    // Construction des séries annuelles agrégées (tous projets)
    for (let i = 0; i <= horizon; i++) {
      const year = baseYear + i;
      years.push(year);

      let r = 0, f = 0, a = 0, o = 0;

      projects.forEach(p => {
        // Recettes / dépenses de fonctionnement à partir de l'année de début
        if (year >= p.startYear) {
          r += p.recettesAnn;
          f += p.depFonctAnn;
        }

        // Dépense d'investissement OPC à l'année de l'investissement
        if (p.opcMontant !== 0 && year === p.opcYear) {
          o += p.opcMontant;
        }

        // Amortissements (linéaires)
        if (p.opcMontant !== 0 && p.amortDuree > 0) {
          const amortEnd = p.amortStart + p.amortDuree - 1;
          if (year >= p.amortStart && year <= amortEnd) {
            a += p.opcMontant / p.amortDuree;
          }
        }
      });

      recettes.push(r);
      depFonct.push(f);
      amort.push(a);
      opc.push(o);
    }

    // CAF et FdR projet cumulé
    const caf = [];
    const fdr = [];
    for (let i = 0; i < years.length; i++) {
      const resFonct = recettes[i] - depFonct[i] - amort[i];

      // ✔ CAF = Résultat + Amortissements
      const cafAnnee = resFonct + amort[i];
      caf.push(cafAnnee);

      // ✔ FdR cumulé = FdR(n-1) + CAF - investissement (OPC)
      const prevFdr  = i === 0 ? fdrStart : fdr[i - 1];
      const fdrAnnee = prevFdr + cafAnnee - opc[i];
      fdr.push(fdrAnnee);
    }

    // Remplissage du tableau HTML
    impactTableBody.innerHTML = "";
    for (let i = 0; i < years.length; i++) {
      const resFonct = recettes[i] - depFonct[i] - amort[i];

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${years[i]}</td>
        <td>${recettes[i].toLocaleString("fr-FR")} €</td>
        <td>${depFonct[i].toLocaleString("fr-FR")} €</td>
        <td>${amort[i].toLocaleString("fr-FR")} €</td>
        <td>${resFonct.toLocaleString("fr-FR")} €</td>
        <td>${opc[i].toLocaleString("fr-FR")} €</td>
        <td>${caf[i].toLocaleString("fr-FR")} €</td>
        <td>${fdr[i].toLocaleString("fr-FR")} €</td>
      `;
      impactTableBody.appendChild(tr);
    }

    // --- Graphique : chaque projet + courbe cumulée (verte/rouge) ---
    if (typeof Chart !== "undefined") {

      if (impactChart) {
        impactChart.destroy();
      }

      const datasets = [];

      // 1️⃣ Courbes individuelles par projet
      projects.forEach((p) => {
        const resultProject = [];

        for (let i = 0; i < years.length; i++) {
          const year = years[i];

          let r = 0, f = 0, a = 0;
          if (year >= p.startYear) {
            r = p.recettesAnn;
            f = p.depFonctAnn;
          }

          if (p.opcMontant !== 0 && p.amortDuree > 0) {
            const amortEnd = p.amortStart + p.amortDuree - 1;
            if (year >= p.amortStart && year <= amortEnd) {
              a = p.opcMontant / p.amortDuree;
            }
          }

          resultProject.push(r - f - a);
        }

        datasets.push({
          label: p.name,
          data: resultProject,
          borderWidth: 2,
          fill: false,
          tension: 0.25,
          pointRadius: 3
        });
      });

      // 2️⃣ Courbe cumulée
      const resultCumul = recettes.map((_, i) => recettes[i] - depFonct[i] - amort[i]);
      const resultColors = resultCumul.map(v => v >= 0 ? "green" : "red");

      datasets.push({
        label: "Cumul projets",
        data: resultCumul,
        borderColor: resultColors,
        backgroundColor: "transparent",
        borderWidth: 3,
        pointRadius: 5,
        pointBackgroundColor: resultColors,
        pointBorderColor: "#ffffff",
        pointBorderWidth: 2,
        tension: 0.25,
        segment: {
          borderColor: ctx => {
            const i = ctx.p0DataIndex;
            return resultCumul[i] >= 0 ? "green" : "red";
          }
        }
      });

      // Construction du graphique
      impactChart = new Chart(impactCanvas, {
        type: "line",
        data: {
          labels: years,
          datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: "index",
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: "bottom"
            },
            tooltip: {
              callbacks: {
                label: function (ctx) {
                  const value = ctx.parsed.y || 0;
                  return ctx.dataset.label + ": " +
                    value.toLocaleString("fr-FR") + " €";
                }
              }
            }
          },
          scales: {
            y: {
              title: {
                display: true,
                text: "Résultat de fonctionnement (€)"
              },
              ticks: {
                callback: function (val) {
                  return val.toLocaleString("fr-FR") + " €";
                }
              }
            }
          }
        }
      });
    }
  }

  // --- LocalStorage : sauvegarde des projets ---
  function saveProjectsToStorage() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));
      localStorage.setItem(HORIZON_KEY, String(simulationHorizon));
    } catch (e) {
      console.warn("Impossible de sauvegarder les projets dans localStorage :", e);
    }
  }

  // --- LocalStorage : chargement des projets ---
  function loadProjectsFromStorage() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      const storedHorizon = localStorage.getItem(HORIZON_KEY);

      if (stored) {
        const parsed = JSON.parse(stored);
        if (Array.isArray(parsed)) {
          parsed.forEach(p => {
            projects.push({
              id: p.id || Date.now(),
              name: p.name || "Projet sans nom",
              startYear: parseInt(p.startYear, 10) || baseYear,
              recettesAnn: parseFloat(p.recettesAnn) || 0,
              depFonctAnn: parseFloat(p.depFonctAnn) || 0,
              opcMontant: parseFloat(p.opcMontant) || 0,
              opcYear: parseInt(p.opcYear, 10) || baseYear,
              amortDuree: parseInt(p.amortDuree, 10) || 0,
              amortStart: parseInt(p.amortStart, 10) || baseYear
            });
          });

          baseYear = calcBaseYear(projects);
        }
      }

      if (storedHorizon) {
        const h = parseInt(storedHorizon, 10);
        if (!isNaN(h) && h > 0) {
          simulationHorizon = h;
        }
      }

      if (horizonInput) {
        horizonInput.value = simulationHorizon;
      }
    } catch (e) {
      console.warn("Impossible de charger les projets depuis localStorage :", e);
    }
  }

  // --- Calcul de l'année de base à partir des projets ---
  function calcBaseYear(list) {
    if (!list.length) return new Date().getFullYear();
    let year = new Date().getFullYear();
    list.forEach(p => {
      year = Math.min(
        year,
        p.startYear || year,
        p.opcYear || year,
        p.amortStart || year
      );
    });
    return year;
  }

  // --- petite fonction utilitaire pour éviter l'injection HTML dans les noms de projets ---
  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
});



        document.addEventListener('DOMContentLoaded', function() {
            displayConfigMessage();
            initializeCgrOptions();
            setupTabs();
            checkAndDisplayConfigPopup();
            setupRadioButtons();
        });

        let selectedCGR = '';
        let cgrValues = [];
        let processedData = [];

        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    tab.classList.add('active');
                    document.getElementById(tab.getAttribute('data-tab')).classList.add('active');
                });
            });
        }

        function setupRadioButtons() {
            const radioButtons = document.querySelectorAll('input[name="ygpie1Option"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('downloadButton').style.display = 'none';
                    document.getElementById('generateButton').disabled = false;
                });
            });
        }

        document.getElementById('uploadForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = new ExcelJS.Workbook();
                    await workbook.xlsx.load(data);

                    const worksheet = workbook.getWorksheet(1);
                    if (!worksheet) {
                        alert('La feuille de calcul n\'a pas pu être chargée.');
                        return;
                    }

                    const json = [];

                    worksheet.eachRow({ includeEmpty: true }, function(row, rowNumber) {
                        const rowData = [];
                        row.eachCell({ includeEmpty: true }, function(cell, colNumber) {
                            rowData.push(cell.value);
                        });
                        json.push(rowData);
                    });

                    // Vérifiez que le nom de la feuille est "CLCA"
                    if (worksheet.name !== "CLCA") {
                        alert('Le nom de la feuille doit être "CLCA".');
                        return;
                    }

                    // Nettoyer les données de la colonne "Nom du fournisseur / élève"
                    cleanSupplierNames(json);

                    // Extraire les valeurs uniques de la colonne "CGR A"
                    const cgrColumnIndex = json[0].indexOf("CGR A");
                    cgrValues = [...new Set(json.slice(1).map(row => row[cgrColumnIndex]))].sort();

                    // Remplir la datalist avec les valeurs uniques de "CGR A"
                    const cgrOptions = document.getElementById('cgrOptions');
                    cgrOptions.innerHTML = '';
                    cgrValues.forEach(value => {
                        const option = document.createElement('option');
                        option.value = value;
                        cgrOptions.appendChild(option);
                    });

                    // Afficher le pop-up de sélection de CGR
                    document.getElementById('cgrPopup').style.display = 'block';

                    // Stocker les données pour le traitement ultérieur
                    window.jsonData = json;
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert('Veuillez sélectionner un fichier.');
            }
        });

        document.getElementById('fileInput').addEventListener('click', function() {
            document.getElementById('downloadButtonCLCA').style.display = 'none';
            document.getElementById('generateButton').disabled = false;
        });

        document.getElementById('cgrForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            selectedCGR = document.getElementById('cgrSelect').value;
            document.getElementById('cgrPopup').style.display = 'none';

            // Désactiver le bouton "Générer le tableau"
            document.getElementById('generateButton').disabled = true;

            try {
                // Traiter le fichier pour conserver uniquement les colonnes spécifiques
                const filteredData = filterColumns(window.jsonData, selectedCGR);

                // Trier les données par ordre chronologique à partir de la colonne "Date"
                const dateColumnIndex = filteredData[0].indexOf("Date");
                filteredData.slice(1).sort((a, b) => {
                    const dateA = new Date(a[dateColumnIndex]);
                    const dateB = new Date(b[dateColumnIndex]);
                    return dateA - dateB;
                });

                // Calculer le total des montants de la colonne G
                const totalAmountG = filteredData.slice(1).reduce((total, row) => {
                    const amount = parseFloat(row[6]);
                    return isNaN(amount) ? total : total + amount;
                }, 0);

                // Ajouter une ligne vide après la dernière ligne de données
                filteredData.push(["", "", "", "", "", ""]);

                // Ajouter une nouvelle ligne pour la somme de la colonne G
                filteredData.push(["", "", "", "", "", "Total", totalAmountG]);

                // Ajouter le nom du chef d'établissement à gauche sous le tableau
                const chefEtablissement = localStorage.getItem('chefEtablissement') || '';
                filteredData.push([chefEtablissement]);

                // Ajouter le nom de l'établissement en pied de page
                const etablissement = localStorage.getItem('etablissement') || '';
                filteredData.push([etablissement]);

                // Ajouter la date du jour au format européen (DD/MM/YYYY) sous le nom de l'établissement
                const currentDate = getCurrentDateEuropeanFormat();
                filteredData.push([currentDate]);

                // 🔍 Afficher un aperçu texte du tableau CLCA dans le <pre>
                afficherApercuCLCA(filteredData);
                
                // Générer un nouveau fichier XLSX modifié
                const newWorkbook = new ExcelJS.Workbook();
                const etablissementName = localStorage.getItem('etablissement') || 'Etablissement';
                const date = getCurrentDateEuropeanFormat();
                const sheetName = `${date} - ${etablissementName}`.replace(/[*?:\\\/\[\]]/g, '').substring(0, 31);
                const newWorksheet = newWorkbook.addWorksheet(sheetName);

                // Ajouter les données au worksheet
                filteredData.forEach(row => {
                    newWorksheet.addRow(row);
                });

                // Appliquer les styles
                adaptColumnWidths(newWorksheet, filteredData);
                formatCurrencyColumn(newWorksheet, filteredData, 6); // Format the "Montant facture TTC" column
                applyBoldToHeader(newWorksheet, filteredData); // Apply bold to the header row
                applyBordersToAllCells(newWorksheet, filteredData); // Apply borders to all cells

                const dateForFileName = getCurrentDate();
                window.generatedWorkbookCLCA = newWorkbook;

                // Afficher le bouton de téléchargement
                document.getElementById('downloadButtonCLCA').style.display = 'block';

                // Réinitialiser le formulaire d'importation
                document.getElementById('uploadForm').reset();
            } catch (error) {
                console.error('Erreur lors du traitement des données:', error);
                alert('Une erreur est survenue lors du traitement des données. Veuillez réessayer.');
            }
        });

        document.getElementById('closeCgrPopup').addEventListener('click', function() {
            document.getElementById('cgrPopup').style.display = 'none';
        });

        document.getElementById('clearCgrSelect').addEventListener('click', function() {
            document.getElementById('cgrSelect').value = '';
            const cgrOptions = document.getElementById('cgrOptions');
            cgrOptions.innerHTML = '';
            cgrValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                cgrOptions.appendChild(option);
            });
        });

        document.getElementById('cgrSelect').addEventListener('click', function() {
            const cgrOptions = document.getElementById('cgrOptions');
            cgrOptions.innerHTML = '';
            cgrValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                cgrOptions.appendChild(option);
            });
        });

        document.getElementById('configButton').addEventListener('click', function() {
            document.getElementById('popup').style.display = 'block';
            loadConfig();
        });

        document.getElementById('closePopup').addEventListener('click', function() {
            document.getElementById('popup').style.display = 'none';
        });

        document.getElementById('configForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const etablissement = document.getElementById('etablissement').value;
            const chefEtablissement = document.getElementById('chefEtablissement').value;
            localStorage.setItem('etablissement', etablissement);
            localStorage.setItem('chefEtablissement', chefEtablissement);
            alert('Configuration enregistrée.');
            document.getElementById('popup').style.display = 'none';
            displayConfigMessage();
            checkAndDisplayConfigPopup();
        });

        document.getElementById('deleteConfig').addEventListener('click', function() {
            localStorage.removeItem('etablissement');
            localStorage.removeItem('chefEtablissement');
            alert('Configuration supprimée.');
            document.getElementById('popup').style.display = 'none';
            displayConfigMessage();
            checkAndDisplayConfigPopup();
        });

        document.getElementById('ygpie1UploadForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const fileInput = document.getElementById('ygpie1FileInput');
            const files = fileInput.files;
            const selectedOption = document.querySelector('input[name="ygpie1Option"]:checked').value;

            if (files.length > 0) {
                const workbooks = [];

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        const data = new Uint8Array(e.target.result);
                        const workbook = new ExcelJS.Workbook();
                        await workbook.xlsx.load(data);

                        // Vérifiez que chaque fichier a une feuille nommée "YGPIE1"
                        const worksheet = workbook.getWorksheet('YGPIE1');
                        if (!worksheet) {
                            alert(`Le fichier ${file.name} ne contient pas de feuille nommée "YGPIE1".`);
                            return;
                        }

                        workbooks.push(workbook);

                        if (workbooks.length === files.length) {
                            processYGPIE1Files(workbooks, selectedOption);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            } else {
                alert('Veuillez sélectionner un ou plusieurs fichiers.');
            }
        });

        function processYGPIE1Files(workbooks, selectedOption) {
            const allData = [];

            workbooks.forEach(workbook => {
                const worksheet = workbook.getWorksheet('YGPIE1');
                if (!worksheet) {
                    alert('La feuille de calcul n\'a pas pu être chargée.');
                    return;
                }

                const json = [];

                worksheet.eachRow({ includeEmpty: true }, function(row, rowNumber) {
                    const rowData = [];
                    row.eachCell({ includeEmpty: true }, function(cell, colNumber) {
                        rowData.push(cell.value);
                    });
                    json.push(rowData);
                });

                // Nettoyer les données de la colonne "Nom du fournisseur / élève"
                cleanSupplierNames(json);

                // Filter the columns first
                const filteredData = filterYGPIE1Columns(json);

                // Aggregate data
                if (allData.length === 0) {
                    allData.push(...filteredData);
                } else {
                    allData.push(...filteredData.slice(1));
                }
            });

            // Process the aggregated data based on the selected option
            switch (selectedOption) {
                case 'rapprocher':
                    processedData = processRapprocher(allData);
                    break;
                case 'prises_en_charge':
                    processedData = processPrisesEnCharge(allData);
                    break;
                case 'prises_en_charge_associes':
                    processedData = processPrisesEnChargeAssocies(allData);
                    break;
                case 'aide_compensation':
                    processedData = processAideCompensation(allData);
                    break;
            }

            // 🔍 Aperçu sous forme de tableur
            afficherApercuYGPIE1(processedData);

            // Generate a new filtered XLSX file
            const newWorkbook = new ExcelJS.Workbook();
            const etablissement = localStorage.getItem('etablissement') || 'Etablissement';
            const date = getCurrentDateEuropeanFormat();
            const sheetName = `${date} - ${etablissement}`.replace(/[*?:\\\/\[\]]/g, '').substring(0, 31);
            const newWorksheet = newWorkbook.addWorksheet(sheetName);

            // Ajouter les données au worksheet
            processedData.forEach(row => {
                newWorksheet.addRow(row);
            });

            // Appliquer les styles
            adaptColumnWidths(newWorksheet, processedData);
            applyBoldToHeader(newWorksheet, processedData); // Apply bold to the header row
            applyBordersToAllCells(newWorksheet, processedData); // Apply borders to all cells

            window.generatedWorkbook = newWorkbook;

            // Show the download button
            document.getElementById('downloadButton').style.display = 'block';
        }

        document.getElementById('downloadButton').addEventListener('click', function() {
            if (window.generatedWorkbook) {
                const etablissement = localStorage.getItem('etablissement') || 'Etablissement';
                const date = getCurrentDateEuropeanFormat();
                const fileName = `${etablissement} - ${date}.xlsx`;
                window.generatedWorkbook.xlsx.writeBuffer().then(function(buffer) {
                    saveAs(new Blob([buffer]), fileName);
                });
            } else {
                alert('Aucun fichier généré. Veuillez d\'abord générer le tableau.');
            }
        });

        document.getElementById('downloadButtonCLCA').addEventListener('click', function() {
            if (window.generatedWorkbookCLCA) {
                const etablissement = localStorage.getItem('etablissement') || 'Etablissement';
                const date = getCurrentDateEuropeanFormat();
                const cgrName = selectedCGR.replace(/[*?:\\\/\[\]]/g, '').substring(0, 31);
                const fileName = `${cgrName} - ${etablissement} - ${date}.xlsx`;
                window.generatedWorkbookCLCA.xlsx.writeBuffer().then(function(buffer) {
                    saveAs(new Blob([buffer]), fileName);
                });
            } else {
                alert('Aucun fichier généré. Veuillez d\'abord générer le tableau.');
            }
        });

        function loadConfig() {
            const etablissement = localStorage.getItem('etablissement') || '';
            const chefEtablissement = localStorage.getItem('chefEtablissement') || '';
            document.getElementById('etablissement').value = etablissement;
            document.getElementById('chefEtablissement').value = chefEtablissement;
        }

        function displayConfigMessage() {
            const etablissement = localStorage.getItem('etablissement');
            const chefEtablissement = localStorage.getItem('chefEtablissement');
            const configMessageDiv = document.getElementById('configMessage');

            if (etablissement && chefEtablissement) {
                configMessageDiv.innerHTML = `Établissement: ${etablissement}<br>Chef d'établissement: ${chefEtablissement}`;
            } else {
                configMessageDiv.innerHTML = 'Veuillez saisir les données de configuration.';
            }

            checkAndDisplayConfigPopup();
        }

        function checkAndDisplayConfigPopup() {
            const etablissement = localStorage.getItem('etablissement');
            const chefEtablissement = localStorage.getItem('chefEtablissement');

            if (!etablissement || !chefEtablissement) {
                document.getElementById('popup').style.display = 'block';
            }
        }

        function initializeCgrOptions() {
            const cgrOptions = document.getElementById('cgrOptions');
            cgrOptions.innerHTML = '';
        }

        function filterColumns(data, selectedCGR) {
            const columnsToKeep = ["Classe", "N° commande", "Sous-numéro", "Date", "Nom du fournisseur / élève", "CGR A", "Référence", "Montant facture TTC"];
            const headers = data[0];
            const indicesToKeep = columnsToKeep.map(col => headers.indexOf(col)).filter(index => index !== -1);

            // Conserver la première ligne (titres des colonnes)
            const filteredData = [columnsToKeep];

            // Filtrer les lignes en fonction du CGR sélectionné et exclure les lignes vides de la colonne "Montant facture TTC"
            const chunkSize = 1000; // Taille du chunk
            for (let i = 1; i < data.length; i += chunkSize) {
                const chunk = data.slice(i, i + chunkSize);
                chunk.forEach(row => {
                    if (row[indicesToKeep[5]] === selectedCGR && row[indicesToKeep[7]] !== undefined && row[indicesToKeep[7]] !== null && row[indicesToKeep[7]] !== '') {
                        const newRow = indicesToKeep.map(index => row[index]);
                        // Fusionner les colonnes "N° commande" et "Sous-numéro"
                        newRow[1] = `${row[indicesToKeep[1]]}.${row[indicesToKeep[2]]}`;
                        // Supprimer la colonne "Sous-numéro"
                        newRow.splice(2, 1);
                        filteredData.push(newRow);
                    }
                });
            }

            // Supprimer le titre de la colonne C et décaler les titres des colonnes suivantes vers la gauche
            filteredData[0].splice(2, 1);

            return filteredData;
        }

        function filterYGPIE1Columns(data) {
            const columnsToKeep = ["Tiers principal", "Compte", "Solde débit", "Solde crédit", "Libellé", "Libellé complémentaire", "Comptable", "Pièce", "Type", "Tiers associé", "Ets"];
            const headers = data[0];
            const indicesToKeep = columnsToKeep.map(col => headers.indexOf(col)).filter(index => index !== -1);

            // Conserver la première ligne (titres des colonnes)
            const filteredData = [columnsToKeep];

            // Conserver toutes les lignes en fonction des colonnes à garder
            data.slice(1).forEach(row => {
                filteredData.push(indicesToKeep.map(index => row[index]));
            });

            return filteredData;
        }

        function adaptColumnWidths(worksheet, data) {
            const columnWidths = data[0].map((_, colIndex) => {
                const column = data.map(row => row[colIndex]);
                const maxLength = Math.max(...column.map(cell => (cell ? cell.toString().length : 0)));
                return { width: Math.min(maxLength + 2, 50) }; // Limiter la largeur maximale à 50 caractères
            });

            worksheet.columns = columnWidths;
        }

        function formatCurrencyColumn(worksheet, data, columnIndex) {
            const currencyFormat = '#,##0.00 €';
            data.slice(1).forEach((row, rowIndex) => {
                const cell = worksheet.getCell(rowIndex + 2, columnIndex + 1);
                cell.numFmt = currencyFormat;
            });
        }

        function applyBoldToHeader(worksheet, data) {
            const headerRow = data[0];
            headerRow.forEach((_, colIndex) => {
                const cell = worksheet.getCell(1, colIndex + 1);
                cell.font = { bold: true };
            });
        }

        function applyBordersToAllCells(worksheet, data) {
            data.forEach((row, rowIndex) => {
                row.forEach((_, colIndex) => {
                    const cell = worksheet.getCell(rowIndex + 1, colIndex + 1);
                    cell.border = {
                        top: { style: 'thin' },
                        bottom: { style: 'thin' },
                        left: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });
            });
        }

        function afficherApercuCLCA(data) {
            const container = document.getElementById("previewCLCA");
            if (!container) return;

            // Réinitialiser le contenu
            container.innerHTML = "";

            // Créer le tableau
            const table = document.createElement("table");
            table.classList.add("table-preview");

            data.forEach((row, rowIndex) => {
                const tr = document.createElement("tr");

                row.forEach(cell => {
                    const isHeader = rowIndex === 0;

                    const cellElement = document.createElement(isHeader ? "th" : "td");
                    const value = cell === undefined || cell === null ? "" : cell;

                    // Déterminer si la valeur est numérique
                    const isNumber = !isHeader && !isNaN(parseFloat(value)) && isFinite(value);

                    if (isNumber) {
                        cellElement.classList.add("number");
                        cellElement.textContent = value;
                    } else {
                        cellElement.textContent = value;
                    }

                    tr.appendChild(cellElement);
                });

                table.appendChild(tr);
            });

            // Insérer dans le conteneur
            container.appendChild(table);
        }

        function afficherApercuYGPIE1(data) {
            const container = document.getElementById("previewYGPIE1");
            if (!container) return;

            container.innerHTML = "";

            const table = document.createElement("table");
            table.classList.add("table-preview");

            data.forEach((row, rowIndex) => {
                const tr = document.createElement("tr");

                row.forEach(cell => {
                    const isHeader = rowIndex === 0;

                    const cellElement = document.createElement(isHeader ? "th" : "td");
                    const value = cell === undefined || cell === null ? "" : cell;

                    const isNumber =
                        !isHeader &&
                        !isNaN(parseFloat(value)) &&
                        isFinite(value);

                    if (isNumber) {
                        cellElement.classList.add("number");
                        cellElement.textContent = value;
                    } else {
                        cellElement.textContent = value;
                    }

                    tr.appendChild(cellElement);
                });

                table.appendChild(tr);
            });

            container.appendChild(table);
        }

        function processRapprocher(data) {
            const headers = data[0];
            const compteIndex = headers.indexOf("Compte");
            const tiersIndex = headers.indexOf("Tiers principal");
            const debitIndex = headers.indexOf("Solde débit");
            const creditIndex = headers.indexOf("Solde crédit");
            const pieceIndex = headers.indexOf("Pièce");

            const result = [headers];
            const matchedRows = [];

            data.slice(1).forEach(row => {
                const compte = row[compteIndex];
                const tiers = row[tiersIndex];
                const debit = parseFloat(row[debitIndex]);
                const credit = parseFloat(row[creditIndex]);
                const piece = row[pieceIndex];

                // Find matching rows with equal debit and credit for the same account and tiers
                const matchingRows = data.slice(1).filter(r =>
                    r[compteIndex] === compte &&
                    r[tiersIndex] === tiers &&
                    parseFloat(r[debitIndex]) === credit &&
                    parseFloat(r[creditIndex]) === debit &&
                    r[pieceIndex] !== piece
                );

                if (matchingRows.length > 0) {
                    matchingRows.forEach(matchingRow => {
                        if (!matchedRows.includes(row) && !matchedRows.includes(matchingRow)) {
                            matchedRows.push(row, matchingRow);
                        }
                    });
                }
            });

            // Group by compte
            const groupedData = matchedRows.reduce((acc, row) => {
                const compte = row[compteIndex];
                if (!acc[compte]) {
                    acc[compte] = [];
                }
                acc[compte].push(row);
                return acc;
            }, {});

            for (const compte in groupedData) {
                const rows = groupedData[compte];
                rows.forEach(row => {
                    result.push(row);
                });
            }

            return result;
        }

        function processPrisesEnCharge(data) {
            const headers = data[0];
            const compteIndex = headers.indexOf("Compte");
            const tiersIndex = headers.indexOf("Tiers principal");
            const debitIndex = headers.indexOf("Solde débit");
            const creditIndex = headers.indexOf("Solde crédit");

            const result = [headers];
            const groupedData = {};

            // Filter rows where "Tiers principal" has either debits or credits
            const validRows = data.slice(1).filter(row => {
                const debit = parseFloat(row[debitIndex]);
                const credit = parseFloat(row[creditIndex]);
                return debit > 0 || credit > 0;
            });

            // Group by "Tiers principal"
            validRows.forEach(row => {
                const tiers = row[tiersIndex];
                if (!groupedData[tiers]) {
                    groupedData[tiers] = { debits: [], credits: [] };
                }
                const debit = parseFloat(row[debitIndex]);
                const credit = parseFloat(row[creditIndex]);
                if (debit > 0) {
                    groupedData[tiers].debits.push(row);
                }
                if (credit > 0) {
                    groupedData[tiers].credits.push(row);
                }
            });

            // Process each group
            for (const tiers in groupedData) {
                const { debits, credits } = groupedData[tiers];
                if (debits.length > 0 && credits.length > 0) {
                    debits.forEach(row => result.push(row));
                    credits.forEach(row => result.push(row));
                }
            }

            return result;
        }

        function processPrisesEnChargeAssocies(data) {
            const headers = data[0];
            const compteIndex = headers.indexOf("Compte");
            const tiersIndex = headers.indexOf("Tiers associé");
            const debitIndex = headers.indexOf("Solde débit");
            const creditIndex = headers.indexOf("Solde crédit");

            const result = [headers];
            const groupedData = {};

            // Group by "Tiers associé"
            data.slice(1).forEach(row => {
                const tiers = row[tiersIndex];
                const compte = row[compteIndex];
                const debit = parseFloat(row[debitIndex]);
                const credit = parseFloat(row[creditIndex]);

                // Ignorer les lignes sans tiers associé
                if (!tiers) return;

                // Ignorer les lignes où le compte ne commence pas par 411
                if (!compte.startsWith('411')) return;

                if (!groupedData[tiers]) {
                    groupedData[tiers] = {
                        rows: [],
                        hasDebit: false,
                        hasCredit: false
                    };
                }

                groupedData[tiers].rows.push(row);
                if (debit > 0) groupedData[tiers].hasDebit = true;
                if (credit > 0) groupedData[tiers].hasCredit = true;
            });

            // Filter groups that have both debits and credits
            for (const tiers in groupedData) {
                if (groupedData[tiers].hasDebit && groupedData[tiers].hasCredit) {
                    groupedData[tiers].rows.forEach(row => {
                        result.push(row);
                    });
                }
            }

            return result;
        }

        function processAideCompensation(data) {
            const headers = data[0];
            const columnsToKeep = ["Tiers principal", "Tiers associé", "Compte", "Solde débit", "Solde crédit", "Libellé", "Libellé complémentaire", "Comptable", "Pièce", "Type", "Libellé adresse tiers associé", "Ets"];
            const indicesToKeep = columnsToKeep.map(col => headers.indexOf(col)).filter(index => index !== -1);

            // Conserver la première ligne (titres des colonnes)
            const filteredData = [columnsToKeep];

            // Conserver toutes les lignes en fonction des colonnes à garder
            data.slice(1).forEach(row => {
                filteredData.push(indicesToKeep.map(index => row[index]));
            });

            // Exclure les comptes qui ne commencent pas par 411, 412, 419, 466 à l'exception des comptes 416000 et 511700
            const compteIndex = headers.indexOf("Compte");
            const validRows = filteredData.filter(row => {
                const compte = row[compteIndex];
                return compte && (compte.startsWith('411') || compte.startsWith('412') || compte.startsWith('419') || compte.startsWith('466') || compte === '416000' || compte === '511700');
            });

            // Grouper les lignes par "Libellé adresse tiers associé"
            const groupedData = validRows.reduce((acc, row) => {
                const libelleAdresseTiersAssocie = row[headers.indexOf("Libellé adresse tiers associé")];
                if (!acc[libelleAdresseTiersAssocie]) {
                    acc[libelleAdresseTiersAssocie] = [];
                }
                acc[libelleAdresseTiersAssocie].push(row);
                return acc;
            }, {});

            // Ajouter les lignes groupées au résultat final
            const result = [headers];
            for (const key in groupedData) {
                groupedData[key].forEach(row => {
                    result.push(row);
                });
            }

            return result;
        }

        function getCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getCurrentDateEuropeanFormat() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function cleanSupplierNames(data) {
            const supplierColumnIndex = data[0].indexOf("Nom du fournisseur / élève");
            if (supplierColumnIndex === -1) return;

            data.forEach(row => {
                let value = row[supplierColumnIndex];
                if (value == null) return;

                // 1) Si c'est un objet ExcelJS (richText, text, result, etc.)
                if (typeof value === "object") {
                    // a) Cas le plus fréquent : { text: "Nom fournisseur" }
                    if (value.text) {
                        value = value.text;
                    }
                    // b) Cas richText : { richText: [ {text: "A"}, {text: "B"} ] }
                    else if (Array.isArray(value.richText)) {
                        value = value.richText
                            .map(part => part && part.text ? part.text : "")
                            .join("");
                    }
                    // c) Cas formule : { result: "…" }
                    else if (value.result != null) {
                        value = value.result.toString();
                    }
                    // d) Fallback : on convertit en chaîne
                    else {
                        value = String(value);
                    }
                }

                // 2) Nettoyage texte comme avant
                if (typeof value === "string") {
                    value = value
                        .replace(/[="]/g, "")
                        .replace(/[\(\)]/g, "")
                        .trim();
                }

                row[supplierColumnIndex] = value;
            });
        }
</script>
</html>
